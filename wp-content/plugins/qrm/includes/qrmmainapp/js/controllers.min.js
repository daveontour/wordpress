function SortByProjectCode(e,t){if(null===e||null===t)return 0;var r,i;return"object"==typeof e?(r=e.riskProjectCode.toLowerCase(),i=t.riskProjectCode.toLowerCase()):(r=jQuery.grep(QRM.mainController.risks,function(t){return t.id==e})[0].riskProjectCode,i=jQuery.grep(QRM.mainController.risks,function(e){return e.id==t})[0].riskProjectCode),i>r?-1:r>i?1:0}function startChatChannel(e,t,r,i,n){try{if(null!=ajaxChatRequest&&1==ajaxChatRequest.readyState)return void console.log("Chat already open - do nothing")}catch(a){console.log(a.message)}30>failedConnectCount?(console.log("Initiate Chat"),ajaxChatRequest=jQuery.ajax({url:e+"?nocache="+Math.random()+"&userEmail="+t+"&siteKey="+r+"&reset="+n+"&sessionToken="+i.sessionToken,type:"GET",timeout:47e3,dataType:"jsonp",success:function(e){return failedConnectCount=0,ajaxChatRequest=null,e.msg?void QRM.mainController.notify(e.message,e.duration):e.timeout?void console.log("Chat Timeout"):void(e.reportReady&&(QRM.mainController.notify2("Report Ready. Downloading Now"),jQuery('input[name="userEmail"]').val(i.userEmail),jQuery('input[name="userLogin"]').val(i.userLogin),jQuery('input[name="siteKey"]').val(i.siteKey),jQuery('input[name="id"]').val(e.reportID),jQuery("#getReportForm").attr("action",i.reportServerURL+"/getReport",!1),jQuery("#getReportForm").submit()))},error:function(e,t,r){failedConnectCount++,console.log("Chat Fail")},complete:function(n,a){startChatChannel(e,t,r,i,!1)}})):(QRM.mainController.notifyNoReportServer(),failedConnectCount=0)}function QRMCtrl(e){this.reports=e.reports}function IntroCtrl(e,t,r,i,n,a){var o=this;QRM.introController=this,e.introloading=!0,o.sessionOK=!1,o.qrmUser=!1;var s=r.checkSession().then(function(e){"0"===e.data||"-1"===e.data?o.sessionOK=!1:(o.sessionOK=!0,o.qrmUser=e.data.loggedin)}),l=r.getSiteUsers().then(function(e){"0"===e.data||"-1"===e.data?o.sessionOK=!1:(o.sessionOK=!0,"-3"!=e.data&&(t.siteUsers=e.data))}),c=r.getCurrentUser().then(function(e){"0"==e.data||"-1"==e.data?o.sessionOK=!1:(o.sessionOK=!0,"-3"!=e.data&&(t.currentUser=e.data,QRM.mainController.userName=t.currentUser.data.display_name))}),d=r.getAllRisks().then(function(e){"0"===e.data||"-1"===e.data?o.sessionOK=!1:(o.sessionOK=!0,"-3"!=e.data&&(QRM.mainController.risks=e.data,QRM.mainController.risks=jQuery.grep(QRM.mainController.risks,function(e){return null==e.riskProjectCode?!1:null!=e}),QRM.mainController.risks.sort(SortByProjectCode),t.risks=QRM.mainController.risks))}),u=r.getServerMeta().then(function(e){t.reportServerURL=e.data.reportServerURL,t.siteKey=e.data.siteKey,t.siteName=e.data.siteName,t.siteID=e.data.siteID,t.userEmail=e.data.userEmail,t.userLogin=e.data.userLogin,t.userDisplayName=e.data.userDisplayName,t.sessionToken=e.data.sessionToken,"0"!=e.data&&"-1"!=e.data&&setTimeout(function(){startChatChannel(t.reportServerURL+"/reportMsg",t.userEmail,t.siteKey,t,!0)},5e3)});if("risk"==postType||"review"==postType){var p=r.getProjects().then(function(e){"0"==e.data||"-1"==e.data?o.sessionOK=!1:(o.sessionOK=!0,"-3"!=e.data&&t.handleGetProjects(e))});n.all([s,l,c,d,p,u]).then(function(){o.switcher()})}else n.all([s,l,c,d,u]).then(function(){o.switcher()});this.switcher=function(){return o.sessionOK?o.qrmUser?void a.jsonp(t.reportServerURL+"/availableReports?callback=JSON_CALLBACK").success(function(e){t.reports=e}).error(function(e){t.reports=[{id:-1,title:"Report Server Not Available",showRiskExplorer:!0,showSingleRisk:!0,showRank:!0,showCalender:!0,showReview:!0,showRelMatrix:!0,showSingleReview:!0,showIncident:!0,showSingleIncident:!0,showDashboard:!0}]})["finally"](function(){switch(postType){case"risk":t.selectProject(projectID),t.riskID=postID,e.introloading=!1,i.go("qrm.risk");break;case"riskproject":e.introloading=!1,i.go("qrm.explorer");break;case"review":r.getReview(postID).then(function(r){t.review=r.data,null!=t.review.risks&&t.review.risks.sort(SortByProjectCode),t.reviewID=t.review.id,t.review.actualdate=new Date(t.review.actualdate),t.review.scheddate=new Date(t.review.scheddate),e.introloading=!1,i.go("qrm.review")});break;case"incident":r.getIncident(postID).then(function(r){t.incident=r.data,null!=t.incident.risks&&t.incident.risks.sort(SortByProjectCode),t.incidentID=t.incident.id,t.incident.date=new Date(t.incident.date),e.introloading=!1,i.go("qrm.incident")});break;default:e.introloading=!1,i.go("qrm.explorer")}}):void i.go("nonQRM"):void i.go("login")}}function MainCtrl(e,t,r,i,n,a){QRM.mainController=this,this.notify=function(e,t){i.dismiss(),i.set(e,{type:"info",sticky:!0,theme:"pure"})},this.notify2=function(e){i.dismiss(),i.set(e,{type:"success",duration:1e3,theme:"pure"})},this.notify3=function(e,t){i.dismiss(),i.set(e,{type:"info",duration:t,theme:"pure"})},this.notifyNoReportServer=function(e){i.dismiss(),i.set("Unable To Connect To The Report Server",{type:"warn",sticky:!0,theme:"pure"})},this.showStatusBoard=!1,this.showSpinner=!1,this.showSelectProject=!0,this.showLookingForRisks=!1,this.showNoRisks=!1,this.loading=!1,this.sideOpen=!1,this.showLookingForReviews=!1,this.showNoReviews=!1,this.showLookingForIncidents=!1,this.showNoIncidents=!1,this.pluginurl=pluginurl,this.loaderSrc=this.pluginurl+"views/ajax-loader.gif",this.go=function(e){r.go(e)},this.lookingForRisks=function(){this.showSelectProject=!1,this.showLookingForRisks=!0,this.showNoRisks=!1,this.loading=!1},this.noRisksFound=function(){this.showSelectProject=!1,this.showLookingForRisks=!1,this.showNoRisks=!0,this.loading=!1},this.risksFound=function(){this.showSelectProject=!1,this.showLookingForRisks=!1,this.showNoRisks=!1,this.loading=!1},this.loadingProject=function(){this.showSelectProject=!1,this.showLookingForRisks=!1,this.showNoRisks=!1,this.loading=!0},this.lookingForIncidents=function(){this.showLookingForIncidents=!0,this.showNoIncidents=!1},this.incidentsFound=function(){this.showLookingForIncidents=!1,this.showNoIncidents=!1},this.noIncidentsFound=function(){this.showLookingForIncidents=!1,this.showNoIncidents=!0},this.lookingForReviews=function(){this.showLookingForReviews=!0,this.showNoReviews=!1},this.reviewsFound=function(){this.showLookingForReviews=!1,this.showNoReviews=!1},this.noReviewsFound=function(){this.showLookingForReviews=!1,this.showNoReviews=!0},this.getBtnClass=function(e){return"primary"==e&&"primary"==this["class"]?!0:"danger"==e&&"danger"==this["class"]?!0:"info"==e&&"info"==this["class"]?!0:"warning"==e&&"warning"==this["class"]?!0:void 0},this.checkUserCap=function(t,r){if("undefined"==typeof e.currentUser)return!1;var i=e.currentUser.ID,n=e.project;switch(t){case"edit_risk_grid":return r.owner==i?!0:r.manager==i?!0:e.project.projectRiskManager==i?!0:!1;case"view_risk_grid":return r.owner==i?!0:r.manager==i?!0:e.project.projectRiskManager==i?!0:n.ownersID.indexOf(i)>-1?!0:n.managersID.indexOf(i)>-1?!0:n.usersID.indexOf(i)>-1?!0:!1;case"delete_risk_grid":return r.owner==i?!0:e.project.projectRiskManager==i?!0:!1;case"new_risk":return"undefined"==typeof n?!1:n.projectRiskManager==i?!0:"undefined"==typeof n.ownersID?!1:n.ownersID.indexOf(i)>-1?!0:"undefined"==typeof n.managersID?!1:n.managersID.indexOf(i)>-1?!0:!1;case"save_risk":return e.riskID<0?!0:"undefined"==typeof e.risk?!1:e.risk.owner==i?!0:e.risk.manager==i?!0:e.project.projectRiskManager==i?!0:!1;case"new_incident":return!0;case"new_review":return!0;default:return!1}},this.logout=function(){t.logout()["finally"](function(){e.siteUsers=null,QRM.mainController.risks=null,e.currentUser=null,r.go("login")})},this.main=function(){window.open(siteURL,"_self")},this.toggleMenu=function(){var e=jQuery("#header_container").hasClass("sideMenuOpen");e?(jQuery("#header_container").removeClass("sideMenuOpen"),jQuery("#footer_container").removeClass("sideMenuOpen"),jQuery("#cbp-spmenu-s1").removeClass("cbp-spmenu-open"),jQuery("body").toggleClass("cbp-spmenu-push-toright")):(jQuery("#header_container").addClass("sideMenuOpen"),jQuery("#footer_container").addClass("sideMenuOpen"),jQuery("#cbp-spmenu-s1").addClass("cbp-spmenu-open"),jQuery("body").toggleClass("cbp-spmenu-push-toright")),QRM.mainController.sideOpen=!e},this.titleBar="Please Select Project",this.init=function(i){var o=t.getSiteUsers().then(function(t){e.siteUsers=t.data}),s=t.getCurrentUser().then(function(t){e.currentUser=t.data,QRM.mainController.userName=e.currentUser.data.display_name}),l=t.getAllRisks().then(function(t){QRM.mainController.risks=t.data,QRM.mainController.risks=jQuery.grep(QRM.mainController.risks,function(e){return null==e.riskProjectCode?!1:null!=e}),QRM.mainController.risks.sort(SortByProjectCode),e.risks=QRM.mainController.risks}),c=t.getServerMeta().then(function(t){e.reportServerURL=t.data.reportServerURL,e.siteKey=t.data.siteKey,e.siteName=t.data.siteName,e.siteID=t.data.siteID,e.userEmail=t.data.userEmail,e.userLogin=t.data.userLogin,e.userDisplayName=t.data.userDisplayName,e.sessionToken=t.data.sessionToken,setTimeout(function(){startChatChannel(e.reportServerURL+"/reportMsg",e.userEmail,e.siteKey,e,!0)},5e3),n.jsonp(e.reportServerURL+"/availableReports&callback=JSON_CALLBACK").success(function(t){e.reports=t}).error(function(e){})["finally"](function(){})});a.all([o,s,l,c]).then(function(){i&&(postType="firstproject",r.go("qrm.explorer"))})}}function ExplorerCtrl(e,t,r,i,n,a,o,s){t.project.title?QRM.mainController.titleBar="Risk Explorer - "+t.project.title:QRM.mainController.titleBar="Risk Explorer",QRM.mainController.titleBarSM="QRM Risk Explorer",QRM.expController=this,e.siteName=t.siteName,e.getMyCtrlScope=function(){return e},this.getTableHeight=function(){return{height:"calc(100vh - 320px)"}},this.getTableHeightSm=function(){return{height:"calc(100vh - 145px)"}},t.riskID=0;var l=this;this.childProjects=!1,t.project.id>0&&(this.project=t.project),e.checkUserCap=function(e,t){return QRM.mainController.checkUserCap(e,t)},e.savingrisk=!1,this.valPre=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.valPost=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.filterMatrixFlag=!1,this.filterMatrixHighlightFlag=!1,this.gridOptions={enableSorting:!0,rowTemplate:'<div ng-click="grid.appScope.editRisk(row.entity.id)" style="cursor:pointer" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',columnDefs:[{field:"riskProjectCode",enableColumnMoving:!1,width:80,headerCellClass:"header-hidden",cellClass:function(e,t,r,i,n){switch(Number(t.entity.currentTolerance)){case 1:return"blue compact";case 2:return"green compact";case 3:return"yellow compact";case 4:return"orange compact";case 5:return"red compact"}}},{headerCellClass:"header-hidden",width:50,field:"currentTolerance",cellTemplate:'<i class="fa fa-circle {{grid.appScope.formatCodeCol(grid, row)}}"></i>',cellClass:"cellCentered",sort:{direction:s.DESC}},{name:"title",width:"*",cellClass:"compact",field:"title"},{name:"treated",width:70,field:"treated",cellTemplate:'<i style="color:green" ng-show="grid.appScope.formatTreatedCol(row, true)" class="fa fa-check"></i><i  style="color:red" ng-show="grid.appScope.formatTreatedCol(row, false)" class="fa fa-close"></i>',cellClass:"cellCentered",sort:{direction:s.ASC}},{name:"owner",width:140,field:"owner",cellFilter:"usernameFilter"},{name:"manager",width:140,field:"manager",cellFilter:"usernameFilter"}]},this.gridOptionsSm={enableSorting:!0,rowTemplate:'<div ng-click="grid.appScope.editRisk(row.entity.id)" style="cursor:pointer" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',columnDefs:[{field:"riskProjectCode",enableColumnMoving:!1,width:80,name:"Risk ID",cellClass:function(e,t,r,i,n){switch(Number(t.entity.currentTolerance)){case 1:return"blue compact";case 2:return"green compact";case 3:return"yellow compact";case 4:return"orange compact";case 5:return"red compact"}}},{name:"title",width:"*",cellClass:"compact",field:"title"},{name:"owner",width:100,field:"owner",cellFilter:"usernameFilter"}]},e.formatTreatedCol=function(e,t){return e.entity.treated&&t?!0:e.entity.treated||t?!1:!0},this.resetFilter=function(){return this.filterMatrix=!1,{owner:"",manager:"",category:"",expActive:!0,expPending:!0,expInactive:!0,treated:!0,untreated:!0,tolEx:!0,tolHigh:!0,tolSig:!0,tolModerate:!0,tolLow:!0,inactive:!0,active:!0,pending:!0,filterMatrix:!1,riskCode:"",inactive:!0,active:!0,pending:!0,childProjects:!1}},this.filterOptions=this.resetFilter(),e.formatCodeCol=function(e,t){switch(Number(t.entity.currentTolerance)){case 1:return"bluefill";case 2:return"greenfill";case 3:return"yellowfill";case 4:return"orangefill";case 5:return"redfill"}},e.$watch("exp.filterOptions",function(){l.filterRisks()},!0),this.newRisk=function(){postType=null,t.riskID=-1,r.go("qrm.risk")},this.checkForReports=function(){var e=t.reportServerURL+"/getCompletedReports?callback=JSON_CALLBACK&&sessionToken="+t.sessionToken;o.jsonp(e).success(function(e){if(0==e.length)QRM.mainController.notify3("All Completed Reports Have Been Downloaded",2e3);else{QRM.mainController.notify2("Downloading Completed Report");for(var r=0;r<e.length;r++){var i=e[r];jQuery('input[name="userEmail"]').val(t.userEmail),jQuery('input[name="userLogin"]').val(t.userLogin),jQuery('input[name="siteKey"]').val(t.siteKey),jQuery('input[name="id"]').val(i),jQuery("#getReportForm").attr("action",t.reportServerURL+"/getReport",!1),jQuery("#getReportForm").submit()}}}).error(function(e){ngNotify.dismiss(),ngNotify.set("Error Retrieving Available Reports",{type:"grimace",duration:1e3,theme:"pure"})})},this.newPushDownRisk=function(){this.pushDown=t.getTemplateRisk(),this.pushDown.title="Title of the new Push Down Risk",this.pushDown.description="Description of the Push Down Risk",this.pushDown.type=1,this.pushDown.projectID=t.project.id,this.pushDown.inherentProb=t.project.matrix.maxProb+.5,this.pushDown.inherentImpact=t.project.matrix.maxImpact+.5;var r=Math.floor(this.pushDown.treatedProb-1)*t.project.matrix.maxImpact+Math.floor(this.pushDown.treatedImpact-1);r=Math.min(r,t.project.matrix.tolString.length-1),this.pushDown.treatedTolerance=t.project.matrix.tolString.substring(r,r+1),r=Math.floor(this.pushDown.inherentProb-1)*t.project.matrix.maxImpact+Math.floor(this.pushDown.inherentImpact-1),r=Math.min(r,t.project.matrix.tolString.length-1),this.pushDown.inherentTolerance=t.project.matrix.tolString.substring(r,r+1),this.pushDown.currentProb=this.pushDown.inherentProb,this.pushDown.currentImpact=this.pushDown.inherentImpact,this.pushDown.currentTolerance=this.pushDown.inherentTolerance,n.openConfirm({template:"editPushDownDialogId",className:"ngdialog-theme-default",scope:e}).then(function(r){e.savingrisk=!0,i.newPushDownRisk(l.pushDown).then(function(e){})["finally"](function(){i.getAllRisks().then(function(e){QRM.mainController.risks=e.data,QRM.mainController.risks=jQuery.grep(QRM.mainController.risks,function(e){return null==e.riskProjectCode?!1:null!=e}),QRM.mainController.risks.sort(SortByProjectCode),t.risks=QRM.mainController.risks})["finally"](function(){e.savingrisk=!1}),l.getAllProjectRisks()})})},e.editRisk=function(e){l.editRisk(e)},this.editRisk=function(n){postType=null,t.riskID=n,e.loading=!0,i.getRisk(t.riskID).then(function(i){return i.data.msg?(e.loading=!1,void alert(i.data.msg)):(t.pRisk=i.data,t.passRisk=!0,void r.go("qrm.risk"))})["finally"](function(){e.loading=!1})},this.deleteRisk=function(e){t.riskID=e,alert("Delete Risk: "+e)},this.getAllProjectRisks=function(){QRM.mainController.lookingForRisks(),i.getAllProjectRisks(l.project.id,l.childProjects).then(function(e){if("0"==e.data||"-1"==e.data)return void r.go("login");0==e.data.length?QRM.mainController.noRisksFound():QRM.mainController.risksFound(),l.rawRisks=e.data,t.projectRisks=e.data,l.gridOptions.data=e.data,l.gridOptionsSm.data=e.data;for(var i=Number(t.project.matrix.maxImpact),n=Number(t.project.matrix.maxProb),a=0;i*n>a;a++)l.valPre[a]=0,l.valPost[a]=0;e.data.forEach(function(e){var t=Math.floor(Number(e.inherentProb)),r=Math.floor(Number(e.inherentImpact)),n=Math.floor(Number(e.treatedProb)),a=Math.floor(Number(e.treatedImpact));l.valPre[(t-1)*i+r-1]++,l.valPost[(n-1)*i+a-1]++}),l.filterRisks();var o=jQuery(document).width()-10;jQuery("#container").css("width",o+"px")})},this.filterRisks=function(){null!=this.rawRisks&&(this.gridOptions.data=[],this.rawRisks.forEach(function(e){var t=!1;if(l.filterMatrixFlag){var r,i;l.filterOptions.matrixTreated?(r=Math.floor(Number(e.treatedImpact)),i=Math.floor(Number(e.treatedProb))):(r=Math.floor(Number(e.inherentImpact)),i=Math.floor(Number(e.inherentProb))),r==l.filterOptions.matrixImpact&&i==l.filterOptions.matrixProb&&(t=!0)}else{if(l.filterMatrixHighlightFlag=!1,l.filterOptions.treated&&e.treated&&(t=!0),l.filterOptions.untreated&&!e.treated&&(t=!0),!t)return;if(t=!1,l.filterOptions.tolEx&&5==Number(e.currentTolerance)&&(t=!0),l.filterOptions.tolHigh&&4==Number(e.currentTolerance)&&(t=!0),l.filterOptions.tolSig&&3==Number(e.currentTolerance)&&(t=!0),l.filterOptions.tolModerate&&2==Number(e.currentTolerance)&&(t=!0),l.filterOptions.tolLow&&1==Number(e.currentTolerance)&&(t=!0),!t)return;t=!1;var n=l.filterOptions.owner,a=l.filterOptions.manager;if(n!=e.owner&&void 0!=n&&null!=n&&""!=n||a!=e.manager&&void 0!=a&&null!=a&&""!=a)return;var o=moment(),s=o.diff(moment(e.end)),c=o.diff(moment(e.start));l.filterOptions.expInactive&&s>0&&(t=!0),l.filterOptions.expPending&&0>c&&(t=!0),l.filterOptions.expActive&&c>0&&0>s&&(t=!0)}t&&t&&l.gridOptions.data.push(e)}),this.filterMatrixFlag=!1)},this.matrixFilter=function(e,t,r){this.filterMatrixFlag=!0,this.filterMatrixHighlightFlag=!0,this.filterOptions=this.resetFilter(),this.filterOptions.matrixProb=t,this.filterOptions.matrixImpact=e,this.filterOptions.matrixTreated=r},this.clearFilters=function(){this.filterOptions=this.resetFilter()},this.rowStyle=function(e){return{"margin-left":20*e.$$treeLevel+"px"}},this.projectSelect=function(r,i){QRM.mainController.loadingProject(),t.selectProject(i),this.project=t.project,QRM.mainController.titleBar="Risk Explorer - "+t.project.title,QRM.mainController.titleBarSM="QRM Risk Explorer",this.getAllProjectRisks(this.project.id,l.childProjects),this.clearFilters(),jQuery("a.disable-noproject").removeClass("disable-link"),a(function(){e.$apply()})},this.getCellValue=function(e,r,i){if(i){var n=this.valPost[(e-1)*t.project.matrix.maxImpact+r-1];return 0==n?"":n}var n=this.valPre[(e-1)*t.project.matrix.maxImpact+r-1];return 0==n?"":n},this.cellHighlight=function(e,t,r){var i=this.filterMatrixHighlightFlag&&this.filterOptions.matrixProb==e&&this.filterOptions.matrixImpact==t&&this.filterOptions.matrixTreated==r;return i},this.cellClass=function(e,r,i){if(r>t.project.matrix.maxImpact||e>t.project.matrix.maxProb)return!0;var n=(e-1)*t.project.matrix.maxImpact+r-1;return Number(t.project.matrix.tolString.substring(n,n+1))==i},e.reportStressTest=function(){QRM.expController.stress()},this.stress=function(){i.getReportRiskJSON([],t.project.id,!0,!0,2).then(function(e){"OK"==e.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(e.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(t.userEmail),jQuery('input[name="reportID"]').val(2),jQuery("#reportForm").attr("action",e.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}),setTimeout(QRM.expController.stress,4e3)},e.riskReport=function(r){e.reportReqID<0||(QRM.mainController.notify("Assembling Data for Report",5e3),i.getReportRiskJSON([],t.project.id,l.childProjects,!1,e.reportReqID).then(function(r){"OK"==r.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(r.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(t.userEmail),jQuery('input[name="reportID"]').val(e.reportReqID),jQuery("#reportForm").attr("action",r.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}))},this.cellStyle=function(e,r,i){var n=100/t.project.matrix.maxProb,a=100/t.project.matrix.maxImpact;return{width:a+"%",height:n+"%","text-align":"center"}},this.rowClass=function(e){return e>t.project.matrix.maxProb?!0:!1},this.init=function(){i.getProjects().then(function(e){return"0"==e.data||"-1"==e.data?void r.go("login"):(jQuery("#explorer-wrapper").removeClass("hidden-qrm"),t.handleGetProjects(e),l.projectsLinear=t.projectsLinear,l.sortedParents=t.sortedParents,l.projMap=t.projMap,void("riskproject"==postType?(l.projectSelect(null,postID),postType=null):"firstproject"==postType?(l.projectSelect(null,t.sortedParents[0].id),postType=null):t.project.id>0&&l.getAllProjectRisks(t.project.id)))})},winWidth=jQuery(window).innerWidth()-10,jQuery("#container").css("width",winWidth+"px"),this.init()}function RiskCtrl(e,t,r,i,n,a,o,s){e.getMyCtrlScope=function(){return e};var l=this;this.riskID=t.riskID,this.reviewType=-1,this.stakeholders=[],this.additionalHolders=[],this.project=t.project,this.categories=t.catData,this.objectives=t.projectObjectives,e.data={comment:""},e.siteUsers=[],e.dropzoneConfig={options:{url:ajaxurl+"?action=uploadFile",previewTemplate:document.querySelector("#preview-template").innerHTML,parallelUploads:1,thumbnailHeight:120,thumbnailWidth:120,maxFilesize:10,filesizeBase:1e3,autoProcessQueue:!1,thumbnail:function(e,t){if(e.previewElement){e.previewElement.classList.remove("dz-file-preview");for(var r=e.previewElement.querySelectorAll("[data-dz-thumbnail]"),i=0;i<r.length;i++){var n=r[i];n.alt=e.name,n.src=t}setTimeout(function(){e.previewElement.classList.add("dz-image-preview")},1)}},init:function(){this.on("addedfile",function(e){l.riskAttachmentReady(this,e)}),this.on("complete",function(e){e.previewElement.classList.add("dz-complete"),l.cancelAttachment(),a.set("Attachment Added To Risk",{type:"success",duration:1e3,theme:"pure"}),n.getAttachments(l.riskID).then(function(e){l.risk.attachments=e.data})}),this.on("error",function(e,t,r){e.previewElement.classList.add("dz-complete"),l.cancelAttachment(),a.set(t,{type:"error",duration:1e3,theme:"pure"})})},sending:function(e,r,i){i.append("postID",t.riskID),i.append("description",l.uploadAttachmentDescription)}}},this.riskAttachmentReady=function(t,r){l.dropzone=t,l.dzfile=r,l.disableAttachmentButon=!1,e.$apply()},this.uploadAttachmentDescription="",this.disableAttachmentButon=!0,this.dropzone="",this.uploadAttachment=function(){a.set("File Is Being Uploaded and Imported. Please Standby",{type:"info",sticky:!0,theme:"pure"}),l.dropzone.processFile(l.dzfile)},this.cancelAttachment=function(){l.dropzone.removeAllFiles(!0),l.uploadAttachmentDescription=null,l.disableAttachmentButon=!0,l.dropzone=null,l.dzfile=null,e.$apply()},this.openAuditEditor=function(){o.openConfirm({template:"registerAudit",className:"ngdialog-theme-default",scope:e}).then(function(e){return-1==l.reviewType?(a.dismiss(),void a.set("Please Enter Audit Type",{type:"grimace",duration:1e3,theme:"pure"})):void n.registerAudit(l.reviewType,l.reviewComment,l.risk.id).then(function(e){l.risk.audit=e.data,a.dismiss(),a.set("Audit Registered",{type:"success",duration:1e3,theme:"pure"})})["finally"](function(){l.reviewType=-1,l.reviewComment=""})},function(e){l.reviewType=-1,l.reviewComment=""})},this.openDescriptionEditor=function(){var t=l.risk.title,r=l.risk.description;o.openConfirm({template:"editTitleModalDialogId",className:"ngdialog-theme-default",scope:e}).then(function(e){},function(e){l.risk.title=t,l.risk.description=r})},this.openConsequenceEditor=function(){var t=l.risk.consequence;o.openConfirm({template:"editConsqModalDialogId",className:"ngdialog-theme-default",scope:e}).then(function(e){},function(e){l.risk.consequence=t})},this.openCauseEditor=function(){var t=l.risk.cause;o.openConfirm({template:"editCauseModalDialogId",className:"ngdialog-theme-default",scope:e}).then(function(e){},function(e){l.risk.cause=t})},this.openMitEditor=function(t){var r=l.risk.mitigation.mitPlanSummary,i=l.risk.mitigation.mitPlanSummaryUpdate;o.openConfirm({template:t?"editMitigationModalDialogId":"editMitigationModalDialogId2",className:"ngdialog-theme-default",scope:e}).then(function(e){},function(e){l.risk.mitigation.mitPlanSummary=r,l.risk.mitigation.mitPlanSummaryUpdate=i})},this.openRespEditor=function(t){var r=l.risk.response.respPlanSummary,i=l.risk.response.respPlanSummaryUpdate;o.openConfirm({template:t?"editResponseModalDialogId":"editResponseModalDialogId2",className:"ngdialog-theme-default",scope:e}).then(function(e){},function(e){l.risk.response.respPlanSummary=r,l.risk.response.respPlanSummaryUpdate=i})},this.impactChange=function(){l.updateRisk()},this.probChange=function(){switch(l.risk.useCalProb||(l.risk.likeType=4,l.risk.likePostType=4),Number(l.risk.likeType)){case 1:l.risk.likeT=365;break;case 2:l.risk.likeT=30;break;case 3:break;default:l.risk.likeT=0}switch(Number(l.risk.likePostType)){case 1:l.risk.likePostT=365;break;case 2:l.risk.likePostT=30;break;case 3:break;default:l.risk.likePostT=0}l.risk.inherentProb=probToMatrix(calcProb(l.risk,!0),l.project.matrix),l.risk.treatedProb=probToMatrix(calcProb(l.risk,!1),l.project.matrix),l.updateRisk()},this.cancelRisk=function(){r.go("qrm.explorer")},this.getRisk=function(){isNaN(l.riskID)||0==l.riskID||n.getRisk(l.riskID).then(function(r){l.risk=r.data,e.risk=l.risk,t.risk=l.risk,l.updateRisk(),l.setRiskMatrixID("riskEditorMatrixID"),l.setRiskMatrix(),i(function(){e.$apply()})})},this.newDummyRisk=function(){l.updateRisk(),l.risk.comments=[],l.risk.projectID=t.project.id,l.risk.attachments=[],n.createDummyRiskEntry(l.risk).then(function(e){a.set("Risk Saved","success")})["finally"](function(){})},this.newDummyRisks=function(){l.updateRisk(),l.risk.comments=[],l.risk.projectID=t.project.id,l.risk.attachments=[],n.createDummyRiskEntries(l.risk).then(function(e){a.dismiss(),a.set("Risk Saved",{type:"success",duration:1e3,theme:"pure"})})["finally"](function(){})},this.saveRisk=function(){e.savingrisk=!0,l.updateRisk(),l.risk.comments=[],l.risk.projectID=t.project.id,l.risk.attachments=[],n.saveRisk(l.risk).then(function(r){return r.data.error?(e.savingrisk=!1,void alert(r.data.msg)):(l.risk=r.data,t.riskID=l.risk.riskID,t.risk=l.risk,l.updateRisk(),a.dismiss(),void a.set("Risk Saved",{type:"success",duration:1e3,theme:"pure"}))})["finally"](function(){e.savingrisk=!1})},this.updateRisk=function(){QRM.mainController.titleBar="Risk - "+l.risk.riskProjectCode,QRM.mainController.titleBarSM="Risk - "+l.risk.riskProjectCode;try{l.secCatArray=jQuery.grep(l.project.categories,function(e){return e.name==l.risk.primcat.name})[0].sec}catch(e){console.log(e.message)}try{l.setRiskMatrix(l.matrixDIVID)}catch(e){console.log(e.message)}try{l.stakeholders=[],l.stakeholders.push({name:l.risk.owner,role:"Risk Owner"}),l.stakeholders.push({name:l.risk.manager,role:"Risk Manager"}),l.risk.mitigation.mitPlan.forEach(function(e){l.stakeholders.push({name:e.person,role:"Mitigation Owner"})}),l.risk.response.respPlan.forEach(function(e){l.stakeholders.push({name:e.person,role:"Response Owner"})}),l.stakeholders=l.stakeholders.concat(l.additionalHolders)}catch(e){console.log(e.message)}for(var t={},r=0;r<l.stakeholders.length;r++)t[l.stakeholders[r].name+l.stakeholders[r].role]=l.stakeholders[r];var i=new Array;for(var n in t)i.push(t[n]);l.stakeholders=i;try{l.risk.useCalProb||(l.risk.likeType=4,l.risk.likePostType=4);var a=Math.floor(l.risk.treatedProb-1)*l.project.matrix.maxImpact+Math.floor(l.risk.treatedImpact-1);a=Math.min(a,l.project.matrix.tolString.length-1),l.risk.treatedTolerance=l.project.matrix.tolString.substring(a,a+1),a=Math.floor(l.risk.inherentProb-1)*l.project.matrix.maxImpact+Math.floor(l.risk.inherentImpact-1),a=Math.min(a,l.project.matrix.tolString.length-1),l.risk.inherentTolerance=l.project.matrix.tolString.substring(a,a+1),l.risk.treated?(l.risk.currentProb=l.risk.treatedProb,l.risk.currentImpact=l.risk.treatedImpact,l.risk.currentTolerance=l.risk.treatedTolerance):(l.risk.currentProb=l.risk.inherentProb,l.risk.currentImpact=l.risk.inherentImpact,l.risk.currentTolerance=l.risk.inherentTolerance),l.risk.useCalProb?(l.inherentAbsProb=calcProb(l.risk,!0),l.treatedAbsProb=calcProb(l.risk,!1)):(l.treatedAbsProb=probFromMatrix(l.risk.treatedProb,l.project.matrix),l.inherentAbsProb=probFromMatrix(l.risk.inherentProb,l.project.matrix)),l.risk.inherentAbsProb=l.inherentAbsProb,l.risk.treatedAbsProb=l.treatedAbsProb}catch(e){alert("Error"+e.message)}var o;switch(Number(l.risk.currentTolerance)){case 5:o="panel-danger";break;case 4:o="panel-warning";break;case 3:o="panel-sig";break;case 2:o="panel-info";break;case 1:o="panel-success"}jQuery("div.panel").removeClass("panel-info").removeClass("panel-warning").removeClass("panel-success").removeClass("panel-danger").removeClass("panel-sig").addClass(o),jQuery("#exposure").daterangepicker({format:"MMMM D, YYYY",separator:" - ",showDropdowns:!0,drops:"down",opens:"left"},function(e,t,r){try{angular.element("#exposure").controller().updateDates(e,t)}catch(i){console.log(i.message)}});var s=moment(l.risk.start),e=moment(l.risk.end);try{jQuery("#exposure").data("daterangepicker").setStartDate(s),jQuery("#exposure").data("daterangepicker").setEndDate(e)}catch(e){}},this.updateDates=function(e,t){l.risk.start=e,l.risk.end=t,l.updateRisk()},this.setRiskMatrixID=function(e){t.matrixDIVID=e},this.setRiskMatrix=function(){setRiskEditorMatrix(l.risk,l.project.matrix,t.matrixDIVID,t.matrixDisplayConfig,l.dragStart,l.drag,l.dragEnd)},this.dragEnd=function(t){l.risk.useCalProb=!1,l.risk.liketype=4,l.risk.likepostType=4,t.treated?(l.risk.treatedProb=Number(t.prob),l.risk.treatedImpact=Number(t.impact)):(l.risk.inherentProb=Number(t.prob),l.risk.inherentImpact=Number(t.impact)),l.updateRisk(),e.$apply()},this.dragStart=function(e){l.risk.useCalProb=!1,l.risk.useCalProb=!1,l.risk.liketype=4,l.risk.likepostType=4},this.drag=function(){},this.addMit=function(){l.risk.mitigation.mitPlan.push({description:"No Description of the Action Entered ",person:-1,cost:0,complete:0,due:new Date})},this.addResp=function(){l.risk.response.respPlan.push({description:"No Description of the Action Entered ",person:-1,cost:0})},this.addControl=function(){var e={description:"No Description of the Control Entered ",effectiveness:"No Assigned Effectiveness",contribution:"No Contribution Entered"};l.risk.controls?l.risk.controls.push(e):l.risk.controls=[e]},this.addComment=function(r){e.data.comment="",o.openConfirm({template:"addCommentModalDialogId",className:"ngdialog-theme-default",scope:e}).then(function(r){n.addGeneralComment(e.data.comment,t.riskID).then(function(e){return e.data.error?void alert(e.data.msg):(a.dismiss(),a.set("Comment Added To Risk",{type:"success",duration:1e3,theme:"pure"}),void(l.risk.comments=e.data))})},function(e){})},this.addCommentSm=function(){n.addGeneralComment(e.data.comment,t.riskID).then(function(e){return e.data.error?void alert(e.data.msg):(a.dismiss(),a.set("Coment Added To Risk",{type:"success",duration:1e3,theme:"pure"}),void(l.risk.comments=e.data))}),e.data.comment=""},this.editMitStep=function(t){var r=t.$$hashKey;t.due=new Date(t.due);var i=jQuery.extend(!0,{},t);e.step=t,o.openConfirm({template:"editMitStepModalDialogId",className:"ngdialog-theme-default",scope:e}).then(function(e){},function(e){var t=jQuery.grep(l.risk.mitigation.mitPlan,function(e){return e.$$hashKey==r})[0];t.complete=i.complete,t.cost=i.cost,t.description=i.description,t.due=i.due,t.person=i.person})},this.editControl=function(t){var r=t.$$hashKey,i=jQuery.extend(!0,{},t);e.control=t,e.effectArray=["Ad Hoc","Repeatable","Defined","Managed","Optimising"],e.contribArray=["Minimal","Minor","Significant","Major"],
o.openConfirm({template:"editControlModalDialogId",className:"ngdialog-theme-default",scope:e}).then(function(e){},function(e){var t=jQuery.grep(l.risk.controls,function(e){return e.$$hashKey==r})[0];t.effectiveness=i.effectiveness,t.description=i.description,t.contribution=i.contribution})},this.editRespStep=function(t){var r=t.$$hashKey;t.due=new Date(t.due);var i=jQuery.extend(!0,{},t);e.step=t,o.openConfirm({template:"editRespStepModalDialogId",className:"ngdialog-theme-default",scope:e}).then(function(e){},function(e){var t=jQuery.grep(l.risk.response.respPlan,function(e){return e.$$hashKey==r})[0];t.cost=i.cost,t.description=i.description,t.person=i.person})},this.deleteMitStep=function(e){o.openConfirm({template:"deleteMitStepModalDialogId",className:"ngdialog-theme-default"}).then(function(t){for(var r=0;r<l.risk.mitigation.mitPlan.length;r++)if(l.risk.mitigation.mitPlan[r].$$hashKey==e.$$hashKey){l.risk.mitigation.mitPlan.splice(r,1);break}})},this.deleteRespStep=function(e){o.openConfirm({template:"deleteRespStepModalDialogId",className:"ngdialog-theme-default"}).then(function(t){for(var r=0;r<l.risk.response.respPlan.length;r++)if(l.risk.response.respPlan[r].$$hashKey==e.$$hashKey){l.risk.response.respPlan.splice(r,1);break}})},this.deleteControl=function(e){o.openConfirm({template:"deleteControlModalDialogId",className:"ngdialog-theme-default"}).then(function(t){for(var r=0;r<l.risk.controls.length;r++)if(l.risk.controls[r].$$hashKey==e.$$hashKey){l.risk.controls.splice(r,1);break}})},this.rowStyle=function(e){return{"margin-left":15*e.$$treeLevel+"px"}},this.getPanelColor=function(e){return"undefined"==typeof l.risk?!1:"danger"==e&&5==l.risk.currentTolerance?!0:"warning"==e&&4==l.risk.currentTolerance?!0:"sig"==e&&3==l.risk.currentTolerance?!0:"info"==e&&2==l.risk.currentTolerance?!0:"success"==e&&1==l.risk.currentTolerance?!0:!1},e.riskReport=function(r){e.reportReqID<0||n.getReportRiskJSON([l.riskID],l.risk.projectID,!1,!1,e.reportReqID).then(function(r){"OK"==r.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(r.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(t.userEmail),jQuery('input[name="reportID"]').val(e.reportReqID),jQuery("#reportForm").attr("action",r.data.reportServerURL+"/report"),jQuery("#reportForm").submit())})},this.showDummy=function(){return!1},this.init=function(){return t.passRisk?(l.risk=t.pRisk,e.risk=l.risk,t.risk=l.risk,l.updateRisk(),l.setRiskMatrixID("riskEditorMatrixID"),l.setRiskMatrix(),i(function(){e.$apply()}),t.passRisk=!1,winWidth=jQuery(window).innerWidth()-10,void jQuery("#container").css("width",winWidth+"px")):("risk"==postType?(l.categories=t.catData,l.objectives=t.projectObjectives,e.siteUsers=t.siteUsers,l.riskID=postID,l.getRisk(),postType=null):-1==t.riskID?(l.risk=t.getTemplateRisk(),l.risk.inherentProb=l.project.matrix.maxProb+.5,l.risk.inherentImpact=l.project.matrix.maxImpact+.5,e.risk=l.risk,l.updateRisk(),l.setRiskMatrixID("riskEditorMatrixID"),l.setRiskMatrix()):this.getRisk(),winWidth=jQuery(window).innerWidth()-10,void jQuery("#container").css("width",winWidth+"px"))},null!=t.siteUsers?(t.siteUsers.forEach(function(t){e.siteUsers.push(t.ID)}),l.init()):l.init()}function CalenderController(e,t,r,i){QRM.mainController.titleBar="QRM Exposure Calender - "+t.project.title,QRM.mainController.titleBarSM="QRM Exposure Calender",qrm.calenderController=this;var n=this;this.project=t.project,this.childProjects=!1,e.$watch("cal.childProjects",function(){n.getRisks()},!0),this.showDesc=!1,this.riskProjectCode="",this.title="",this.description="",this.status={val:0},this.showFilters=function(){jQuery("#calenderFilter").slideDown("slow")},this.closeFilters=function(){jQuery("#calenderFilter").slideUp("slow")},this.owner="",this.manager="";var a=new Array,o=new Array;this.ownerSelect=function(){n.manager="",n.stateSelectorChanged()},this.managerSelect=function(){n.owner="",n.stateSelectorChanged()},this.clearFilters=function(){n.manager="",n.owner="",n.status.val=0,n.stateSelectorChanged()},this.stateSelectorChanged=function(){var e=new Array,t=new Date;n.risks.forEach(function(r){switch(Number(n.status.val)){case 0:e.push(r);break;case 1:moment(r.end)<t&&e.push(r);break;case 2:moment(r.start)>t&&e.push(r);break;case 3:moment(r.start)<t&&moment(r.end)>t&&e.push(r)}});var r=new Array;e.forEach(function(e){(e.manager==n.manager||""==n.manager)&&r.push(e)});var i=new Array;r.forEach(function(e){(e.owner==n.owner||""==n.owner)&&i.push(e)}),n.layoutCalender(i),jQuery("#calenderFilter").slideUp("slow")},this.editRisk=function(e){t.riskID=e,r.go("qrm.risk")},this.getRisks=function(){i.getAllProjectRisks(t.project.id,n.childProjects).then(function(e){n.risks=e.data,n.layoutCalender(n.risks)})},this.layoutCalender=function(e){a=new Array,o=new Array,e.forEach(function(e){a.push({startDate:moment(e.start),endDate:moment(e.end),taskName:e.riskProjectCode,status:"RUNNING",riskID:e.id,title:e.title})});var t=new Date;a.sort(function(e,t){return e.startDate-t.startDate}),a.forEach(function(e){e.startDate>t?e.className="future":e.endDate<t?e.className="past":e.className="now",o.push(e.taskName)}),d3.select("#svgcalID").selectAll("svg").remove();var r=d3.gantt(n).taskTypes(o).tickFormat("%b %Y");r(a,"#svgcalID",jQuery("#svgcalID").width(),jQuery("#svgcalID").height())},this.getRisks(),this.resize=function(){d3.select("#svgcalID").selectAll("svg").remove();var e=d3.gantt(n).taskTypes(o).tickFormat("%b %Y");e(a,"#svgcalID",jQuery("#svgcalID").width(),jQuery("#svgcalID").height())},this.toolTip=function(t){t?(n.showDesc=!0,n.startDate=moment(t.startDate).format("MMM DD, gggg"),n.endDate=moment(t.endDate).format("MMM DD, gggg"),n.title=t.title,n.taskName=t.taskName):(n.showDesc=!1,n.startDate=null,n.endDate=null,n.taskName=null,n.title=null),e.$apply()}}function ReportArchiveController(e,t,r,i,n,a,o){QRM.mainController.titleBar="QRM Report Archive",QRM.mainController.titleBarSM="QRM Report Archive";var s=this;e.userEmail=t.userEmail,e.reportServerURL=t.reportServerURL,e.userLogin=t.userLogin,e.siteKey=t.siteKey,this.getTableHeight=function(){return{height:"calc(100vh - 100px)"}},this.getTableHeightSM=function(){return{height:"calc(100vh - 105px)"}},this.gridOptions={enableSorting:!0,columnDefs:[{name:"Title",width:"*",cellClass:"compact",field:"reportTitle"},{name:"Submitted Date",width:180,field:"submittedDate",sort:{direction:o.DESC}},{name:"Completed Date",width:180,field:"completedDate"},{name:"Complete",width:100,field:"completed",cellTemplate:'<i style="color:green" ng-show="grid.appScope.formatCompletedCol(row, true)" class="fa fa-check"></i><i  style="color:red" ng-show="grid.appScope.formatCompletedCol(row, false)" class="fa fa-close"></i>',cellClass:"cellCentered"},{name:"Download",width:130,field:"id",cellTemplate:'<div><a href="{{grid.appScope.reportServerURL}}/getReport?userEmail={{grid.appScope.userEmail}}&userLogin={{grid.appScope.userLogin}}&siteKey={{grid.appScope.siteKey}}&id={{row.entity.id}}" >Download</a></div>',cellClass:"cellCentered",headerCellClass:"cellCentered",enableSorting:!1,enableHiding:!1},{name:"Remove",width:130,field:"id",cellTemplate:'<div><a ng-click="grid.appScope.reportReqID = row.entity.id;grid.appScope.removeReport()" href="#">Remove</a></div>',cellClass:"cellCentered",headerCellClass:"cellCentered",enableSorting:!1,enableHiding:!1}]},this.gridOptionsSM={enableSorting:!0,rowTemplate:'<div ng-click="grid.appScope.editIncident(row.entity.id)" style="cursor:pointer" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',columnDefs:[{name:"Title",width:"*",cellClass:"compact",field:"reportTitle"},{name:"Submitted Date",width:180,field:"submittedDate",sort:{direction:o.DESC}},{name:"Download",width:130,field:"id",cellTemplate:'<div><a href="{{grid.appScope.reportServerURL}}/getReport?userEmail={{grid.appScope.userEmail}}&userLogin={{grid.appScope.userLogin}}&siteKey={{grid.appScope.siteKey}}&id={{row.entity.id}}">Download</a></div>',cellClass:"cellCentered",headerCellClass:"cellCentered",enableSorting:!1,enableHiding:!1}]},e.formatCompletedCol=function(e,t){return e.entity.completed&&t?!0:e.entity.completed||t?!1:!0},this.refresh=function(){var e=t.reportServerURL+"/userReports?callback=JSON_CALLBACK&userEmail="+t.userEmail+"&userLogin="+t.userLogin+"&siteKey="+t.siteKey+"&siteID="+t.siteID;n.jsonp(e).success(function(e){e.error?(i.dismiss(),i.set(e.error,{type:"grimace",sticky:!0,position:"top",theme:"pure"}),a.go("qrm.explorer")):(s.gridOptions.data=e,s.gridOptionsSM.data=e)}).error(function(e){i.dismiss(),i.set("Failed To Connect To The Report Server",{type:"grimace",duration:1e3,theme:"pure"})})},e.removeReport=function(){var r=t.reportServerURL+"/removeReport?callback=JSON_CALLBACK&id="+e.reportReqID+"&userEmail="+t.userEmail+"&userLogin="+t.userLogin+"&siteKey="+t.siteKey+"&siteID="+t.siteID;n.jsonp(r).success(function(e){e.error?(i.dismiss(),i.set(e.error,{type:"grimace",duration:1e3,theme:"pure"})):(s.gridOptions.data=e,s.gridOptionsSM.data=e)}).error(function(e){i.dismiss(),i.set("Error Retrieving Archived Reports",{type:"grimace",duration:1e3,theme:"pure"})})},this.refresh()}function RankController(e,t,r,i,n){QRM.mainController.titleBar="QRM Risk Ranking - "+t.project.title,QRM.mainController.titleBarSM="QRM Risk Ranking",qrm.rankController=this;var a,o=this;this.project=t.project,this.editRisk=function(e){t.riskID=e,r.go("qrm.risk")},this.showInstructions=!0,this.saveChanges=function(){a.normaliseRanks(),i.saveRankOrder(a.items).then(function(e){return e.data.error?void alert(e.data.msg):(n.dismiss(),void n.set("Rank Order Saved",{type:"success",duration:1e3,theme:"pure"}))})},this.cancelChanges=function(){this.loadGrid()},e.getMyCtrlScope=function(){return e},e.riskReport=function(r){e.reportReqID<0||(QRM.mainController.notify("Assembling Data for Report",5e3),i.getReportRiskJSON([],t.project.id,!1,!0,e.reportReqID).then(function(r){QRM.mainController.notify("Sending Data for Processing",5e3),"OK"==r.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(r.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(t.userEmail),jQuery('input[name="reportID"]').val(e.reportReqID),jQuery("#reportForm").attr("action",r.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}))},this.loadGrid=function(){QRM.mainController.titleBar="Risk Ranking - "+t.project.title,i.getAllProjectRisks(t.project.id,o.childProjects).then(function(t){var r=t.data;o.dirty=!1,o.risks=r,o.layout=new SorterLayout(o,e),a=o.layout,a.setHeight(jQuery("#subRankSVGDiv").height()),a.setWidth(jQuery("#subRankSVGDiv").width()),a.setItemHeight(35),a.setItemWidth(jQuery("#subRankSVGDiv").width()/2),a.scale(1,1),a.setItems(o.risks),a.setSVGDiv("subRankSVGDiv"),a.setDirtyListener(function(){o.dirty=!0}),a.layoutTable()})};var s=jQuery(window).innerWidth()-10;jQuery("#container").css("width",s+"px"),this.loadGrid(),this.resize=function(){a.setHeight(jQuery("#subRankSVGDiv").height()),a.setWidth(jQuery("#subRankSVGDiv").width()),a.setItemHeight(35),a.setItemWidth(jQuery("#subRankSVGDiv").width()/2),a.scale(1,1),a.setSVGDiv("subRankSVGDiv"),a.layoutTable()}}function AnalysisController(e,t,r){QRM.mainController.titleBar="QRM Analysis Tools"+t.project.title,QRM.mainController.titleBarSM="QRM Analysis Tools",e.projectTitle=t.project.title;var i=this;if(e.getTableHeight=function(){return{height:"calc(100vh - 100px)"}},e.typeSelect=function(r){switch(e.chartName=r.name,d3.select("#chart svg").remove(),d3.select("#chart").append("svg"),i.chart=nv.models.multiBarHorizontalChart().x(function(e){return e.label}).y(function(e){return e.value}).margin({top:30,right:20,bottom:50,left:100}).stacked(!0),window.innerWidth>768?(i.chart.showControls(!0),i.chart.showLegend(!0)):(i.chart.showControls(!1),i.chart.showLegend(!1)),r.id){case"ownerT":nv.addGraph(function(){return i.chart.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),i.chart.xAxis.axisLabel("Risk Owner").axisLabelDistance(30),d3.select("#chart svg").datum(t.owners).call(i.chart),nv.utils.windowResize(i.chart.update),i.chart});break;case"managerT":nv.addGraph(function(){return i.chart.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),i.chart.xAxis.axisLabel("Risk Manager").axisLabelDistance(30),d3.select("#chart svg").datum(t.managers).call(i.chart),nv.utils.windowResize(i.chart.update),i.chart});break;case"cat":nv.addGraph(function(){return i.chart.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),i.chart.xAxis.axisLabel("Risk Category").axisLabelDistance(30),d3.select("#chart svg").datum(t.categories).call(i.chart),nv.utils.windowResize(i.chart.update),i.chart});break;case"status":nv.addGraph(function(){return i.chart.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),i.chart.xAxis.axisLabel("Risk Status").axisLabelDistance(30),d3.select("#chart svg").datum(t.status).call(i.chart),nv.utils.windowResize(i.chart.update),i.chart})}},e.chartName="Risk Owner/Tolerance Allocation",e.data=[{name:"Risk Owner/Tolerance Allocation",id:"ownerT"},{name:"Risk Manager/Tolerance Allocation",id:"managerT"},{name:"Category Allocation",id:"cat"},{name:"Status Allocation",id:"status"}],e.gridOptions={enableSorting:!1,rowTemplate:'<div ng-click="grid.appScope.typeSelect(row.entity)" style="cursor:ponter" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',columnDefs:[{name:"Type",field:"name",enableFilering:!1,enableSorting:!1,enableHiding:!1,cellClass:"cellPointer"}],data:e.data},t.analyseRisks(),jQuery(window).width()<768){var n=t.siteUsers.length+1;d3.select("#analysisCharts").append("div").attr("id","chart1").attr("class","col-lg-12").append("svg").style("height",20*n+80+"px"),i.chart1=nv.models.multiBarHorizontalChart().x(function(e){return e.label}).y(function(e){return e.value}).margin({top:30,right:20,bottom:50,left:100}).stacked(!0).showControls(!1).showLegend(!1),nv.addGraph(function(){return i.chart1.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),i.chart1.xAxis.axisLabel("Risk Owner").axisLabelDistance(30),d3.select("#chart1 svg").datum(t.owners).call(i.chart1),nv.utils.windowResize(i.chart1.update),i.chart1}),d3.select("#analysisCharts").append("div").attr("id","chart2").attr("class","col-lg-12").append("svg").style("height",20*n+80+"px"),i.chart2=nv.models.multiBarHorizontalChart().x(function(e){return e.label}).y(function(e){return e.value}).margin({top:30,right:20,bottom:50,left:100}).stacked(!0).showControls(!1).showLegend(!1),nv.addGraph(function(){return i.chart2.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),i.chart2.xAxis.axisLabel("Risk Manager").axisLabelDistance(30),d3.select("#chart2 svg").datum(t.managers).call(i.chart2),nv.utils.windowResize(i.chart2.update),i.chart2}),d3.select("#analysisCharts").append("div").attr("id","chart3").attr("class","col-lg-12").append("svg").style("height",20*t.catData.length+80+"px"),i.chart3=nv.models.multiBarHorizontalChart().x(function(e){return e.label}).y(function(e){return e.value}).margin({top:30,right:20,bottom:50,left:100}).stacked(!0).showControls(!1).showLegend(!1),nv.addGraph(function(){return i.chart3.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),i.chart3.xAxis.axisLabel("Risk Category").axisLabelDistance(30),d3.select("#chart3 svg").datum(t.categories).call(i.chart3),nv.utils.windowResize(i.chart3.update),i.chart3}),d3.select("#analysisCharts").append("div").attr("id","chart4").attr("class","col-lg-12").append("svg").style("height","140px"),i.chart4=nv.models.multiBarHorizontalChart().x(function(e){return e.label}).y(function(e){return e.value}).margin({top:30,right:20,bottom:50,left:100}).stacked(!0).showControls(!1).showLegend(!1),nv.addGraph(function(){return i.chart4.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),i.chart4.xAxis.axisLabel("Risk Status").axisLabelDistance(30),d3.select("#chart4 svg").datum(t.status).call(i.chart4),nv.utils.windowResize(i.chart3.update),i.chart4})}else e.typeSelect(e.gridOptions.data[0])}function RelMatrixController(e,t,r,i){QRM.mainController.titleBar="QRM Tolerance Matrix - "+t.project.title,QRM.mainController.titleBarSM="QRM Tolerance Matrix";var n=this;qrm.matrixController=this,this.project=t.project,this.status={val:0},this.showDesc=!1,this.riskProjectCode="",this.title="",this.description="",this.owner="",this.manager="",this.selectedRisk="",this.currentItems=new Array,this.matrixDirty=!1,this.editorChanges=!1,this.transMatrix=[1,0,0,1,45,45],this.stateSelectorChanged=function(){jQuery("#matrixFilter").slideUp("slow"),n.risks.forEach(function(e){e.x=0,e.y=0});var e=t.project.matrix.maxProb;d3.selectAll("g.state").transition().duration(2e3).attr("transform",function(r,i){var a=null,o=null;switch(Number(n.status.val)){case 0:r.treated?(a=r.treatedClean?r.treatedProb:r.newTreatedProb,o=r.treatedClean?r.treatedImpact:r.newTreatedImpact):(a=r.untreatedClean?r.inherentProb:r.newInherentProb,o=r.untreatedClean?r.inherentImpact:r.newInherentImpact);break;case 1:r.untreatedClean?(a=r.inherentProb,o=r.inherentImpact):(a=r.newInherentProb,o=r.newInherentImpact);break;case 2:r.treatedClean?(a=r.treatedProb,o=r.treatedImpact):(a=r.newTreatedProb,o=r.newTreatedImpact)}var s=(o-1)*t.relMatrixGridSizeX,l=(e+1-a)*t.relMatrixGridSizeY;return r.x=s,r.y=l,n.risks.forEach(function(e){Math.abs(e.x-r.x)<10&&Math.abs(e.y-r.y)<10&&e.id!=r.id&&(r.x+=5,r.y+=5)}),"translate("+[r.x,r.y]+")"});var r="Current State";switch(Number(n.status.val)){case 0:r="Current State";break;case 1:r="Un Treated State";break;case 2:r="Treated State"}d3.select("#relMatrixSubHeading").text(r)},this.showFilters=function(){jQuery("#matrixFilter").slideDown("slow")},this.closeFilters=function(){jQuery("#matrixFilter").slideUp("slow")},this.cancelChanges=function(){this.matrixDirty=!1,this.risks.forEach(function(e){e.untreatedClean=!0,e.treatedClean=!0,e.dirty=!1}),this.stateSelectorChanged()},this.saveChangesWrapper=function(){this.saveChanges(!1)},this.saveChanges=function(e,a,o,s){var l=new Array;return this.risks.forEach(function(e){if(e.dirty){var r=e.treatedClean?e.treatedImpact:e.newTreatedImpact,i=e.treatedClean?e.treatedProb:e.newTreatedProb,n=e.untreatedClean?e.inherentImpact:e.newInherentImpact,a=e.untreatedClean?e.inherentProb:e.newInherentProb,o=Math.floor(i-1)*t.project.matrix.maxImpact+Math.floor(r-1);o=Math.min(o,t.project.matrix.tolString.length-1);var s=t.project.matrix.tolString.substring(o,o+1);o=Math.floor(a-1)*t.project.matrix.maxImpact+Math.floor(n-1),o=Math.min(o,t.project.matrix.tolString.length-1);var c=t.project.matrix.tolString.substring(o,o+1);l.push({riskID:e.id,newTreatedImpact:r,newTreatedProb:i,newInherentImpact:n,newInherentProb:a,treatedTolerance:s,inherentTolerance:c})}}),l.length<1?(i.dismiss(),void i.set("There Were No Changes To Save",{type:"grimace",duration:1e3,theme:"pure"})):void r.updateRisksRelMatrix(l).then(function(e){return e.data.error?void alert(e.data.msg):(n.risks.forEach(function(e){e.treatedImpact=e.treatedClean?e.treatedImpact:e.newTreatedImpact,e.treatedProb=e.treatedClean?e.treatedProb:e.newTreatedProb,e.inherentImpact=e.untreatedClean?e.inherentImpact:e.newInherentImpact,e.inherentProb=e.untreatedClean?e.inherentProb:e.newInherentProb,e.treatedClean=!0,e.untreatedClean=!0,e.dirty=!1}),i.dismiss(),void i.set("Changes to Probability/Impact Have Been Saved",{type:"success",duration:1e3,theme:"pure"}))})},this.getState=function(){return Number(this.status.val)},this.ownerSelect=function(){n.manager="",n.selectedRisk="";var e=new Array;this.risks.forEach(function(t){t.owner==n.owner&&(t.x=0,t.y=0,e.push(t))}),jQuery("#matrixFilter").slideUp("slow"),this.svgMatrix(e)},this.managerSelect=function(){n.owner="",n.selectedRisk="";var e=new Array;this.risks.forEach(function(t){t.manager==n.manager&&(t.x=0,t.y=0,e.push(t))}),jQuery("#matrixFilter").slideUp("slow"),this.svgMatrix(e)},this.riskSelect=function(){jQuery("#matrixFilter").slideUp("slow"),n.owner="",n.manager="",n.risks.forEach(function(e){e.x=0,e.y=0}),this.svgMatrix(n.risks);var e="#riskID"+n.selectedRisk.id,t=d3.select(e);t.node().parentNode.appendChild(t.node()),t.select("circle.inner").transition().duration(500).styleTween("fill",function(){return d3.interpolate("white","black")}).attr("r","40").transition().duration(500).styleTween("fill",function(){return d3.interpolate("black","white")}).attr("r","25").transition().duration(500).styleTween("fill",function(){return d3.interpolate("white","black")}).attr("r","40").transition().duration(500).styleTween("fill",function(){return d3.interpolate("black","white")}).attr("r","25").transition().duration(500).styleTween("fill",function(){return d3.interpolate("white","black")}).attr("r","40").transition().duration(500).styleTween("fill",function(){return d3.interpolate("black","white")}).attr("r","25"),n.showDesc=!1,n.selectedRisk=""},this.resizePanel=function(){this.svgMatrix(this.risks)},this.clearFilters=function(){n.manager="",n.owner="",n.selectedRisk="",n.risks.forEach(function(e){e.x=0,e.y=0}),this.resetPZ(),this.svgMatrix(this.risks),this.closeFilters()},this.pan=function(e,t){this.transMatrix[4]+=e,this.transMatrix[5]+=t;var r="matrix("+this.transMatrix.join(" ")+")";d3.select("g.relMatrixGroupHolder").attr("transform",r)},this.zoom=function(e){for(var t=0;t<this.transMatrix.length;t++)this.transMatrix[t]*=e;var r="matrix("+this.transMatrix.join(" ")+")";d3.select("g.relMatrixGroupHolder").attr("transform",r)},this.resetPZ=function(){this.transMatrix[0]=1,this.transMatrix[1]=0,this.transMatrix[2]=0,this.transMatrix[3]=1,this.transMatrix[4]=45,this.transMatrix[5]=45;var e="matrix("+this.transMatrix.join(" ")+")";d3.select("g.relMatrixGroupHolder").attr("transform",e)},this.svgMatrix=function(r){for(var i=t.project.matrix.tolString,a=t.project.matrix.maxImpact,o=t.project.matrix.maxProb,s=jQuery("#relMatrixSVGDiv").width(),l=jQuery("#relMatrixSVGDiv").height(),c={top:45,right:27,bottom:45,left:27},d=s-c.left-c.right,u=l-c.top-c.bottom,p=new Array,m=o;m>0;m--)for(var h=1;a>=h;h++){var f=(m-1)*a+h-1,v=i.substring(f,f+1);p.push({impact:h,prob:m,tol:v})}var k=Math.floor(d/a),w=Math.floor(u/o);t.relMatrixGridSizeX=k,t.relMatrixGridSizeY=w,d3.select("#relMatrixSVGDiv svg").remove();var y=d3.select("#relMatrixSVGDiv").append("svg").attr("class","relMatrixGroupHolderTop").attr("width",d+c.left+c.right).attr("height",u+c.top+c.bottom);y.append("defs").append("style").attr("type","text/css").text("rect.tolNoHover5 {fill: #ed5565;stroke: #E6E6E6;stroke-width: 2px; }rect.tolNoHover4 {fill: #f8ac59;stroke: #E6E6E6;stroke-width: 2px; }rect.tolNoHover3 {fill: #ffff55;stroke: #E6E6E6;stroke-width: 2px; }rect.tolNoHover2 {fill: #1ab394;stroke: #E6E6E6;stroke-width: 2px; }rect.tolNoHover1 {fill: #1c84c6; stroke: #E6E6E6; stroke-width: 2px; }g.state circle {stroke  : gray; cursor  : pointer;}g.state circle.inner { fill : white;}g.state circle.outer { display : none; stroke-dasharray: 4px;  stroke-opacity  : 0.5;}text.chartTitle { fill:rgb(103,106,108) }g.state text.untreated { fill:red; font: 12px sans-serif; font-weight : bold; pointer-events : none; }g.state text.treated { fill:blue; font: 12px sans-serif; font-weight : bold; pointer-events : none; }");var R=y.append("g").attr("class","relMatrixGroupHolder").attr("transform","translate("+c.left+","+c.top+") "),C=R.selectAll().data(p).enter().append("g").attr("class","tolCellNoHover");switch(C.append("rect").attr("x",function(e){return(e.impact-1)*k}).attr("y",function(e){return(o-e.prob)*w}).attr("rx",2).attr("ry",2).attr("class",function(e){return"tolNoHover"+e.tol}).attr("width",k).attr("height",w),R.append("text").attr("text-anchor","middle").style("font-size","20px").style("font-weight","normal").attr("class","chartTitle").attr("transform","translate("+[d/2,u+20]+")").text("Impact"),Number(n.status.val)){case 0:state="Current State";break;case 1:state="Un Treated State";break;case 2:state="Treated State"}y.append("text").attr("text-anchor","middle").style("font-size","20px").style("font-weight","normal").attr("class","chartTitle").attr("transform","translate("+[d/2+c.left,20]+")").text(t.project.title),y.append("text").attr("text-anchor","middle").attr("id","relMatrixSubHeading").style("font-size","15px").style("font-weight","normal").attr("class","chartTitle").attr("transform","translate("+[d/2+c.left,38]+")").text(state),R.append("text").attr("text-anchor","middle").style("font-size","20px").style("font-weight","normal").attr("transform","translate("+[-10,u/2]+") rotate(-90)").attr("class","chartTitle").text("Probability"),y.append("g").html('<circle cx="50" cy="50" r="42" fill="white" opacity="0.75" /><path class="compass-button" onclick="qrm.matrixController.pan( 0, 50)" d="M50 10 l12   20 a40, 70 0 0,0 -24,  0z" /><path class="compass-button" onclick="qrm.matrixController.pan( 50, 0)" d="M10 50 l20  -12 a70, 40 0 0,0   0, 24z" /><path class="compass-button" onclick="qrm.matrixController.pan( 0,-50)" d="M50 90 l12  -20 a40, 70 0 0,1 -24,  0z" /><path class="compass-button" onclick="qrm.matrixController.pan(-50, 0)" d="M90 50 l-20 -12 a70, 40 0 0,1   0, 24z" /><circle class="compass" cx="50" cy="50" r="20" onclick="qrm.matrixController.resetPZ()" /><circle class="compass-button" cx="50" cy="41" r="8" onclick="qrm.matrixController.zoom(0.8)" /><circle class="compass-button" cx="50" cy="59" r="8" onclick="qrm.matrixController.zoom(1.25)" /><rect class="plus-minus" x="46" y="39.5" width="8" height="3" /><rect class="plus-minus" x="46" y="57.5" width="8" height="3" /><rect class="plus-minus" x="48.5" y="55" width="3" height="8" />').attr("transform","translate(0 0)").attr("class","hidden-xs");var x=d3.behavior.drag().on("dragstart",function(){var e=d3.event.sourceEvent;e.ctrlKey||d3.event.sourceEvent.stopPropagation()}).on("drag",function(){var e=d3.event.sourceEvent;e.ctrlKey||d3.select(this).attr("transform",function(e,t){return d3.event.ctrlKey?void 0:(g=this.parentNode,isSelected=d3.select(g).classed("selected"),e.x+=d3.event.dx,e.y+=d3.event.dy,e.x<0&&(e.x=0),e.y<0&&(e.y=0),e.x>d&&(e.x=d),e.y>u&&(e.y=u),"translate("+[e.x,e.y]+")")})}).on("dragend",function(e){var r=d3.event.sourceEvent;if(!r.ctrlKey){d3.event.sourceEvent.stopPropagation(),n.matrixDirty=!0,e.dirty=!0;var i=1+e.x/t.relMatrixGridSizeX,a=t.project.matrix.maxProb+1-e.y/t.relMatrixGridSizeY;switch(Number(n.status.val)){case 0:e.treated?(e.treatedClean=!1,e.newTreatedImpact=i,e.newTreatedProb=a):(e.untreatedClean=!1,e.newInherentImpact=i,e.newInherentProb=a);break;case 1:e.untreatedClean=!1,e.newInherentImpact=i,e.newInherentProb=a;break;case 2:e.treatedClean=!1,e.newTreatedImpact=i,e.newTreatedProb=a}d3.event.sourceEvent.stopPropagation()}}),b=25,D=R.append("g").attr("class","risk"),j=D.selectAll().data(r),M=j.enter().append("g").attr("id",function(e){return"riskID"+e.id}).attr({transform:function(e){var r=null,i=null;switch(Number(n.status.val)){case 0:e.treated?(r=e.treatedClean?e.treatedProb:e.newTreatedProb,i=e.treatedClean?e.treatedImpact:e.newTreatedImpact):(r=e.untreatedClean?e.inherentProb:e.newInherentProb,i=e.untreatedClean?e.inherentImpact:e.newInherentImpact);break;case 1:e.untreatedClean?(r=e.inherentProb,i=e.inherentImpact):(r=e.newInherentProb,i=e.newInherentImpact);break;case 2:e.treatedClean?(r=e.treatedProb,i=e.treatedImpact):(r=e.newTreatedProb,i=e.newTreatedImpact)}var a=(i-1)*t.relMatrixGridSizeX,s=(o+1-r)*t.relMatrixGridSizeY;return e.x=a,e.y=s,n.risks.forEach(function(t){Math.abs(t.x-e.x)<10&&Math.abs(t.y-e.y)<10&&t.id!=e.id&&(e.x+=5,e.y+=5)}),"translate("+[e.x,e.y]+")"},"class":"state"});M.call(x),M.append("circle").attr({r:b+4,"class":"outer"}),M.append("circle").attr({r:b,"class":"inner"}).on("click",function(e,t){var r=d3.event,i=this.parentNode,n=d3.select(i).classed("selected");r.ctrlKey||d3.selectAll("g.selected").classed("selected",!1),d3.select(i).classed("selected",!n),i.parentNode.appendChild(i)}).on("mouseover",function(t){var r=this.parentNode,i=d3.select(r).classed("selected");d3.selectAll("g.selected").classed("selected",!1),d3.select(r).classed("selected",!i),r.parentNode.appendChild(r),n.showDesc=!0,n.riskProjectCode=t.riskProjectCode,n.title=t.title,n.description=t.description.substring(0,300),d3.select(this).style("fill","aliceblue"),e.$apply()}).on("mouseout",function(t){d3.select(this).style("fill","white"),d3.selectAll("g.selected").classed("selected",!1),n.showDesc=!1,e.$apply()}).on("click",function(e){var t=d3.event;t.ctrlKey&&(d3.event.defaultPrevented||(n.matrixDirty?msg("Open Risk","Please save or cancel existing changes before opening the risk"):n.listenForEditorChanges=!0))}),M.append("text").attr({"text-anchor":"middle",y:4}).attr("class",function(e){return e.treated?"treated":"untreated"}).text(function(e){return e.riskProjectCode}),M.append("title").text(function(e){return e.riskProjectCode})},this.resize=function(){n.svgMatrix(n.risks)},this.getRisksAndPlace=function(){QRM.mainController.titleBar="Tolerance Matrix - "+t.project.title,r.getAllProjectRisks(t.project.id,n.childProjects).then(function(e){var t=e.data;t.forEach(function(e){e.untreatedClean=!0,e.treatedClean=!0,e.dirty=!1}),n.risks=t,n.svgMatrix(t)})},e.getMyCtrlScope=function(){return e},e.riskReport=function(i){e.reportReqID<0||(QRM.mainController.notify("Assembling Data for Report",5e3),r.getReportRiskJSON([],t.project.id,!1,!0,e.reportReqID).then(function(r){"OK"==r.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(r.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(t.userEmail),jQuery('input[name="reportID"]').val(e.reportReqID),jQuery("#reportForm").attr("action",r.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}))};var a=jQuery(window).innerWidth()-10;jQuery("#container").css("width",a+"px"),this.getRisksAndPlace()}function IncidentExplCtrl(e,t,r,i){QRM.mainController.titleBarSM="QRM Incident Explorer",QRM.mainController.titleBarSM="QRM Incident Explorer";var n=this;this.loading=!1,e.formatTreatedCol=function(e,t){return e.entity.resolved&&t?!0:e.entity.resolved||t?!1:!0},this.getTableHeight=function(){return{height:"calc(100vh - 100px)"}},this.getTableHeightSM=function(){return{height:"calc(100vh - 105px)"}},this.gridOptions={enableSorting:!0,rowTemplate:'<div ng-click="grid.appScope.editIncident(row.entity.id)" style="cursor:pointer" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',columnDefs:[{width:"150",cellClass:"compact",field:"incidentCode",headerCellClass:"header-hidden"},{name:"title",width:"*",cellClass:"compact",field:"title"},{name:"Incident Date",width:140,field:"date",cellFilter:"date"},{name:"Resolved",width:70,field:"resolved",cellTemplate:'<i style="color:green" ng-show="grid.appScope.formatTreatedCol(row, true)" class="fa fa-check"></i><i  style="color:red" ng-show="grid.appScope.formatTreatedCol(row, false)" class="fa fa-close"></i>',cellClass:"cellCentered"},{name:"Reported",width:140,field:"reportedby",cellFilter:"usernameFilter"}]},this.gridOptionsSM={enableSorting:!0,rowTemplate:'<div ng-click="grid.appScope.editIncident(row.entity.id)" style="cursor:pointer" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',
columnDefs:[{width:"100",cellClass:"compact",field:"incidentCode",headerCellClass:"header-hidden"},{name:"title",width:"*",cellClass:"compact",field:"title"},{name:"Resolved",width:70,field:"resolved",cellTemplate:'<i style="color:green" ng-show="grid.appScope.formatTreatedCol(row, true)" class="fa fa-check"></i><i  style="color:red" ng-show="grid.appScope.formatTreatedCol(row, false)" class="fa fa-close"></i>',cellClass:"cellCentered"}]},this.init=function(){var e=jQuery(window).innerWidth()-10;jQuery("#container").css("width",e+"px"),QRM.mainController.titleBar="Incidents",QRM.mainController.lookingForIncidents(),i.getAllIncidents().then(function(e){n.gridOptions.data=e.data,n.gridOptionsSM.data=e.data,n.gridOptions.data.length>0?QRM.mainController.incidentsFound():QRM.mainController.noIncidentsFound()})["finally"](function(){})},e.editIncident=function(e){n.editIncident(e)},this.editIncident=function(e){n.loading=!0,i.getIncident(e).then(function(e){t.incident=e.data,null!=t.incident.risks&&t.incident.risks.sort(SortByProjectCode),t.incidentID=t.incident.id,t.incident.date=new Date(t.incident.date),n.loading=!1,r.go("qrm.incident")})},this.newIncident=function(){t.incidentID=-1,r.go("qrm.incident")},e.getMyCtrlScope=function(){return e},e.incidentReport=function(r){e.reportReqID<0||(QRM.mainController.notify("Assembling Data for Report",5e3),i.getReportIncidentJSON([],e.reportReqID).then(function(e){"OK"==e.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(e.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(t.userEmail),jQuery('input[name="reportID"]').val(2),jQuery("#reportForm").attr("action",e.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}))},this.init()}function IncidentCtrl(e,t,r,i,n,a){var o=this;this.siteUsers=[],e.data={},e.savingincident=!1,t.siteUsers.forEach(function(e){o.siteUsers.push(e.ID)}),e.dropzoneConfig={options:{url:ajaxurl+"?action=uploadFile",previewTemplate:document.querySelector("#preview-template").innerHTML,parallelUploads:1,thumbnailHeight:120,thumbnailWidth:120,maxFilesize:10,filesizeBase:1e3,autoProcessQueue:!1,thumbnail:function(e,t){if(e.previewElement){e.previewElement.classList.remove("dz-file-preview");for(var r=e.previewElement.querySelectorAll("[data-dz-thumbnail]"),i=0;i<r.length;i++){var n=r[i];n.alt=e.name,n.src=t}setTimeout(function(){e.previewElement.classList.add("dz-image-preview")},1)}},init:function(){this.on("addedfile",function(e){o.incidentAttachmentReady(this,e)}),this.on("complete",function(e){e.previewElement.classList.add("dz-complete"),o.cancelAttachment(),n.set("Attachment Added To Incident",{type:"success",duration:1e3,theme:"pure"}),i.getAttachments(o.incident.id).then(function(e){o.incident.attachments=e.data})}),this.on("error",function(e,t,r){e.previewElement.classList.add("dz-complete"),o.cancelAttachment(),n.set(t,{type:"error",duration:1e3,theme:"pure"})})},sending:function(e,r,i){i.append("postID",t.incidentID),i.append("description",o.uploadAttachmentDescription)}}},this.addRisk=function(){if("undefined"==typeof o.incident.risks&&(o.incident.risks=[]),null!=o.risk.id){o.incident.risks.push(o.risk.id);var e=[];jQuery.each(o.incident.risks,function(t,r){-1==jQuery.inArray(r,e)&&null!=r&&e.push(r)}),o.incident.risks=e}o.risk=null},this.removeRisk=function(e){o.incident.risks=jQuery.grep(o.incident.risks,function(t){return t!=e})},this.incidentAttachmentReady=function(t,r){o.dropzone=t,o.dzfile=r,o.disableAttachmentButon=!1,e.$apply()},this.uploadAttachmentDescription="",this.disableAttachmentButon=!0,this.dropzone="",this.uploadAttachment=function(){n.set("File Is Being Uploaded and Imported. Please Standby",{type:"info",sticky:!0,theme:"pure"}),o.dropzone.processFile(o.dzfile)},this.cancelAttachment=function(){o.dropzone.removeAllFiles(!0),o.uploadAttachmentDescription=null,o.disableAttachmentButon=!0,o.dropzone=null,o.dzfile=null,e.$apply()},this.cancelIncident=function(){t.incident=null,t.incidentID=-1,r.go("qrm.incidentExpl")},this.updateIncident=function(){QRM.mainController.titleBar=o.incident.incidentCode,QRM.mainController.titleBarSM=o.incident.incidentCode,null!=o.incident.risks&&o.incident.risks.sort(SortByProjectCode)},this.openDescriptionEditor=function(){var t=o.incident.title,r=o.incident.description;a.openConfirm({template:"editIncidentTitleModalDialogId",className:"ngdialog-theme-default",scope:e}).then(function(e){},function(e){o.incident.title=t,o.incident.description=r})},this.openActionsEditor=function(){var t=o.incident.actions;a.openConfirm({template:"editActionsModalDialogId",className:"ngdialog-theme-default",scope:e}).then(function(e){},function(e){o.incident.actions=t})},this.openLessonsEditor=function(){var t=o.incident.lessons;a.openConfirm({template:"editLessonsModalDialogId",className:"ngdialog-theme-default",scope:e}).then(function(e){},function(e){o.incident.lessons=t})},this.addComment=function(){e.data.comment="",a.openConfirm({template:"addIncidentCommentModalDialogId",className:"ngdialog-theme-default",scope:e}).then(function(r){i.addGeneralComment(e.data.comment,t.incidentID).then(function(e){return e.data.error?void alert(e.data.msg):(n.dismiss(),n.set("Comment Added To Incident",{type:"success",duration:1e3,theme:"pure"}),void(o.incident.comments=e.data))})},function(e){})},this.addCommentSM=function(){i.addGeneralComment(e.data.comment,t.incidentID).then(function(t){return t.data.error?void alert(t.data.msg):(n.dismiss(),n.set("Comment Added To Incident",{type:"success",duration:1e3,theme:"pure"}),o.incident.comments=t.data,void(e.data.comment=""))})},this.saveIncident=function(){e.savingincident=!0,null!=o.incident.risks&&o.incident.risks.sort(SortByProjectCode),i.saveIncident(o.incident).then(function(t){return t.data.error?(e.savingincident=!1,void alert(t.data.msg)):(e.savingincident=!1,n.dismiss(),n.set("Incident Saved",{type:"success",duration:1e3,theme:"pure"}),o.incident=t.data,void o.updateIncident())})},-1==t.incidentID?o.incident={title:"Incident Title",description:"Description of the incident",id:-1,incidentCode:"New Incident",resolved:!1,identified:!1,evaluated:!1,controls:!1,consequences:!1,causes:!1,reportedby:0,lessons:"Enter the lessons learnt as a result of this incident",actions:"Enter a summary of actions taken to resolve the incident",date:new Date}:o.incident=t.incident,e.getMyCtrlScope=function(){return e},e.incidentReport=function(r){e.reportReqID<0||(QRM.mainController.notify("Assembling Data for Report",5e3),i.getReportIncidentJSON([o.incident.id],e.reportReqID).then(function(e){"OK"==e.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(e.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(t.userEmail),jQuery('input[name="reportID"]').val(2),jQuery("#reportForm").attr("action",e.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}))},this.updateIncident()}function ReviewExplCtrl(e,t,r,i){QRM.mainController.titleBarSM="QRM Review Explorer",QRM.mainController.titleBarSM="QRM Review Explorer";var n=this;this.loading=!1,e.formatTreatedCol=function(e,t){return e.entity.complete&&t?!0:e.entity.complete||t?!1:!0},this.getTableHeight=function(){return{height:"calc(100vh - 100px)"}},this.getTableHeightSM=function(){return{height:"calc(100vh - 105px)"}},this.gridOptions={enableSorting:!0,rowTemplate:'<div ng-click="grid.appScope.editReview(row.entity.id)" style="cursor:pointer" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',columnDefs:[{width:"150",cellClass:"compact",field:"reviewCode",headerCellClass:"header-hidden"},{name:"title",width:"*",cellClass:"compact",field:"title"},{name:"Scheduled Date",width:140,field:"scheddate",cellFilter:"date"},{name:"Actual Date",width:140,field:"actualdate",cellFilter:"date"},{name:"Complete",width:70,field:"complete",cellTemplate:'<i style="color:green" ng-show="grid.appScope.formatTreatedCol(row, true)" class="fa fa-check"></i><i  style="color:red" ng-show="grid.appScope.formatTreatedCol(row, false)" class="fa fa-close"></i>',cellClass:"cellCentered"},{name:"Responsible",width:140,field:"responsible",cellFilter:"usernameFilter"}]},this.gridOptionsSM={enableSorting:!0,rowTemplate:'<div ng-click="grid.appScope.editReview(row.entity.id)" style="cursor:pointer" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',columnDefs:[{width:"100",cellClass:"compact",field:"reviewCode",headerCellClass:"header-hidden"},{name:"title",width:"*",cellClass:"compact",field:"title"},{name:"Scheduled Date",width:90,field:"scheddate",cellFilter:"date"}]},e.editReview=function(e){n.editReview(e)},this.editReview=function(e){n.loading=!0,i.getReview(e).then(function(e){t.review=e.data,null!=t.review.risks&&t.review.risks.sort(SortByProjectCode),t.reviewID=t.review.id,t.review.actualdate=new Date(t.review.actualdate),t.review.scheddate=new Date(t.review.scheddate),n.loading=!1,r.go("qrm.review")})},this.newReview=function(){t.reviewID=-1,r.go("qrm.review")},this.init=function(){var e=jQuery(window).innerWidth()-10;jQuery("#container").css("width",e+"px"),QRM.mainController.titleBar="Reviews",QRM.mainController.lookingForReviews(),i.getAllReviews().then(function(e){n.gridOptions.data=e.data,n.gridOptionsSM.data=e.data,n.gridOptions.data.length>0?QRM.mainController.reviewsFound():QRM.mainController.noReviewsFound()})["finally"](function(){n.loading=!1})},e.getMyCtrlScope=function(){return e},e.reviewReport=function(r){e.reportReqID<0||(QRM.mainController.notify("Assembling Data for Report",5e3),i.getReportReviewJSON([],e.reportReqID).then(function(e){"OK"==e.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(e.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(t.userEmail),jQuery('input[name="reportID"]').val(2),jQuery("#reportForm").attr("action",e.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}))},this.init()}function ReviewCtrl(e,t,r,i,n,a){var o=this;this.siteUsers=[],this.sortedParents=t.sortedParents,null==this.sortedParents&&i.getProjects().then(function(e){t.handleGetProjects(e),o.sortedParents=t.sortedParents}),e.data={},e.savingreview=!1,t.siteUsers.forEach(function(e){o.siteUsers.push(e.ID)}),e.dropzoneConfig={options:{url:ajaxurl+"?action=uploadFile",previewTemplate:document.querySelector("#preview-template").innerHTML,parallelUploads:1,thumbnailHeight:120,thumbnailWidth:120,maxFilesize:10,filesizeBase:1e3,autoProcessQueue:!1,thumbnail:function(e,t){if(e.previewElement){e.previewElement.classList.remove("dz-file-preview");for(var r=e.previewElement.querySelectorAll("[data-dz-thumbnail]"),i=0;i<r.length;i++){var n=r[i];n.alt=e.name,n.src=t}setTimeout(function(){e.previewElement.classList.add("dz-image-preview")},1)}},init:function(){this.on("addedfile",function(e){o.reviewAttachmentReady(this,e)}),this.on("complete",function(e){e.previewElement.classList.add("dz-complete"),o.cancelAttachment(),n.set("Attachment Added To Review",{type:"success",duration:1e3,theme:"pure"}),i.getAttachments(o.review.id).then(function(e){o.review.attachments=e.data})}),this.on("error",function(e,t,r){e.previewElement.classList.add("dz-complete"),o.cancelAttachment(),n.set(t,{type:"error",duration:1e3,theme:"pure"})})},sending:function(e,r,i){i.append("postID",t.reviewID),i.append("description",o.uploadAttachmentDescription)}}},this.rowStyle=function(e){return{"margin-left":20*e.$$treeLevel+"px"}},this.addRisk=function(){if("undefined"==typeof o.review.risks&&(o.review.risks=[]),null!=o.risk.id){o.review.risks.push(o.risk.id);var e=[];jQuery.each(o.review.risks,function(t,r){-1==jQuery.inArray(r,e)&&null!=r&&e.push(r)}),o.review.risks=e,o.review.risks.sort(SortByProjectCode)}o.risk=null},this.addProjectRisk=function(){if("undefined"==typeof o.review.risks&&(o.review.risks=[]),null!=o.projectID){t.risks.forEach(function(e){e.projectID==o.projectID&&o.review.risks.push(e.id)});var e=[];jQuery.each(o.review.risks,function(t,r){-1===jQuery.inArray(r,e)&&e.push(r)}),o.review.risks=e,o.review.risks.sort(SortByProjectCode)}o.projectID=null},this.removeRisk=function(e){o.review.risks=jQuery.grep(o.review.risks,function(t){return t!=e}),o.review.riskComments=jQuery.grep(o.review.riskComments,function(t){return t.riskID!=e})},this.reviewAttachmentReady=function(t,r){o.dropzone=t,o.dzfile=r,o.disableAttachmentButon=!1,e.$apply()},this.uploadAttachmentDescription="",this.disableAttachmentButon=!0,this.dropzone="",this.uploadAttachment=function(){n.set("File Is Being Uploaded and Imported. Please Standby",{type:"info",sticky:!0,theme:"pure"}),o.dropzone.processFile(o.dzfile)},this.cancelAttachment=function(){o.dropzone.removeAllFiles(!0),o.uploadAttachmentDescription=null,o.disableAttachmentButon=!0,o.dropzone=null,o.dzfile=null,e.$apply()},this.cancelReview=function(){t.review=null,t.reviewID=-1,r.go("qrm.reviewExpl")},this.updateReview=function(){QRM.mainController.titleBar=o.review.reviewCode,QRM.mainController.titleBarSM=o.review.reviewCode,null!=o.review.risks&&o.review.risks.sort(SortByProjectCode)},this.openDescriptionEditor=function(){var t=o.review.title,r=o.review.description;a.openConfirm({template:"editReviewTitleModalDialogId",className:"ngdialog-theme-default",scope:e}).then(function(e){},function(e){o.review.title=t,o.review.description=r})},this.openNotesEditor=function(){var t=o.review.notes;a.openConfirm({template:"editReviewNotesModalDialogId",className:"ngdialog-theme-default",scope:e}).then(function(e){},function(e){o.review.notes=t})},this.addComment=function(){e.data.comment="",a.openConfirm({template:"addReviewCommentModalDialogId",className:"ngdialog-theme-default",scope:e}).then(function(r){i.addGeneralComment(e.data.comment,t.reviewID).then(function(e){n.dismiss(),n.set("Comment Added TO Review",{type:"success",duration:1e3,theme:"pure"}),o.review.comments=e.data})},function(e){})},this.addCommentSM=function(){i.addGeneralComment(e.data.comment,t.incidentID).then(function(t){return t.data.error?void alert(t.data.msg):(n.dismiss(),n.set("Comment Added To Review",{type:"success",duration:1e3,theme:"pure"}),o.review.comments=t.data,void(e.data.comment=""))})},this.addCommonRiskComment=function(){null==o.review.riskComments&&(o.review.riskComments=[]),o.review.risks.forEach(function(e){var t=jQuery.grep(o.review.riskComments,function(t){return t.riskID==e});if(t.length>0)t[0].comment=t[0].comment+"<p>"+o.commonComment+"</p>";else{var r={riskID:risk.id,comment:"<p>"+o.commonComment+"</p>"};o.review.riskComments.push(r)}}),o.commomComment=null},this.getRiskComment=function(e){if(null!=o.review.riskComments){var t=jQuery.grep(o.review.riskComments,function(t){return t.riskID==e});if(null!=t)return t.length>0?t[0].comment:void 0}},this.riskComment=function(t){null==o.review.riskComments&&(o.review.riskComments=[]);var r=jQuery.grep(o.review.riskComments,function(e){return e.riskID==t});r.length>0?this.rc=r[0]:(this.rc={riskID:t,comment:""},o.review.riskComments.push(this.rc));var i=this.rc.comment;o.riskForComment=t,a.openConfirm({template:"editReviewRiskCommentDialogId",className:"ngdialog-theme-default",scope:e}).then(function(e){console.log(JSON.stringify(o.review))},function(e){this.rc.comment=i})},e.getMyCtrlScope=function(){return e},e.reviewReport=function(r){e.reportReqID<0||(QRM.mainController.notify("Assembling Data for Report",5e3),i.getReportReviewJSON([o.review.id],e.reportReqID).then(function(e){"OK"==e.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(e.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(t.userEmail),jQuery('input[name="reportID"]').val(2),jQuery("#reportForm").attr("action",e.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}))},this.saveReview=function(){e.savingreview=!0,null!=o.review.risks&&o.review.risks.sort(SortByProjectCode),i.saveReview(o.review).then(function(t){return t.data.error?(e.savingreview=!1,void alert(t.data.msg)):(e.savingreview=!1,n.dismiss(),n.set("Review Saved",{type:"success",duration:1e3,theme:"pure"}),o.review=t.data,void o.updateReview())})},-1==t.reviewID?o.review={title:"Review Title",description:"Purpose of the Review",scheddate:new Date,actualdate:new Date,id:-1,reviewCode:"REVIEW-??",responsible:0,notes:"Enter any general notes about the review"}:o.review=t.review,this.updateReview()}function LoginCtrl(e,t){var r=this;this.showError=!1,this.username="",this.pass="",this.login=function(){r.showError=!1,t.login(r.username,r.pass).then(function(t){var i=t.data;1==i.loggedin?i.qrmuser?(r.showError=!1,r.username="",r.pass="",QRM.mainController.init(!0)):e.go("nonQRM"):(r.showError=!0,r.username="",r.pass="")})},this.lostPassword=function(){window.open(lostPasswordURL,"_self")}}var failedConnectCount=0,app=angular.module("qrm");!function(){app.config(["$locationProvider",function(e){e.html5Mode({requireBase:!1,enabled:!0})}]),app.config(["ngDialogProvider",function(e){e.setDefaults({className:"ngdialog-theme-default",plain:!1,showClose:!1,closeByDocument:!1,closeByEscape:!1,appendTo:!1})}]),app.config(["cfpLoadingBarProvider",function(e){e.includeSpinner=!1}]),app.config(["$provide",function(e){e.decorator("taOptions",["taRegisterTool","$delegate",function(e,t){return t.toolbar=[["h1","h2","p"],["bold","italics","underline","strikeThrough","ul","ol","redo"],["justifyRight","indent","outdent"]],t}])}]),app.controller("IntroCtrl",["$scope","QRMDataService","RemoteService","$state","$q","$http",IntroCtrl]),app.controller("QRMCtrl",["QRMDataService",QRMCtrl]),app.controller("NonQRMCtrl",function(){}),app.controller("MainCtrl",["QRMDataService","RemoteService","$state","ngNotify","$http","$q",MainCtrl]),app.controller("ExplorerCtrl",["$scope","QRMDataService","$state","RemoteService","ngDialog","$timeout","$http","uiGridConstants",ExplorerCtrl]),app.controller("RiskCtrl",["$scope","QRMDataService","$state","$timeout","RemoteService","ngNotify","ngDialog","$q",RiskCtrl]),app.controller("CalenderController",["$scope","QRMDataService","$state","RemoteService",CalenderController]),app.controller("RankController",["$scope","QRMDataService","$state","RemoteService","ngNotify",RankController]),app.controller("ReportArchiveController",["$scope","QRMDataService","RemoteService","ngNotify","$http","$state","uiGridConstants",ReportArchiveController]),app.controller("AnalysisController",["$scope","QRMDataService","RemoteService",AnalysisController]),app.controller("RelMatrixController",["$scope","QRMDataService","RemoteService","ngNotify",RelMatrixController]),app.controller("IncidentExplCtrl",["$scope","QRMDataService","$state","RemoteService",IncidentExplCtrl]),app.controller("IncidentCtrl",["$scope","QRMDataService","$state","RemoteService","ngNotify","ngDialog",IncidentCtrl]),app.controller("ReviewExplCtrl",["$scope","QRMDataService","$state","RemoteService",ReviewExplCtrl]),app.controller("ReviewCtrl",["$scope","QRMDataService","$state","RemoteService","ngNotify","ngDialog",ReviewCtrl]),app.controller("LoginCtrl",["$state","RemoteService",LoginCtrl]),app.service("RemoteService",["$http",RemoteService]),app.service("QRMDataService",DataService),app.filter("currencyFilter",function(){return function(e){return"$"+Number(e).toFixed(2).replace(/\d(?=(\d{3})+\.)/g,"$&,")}}),app.filter("percentFilter",function(){return function(e){return Number(e).toFixed(1).replace(/\d(?=(\d{3})+\.)/g,"$&,")+"%"}}),app.filter("nullFilter",function(){return function(e){return"undefined"==typeof e||null==e?"-":e}}),app.filter("usernameFilter",["QRMDataService","RemoteService","$q",function(e,t,r){return function(t){if("object"==typeof t&&(t=t.ID),0>t)return"Not Assigned";if("undefined"!=typeof t){var r=jQuery.grep(e.siteUsers,function(e){return e.ID==t});return"undefined"==typeof r?"Unknown":0==r.length?"Not Found":r.length>1?"Unknown (too many)":r[0].data.display_name}}}]),app.filter("compoundRiskFilter",["QRMDataService",function(e){return function(t){if("object"==typeof t)return t.riskProjectCode+" - "+t.title;var r=jQuery.grep(e.risks,function(e){return e.id==t});return r[0].riskProjectCode+" - "+r[0].title}}]),app.filter("riskCodeFilter",["QRMDataService","RemoteService","$q",function(e,t,r){return function(t){if("object"==typeof t)return t.riskProjectCode;var r=jQuery.grep(e.risks,function(e){return e.id==t});return r[0].riskProjectCode}}]),app.filter("riskTitleFilter",["QRMDataService",function(e){return function(t){if("object"==typeof t)return t.title;var r=jQuery.grep(e.risks,function(e){return e.id==t});return r[0].title}}])}();