function merge_options(obj1,obj2){var obj3={};for(var attrname in obj1)obj3[attrname]=obj1[attrname];for(var attrname in obj2)obj3[attrname]=obj2[attrname];return obj3}function escapeRegExp(string){return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}function replaceAll(find,replace,str){return str.replace(new RegExp(escapeRegExp(find),"g"),replace)}function exportSVG(id){var form=Ext.getBody().createChild({tag:"form",method:"POST",action:"./exportSVGtoPNG",children:[{tag:"input",type:"hidden",name:"svg"}]});form.last(null,!0).value=document.getElementById(id).innerHTML,form.dom.submit(),form.remove()}function matrixFilter(impact,prob,treated,tol){QRM.app.getExplorerController().matrixFilter({DESCENDANTS:$$("cbDescendants").value,PROJECTID:QRM.global.projectID,OPERATION:"getRiskLiteFetch",TREATEDPROB:treated?prob:-1,TREATEDIMPACT:treated?impact:-1,UNTREATEDPROB:treated?-1:prob,UNTREATEDIMPACT:treated?-1:impact,TREATED:treated});var selectedCellSelector="rect.qrmMatElementID"+impact+prob;QRM.global.selectedCellProb=prob,QRM.global.selectedCellImpact=impact,QRM.global.selectedCellTol=tol,QRM.global.selectedCellTreated=treated,selectedCellSelector+=treated?"T":"U",d3.select(selectedCellSelector).attr("class","selectedMatCell")}function getRandomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}function parseDate(input){var parts=input.split(" ")[0].split("-");return new Date(parts[0],parts[1]-1,parts[2])}function Map(){this.keyArray=new Array,this.valArray=new Array,this.put=function(key,val){var elementIndex=this.findIt(key);-1==elementIndex?(this.keyArray.push(key),this.valArray.push(val)):this.valArray[elementIndex]=val},this.get=function(key){var result=null,elementIndex=this.findIt(key);return-1!=elementIndex&&(result=this.valArray[elementIndex]),result},this.remove=function(key){var elementIndex=this.findIt(key);-1!=elementIndex&&(this.keyArray=this.keyArray.removeAt(elementIndex),this.valArray=this.valArray.removeAt(elementIndex))},this.size=function(){return this.keyArray.length},this.clear=function(){for(;this.keyArray.length>0;)this.keyArray.pop(),this.valArray.pop()},this.keySet=function(){return this.keyArray},this.valSet=function(){return this.valArray},this.showMe=function(){for(var result="",i=0;i<this.keyArray.length;i++)result+="Key: "+this.keyArray[i]+"	Values: "+this.valArray[i]+"\n";return result},this.findIt=function(key){for(var result=-1,i=0;i<this.keyArray.length;i++)if(this.keyArray[i]==key){result=i;break}return result},this.removeAt=function(index){var part1=this.slice(0,index),part2=this.slice(index+1);return part1.concat(part2)}}function calcProb(risk,preMit){var days=(new Date(risk.end).getTime()-new Date(risk.start).getTime())/864e5,alpha=0,T=0,type=0;type=preMit?Number(risk.likeType):Number(risk.likePostType);try{if(4==type)return preMit?100*risk.likeProb:100*risk.likePostProb;preMit?(alpha=risk.likeAlpha,T=risk.likeT):(alpha=risk.likePostAlpha,T=risk.likePostT);var alphat=alpha*(days/T),prob=1-Math.exp(-alphat)*(Math.pow(alphat,0)/fact(0));return 100*prob}catch(e){return alert(e.message),-1}}function fact(n){return 0==n?1:n*fact(n-1)}function probFromMatrix(qprob,mat){var lowerLimit=0,upperLimit=0;switch(parseInt(Math.floor(qprob),10)){case 1:lowerLimit=0,upperLimit=mat.probVal1;break;case 2:lowerLimit=mat.probVal1,upperLimit=mat.probVal2;break;case 3:lowerLimit=mat.probVal2,upperLimit=mat.probVal3;break;case 4:lowerLimit=mat.probVal3,upperLimit=mat.probVal4;break;case 5:lowerLimit=mat.probVal4,upperLimit=mat.probVal5;break;case 6:lowerLimit=mat.probVal5,upperLimit=mat.probVal6;break;case 7:lowerLimit=mat.probVal6,upperLimit=mat.probVal7;break;case 8:lowerLimit=mat.probVal7,upperLimit=mat.probVal8}var prob=lowerLimit+(upperLimit-lowerLimit)*(qprob-Math.floor(qprob));return prob}function probToMatrix(prob,mat){var qprob=.5,qOK=!1;return null!=mat.probVal1&&prob>=0&&prob<=mat.probVal1&&mat.maxProb>=1&&(qprob=1+prob/mat.probVal1,qOK=!0),null!=mat.probVal1&&null!=mat.probVal2&&mat.probVal1<prob&&prob<=mat.probVal2&&mat.maxProb>=2&&(qprob=2+(prob-mat.probVal1)/(mat.probVal2-mat.probVal1),qOK=!0),null!=mat.probVal2&&null!=mat.probVal3&&mat.probVal2<prob&&prob<=mat.probVal3&&mat.maxProb>=3&&(qprob=3+(prob-mat.probVal2)/(mat.probVal3-mat.probVal2),qOK=!0),null!=mat.probVal3&&null!=mat.probVal4&&mat.probVal3<prob&&prob<=mat.probVal4&&mat.maxProb>=4&&(qprob=4+(prob-mat.probVal3)/(mat.probVal4-mat.probVal3),qOK=!0),null!=mat.probVal4&&null!=mat.probVal5&&mat.probVal4<prob&&prob<=mat.probVal5&&mat.maxProb>=5&&(qprob=5+(prob-mat.probVal4)/(mat.probVal5-mat.probVal4),qOK=!0),null!=mat.probVal5&&null!=mat.probVal6&&mat.probVal5<prob&&prob<=mat.probVal6&&mat.maxProb>=6&&(qprob=6+(prob-mat.probVal5)/(mat.probVal6-mat.probVal5),qOK=!0),null!=mat.probVal6&&null!=mat.probVal7&&mat.probVal6<prob&&prob<=mat.probVal7&&mat.maxProb>=7&&(qprob=7+(prob-mat.probVal6)/(mat.probVal7-mat.probVal6),qOK=!0),null!=mat.probVal7&&null!=mat.probVal8&&mat.probVal7<prob&&prob<=mat.probVal8&&8==mat.maxProb&&(qprob=8+(prob-mat.probVal7)/(mat.probVal8-mat.probVal7),qOK=!0),qOK||(qprob=mat.maxProb+.999),qprob}function setMatrix(tolString,maxImpact,maxProb,val,svgDivID,treated,clkCallBack){for(var margin={top:0,right:0,bottom:0,left:0},width=180-margin.left-margin.right,height=180-margin.top-margin.bottom,data=new Array,prob=maxProb;prob>0;prob--)for(var impact=1;maxImpact>=impact;impact++){var index=(prob-1)*maxImpact+impact-1,tol=tolString.substring(index,index+1);data.push({impact:impact,prob:prob,tol:tol,val:val[(prob-1)*maxImpact+impact-1],treated:treated})}var gridSizeX=Math.floor(width/maxImpact),gridSizeY=Math.floor(height/maxProb);d3.select(svgDivID+" svg").remove();var svg=d3.select(svgDivID).append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),heatMap=svg.selectAll(".hour").data(data).enter().append("g").attr("class","tolCell").attr("id",function(d){return d.impact+"-"+d.prob});heatMap.append("rect").attr("x",function(d){return(d.impact-1)*gridSizeX}).attr("y",function(d){return(maxProb-d.prob)*gridSizeY}).attr("rx",2).attr("ry",2).attr("class",function(d){var root="tol"+d.tol+" qrmMatElementID"+d.impact+d.prob;return d.treated?root+"T":root+"U"}).attr("width",gridSizeX).attr("height",gridSizeY).on("click",function(d){clkCallBack(d.impact,d.prob,d.treated,d.tol)}),heatMap.append("text").attr("x",function(d){return(d.impact-1)*gridSizeX+gridSizeX/2}).attr("y",function(d){return(maxProb-d.prob)*gridSizeY+gridSizeY/2+5}).attr("class","tolText").attr("pointer-events","none").style("text-anchor","middle").on("click",function(d){clkCallBack(d.impact,d.prob,d.treated,d.tol)}).text(function(d){return d.val>0?d.val:""})}function setConfigMatrix(tolString,maxImpact,maxProb,svgDivID,matrixChangeCB){for(var margin={top:0,right:0,bottom:0,left:0},width=220-margin.left-margin.right,height=220-margin.top-margin.bottom,data=new Array,prob=maxProb;prob>0;prob--)for(var impact=1;maxImpact>=impact;impact++){var index=(prob-1)*maxImpact+impact-1,tol=tolString.substring(index,index+1);data.push({impact:impact,prob:prob,tol:tol})}var gridSizeX=Math.floor(width/maxImpact),gridSizeY=Math.floor(height/maxProb);d3.select(svgDivID+" svg").remove();var svg=d3.select(svgDivID).append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),heatMap=svg.selectAll(".hour").data(data).enter().append("g").attr("class","tolCell").attr("id",function(d){return d.id=d.impact+"-"+d.prob,d.impact+"-"+d.prob});heatMap.append("rect").attr("x",function(d){return(d.impact-1)*gridSizeX}).attr("y",function(d){return(maxProb-d.prob)*gridSizeY}).attr("rx",2).attr("ry",2).attr("qrmID",function(d){return String(d.impact)+String(d.prob)}).attr("class",function(d){return"tolc"+d.tol}).attr("width",gridSizeX).attr("height",gridSizeY).on("click",function(d){var e=jQuery(this);return hasClassSVG(e,"tolc5","tolc1")?void matrixChangeCB():hasClassSVG(e,"tolc4","tolc5")?void matrixChangeCB():hasClassSVG(e,"tolc3","tolc4")?void matrixChangeCB():hasClassSVG(e,"tolc2","tolc3")?void matrixChangeCB():hasClassSVG(e,"tolc1","tolc2")?void matrixChangeCB():hasClassSVG(e,"tolc","tolc5")?void matrixChangeCB():void matrixChangeCB()}),svg.append("text").attr("text-anchor","middle").style("font-size","12px").style("font-weight","normal").attr("transform","translate("+[8,gridSizeY*(maxProb-1)+12]+")").text("P1"),svg.append("text").attr("text-anchor","middle").style("font-size","12px").style("font-weight","normal").attr("transform","translate("+[8,gridSizeY*(maxProb-2)+12]+")").text("P2"),maxProb>2&&svg.append("text").attr("text-anchor","middle").style("font-size","12px").style("font-weight","normal").attr("transform","translate("+[8,gridSizeY*(maxProb-3)+12]+")").text("P3"),maxProb>3&&svg.append("text").attr("text-anchor","middle").style("font-size","12px").style("font-weight","normal").attr("transform","translate("+[8,gridSizeY*(maxProb-4)+12]+")").text("P4"),maxProb>4&&svg.append("text").attr("text-anchor","middle").style("font-size","12px").style("font-weight","normal").attr("transform","translate("+[8,gridSizeY*(maxProb-5)+12]+")").text("P5"),maxProb>5&&svg.append("text").attr("text-anchor","middle").style("font-size","12px").style("font-weight","normal").attr("transform","translate("+[8,gridSizeY*(maxProb-6)+12]+")").text("P6"),maxProb>6&&svg.append("text").attr("text-anchor","middle").style("font-size","12px").style("font-weight","normal").attr("transform","translate("+[8,gridSizeY*(maxProb-7)+12]+")").text("P7"),maxProb>7&&svg.append("text").attr("text-anchor","middle").style("font-size","12px").style("font-weight","normal").attr("transform","translate("+[8,gridSizeY*(maxProb-8)+12]+")").text("P8")}function hasClassSVG(tmp,oldClass,newClass){for(var rclass=/[\t\r\n\f]/g,className=" "+oldClass+" ",i=0,l=tmp.length;l>i;i++)if(1===tmp[i].nodeType&&(" "+tmp[i].className.baseVal+" ").replace(rclass," ").indexOf(className)>=0)return tmp[i].className.baseVal=newClass,!0;return!1}function resetSelectedCell(){var resetClassName="tol"+QRM.global.selectedCellTol+" qrmMatElementID"+QRM.global.selectedCellImpact+QRM.global.selectedCellProb;resetClassName+=QRM.global.selectedCellTreated?"T":"U",d3.select("rect.selectedMatCell").attr("class",resetClassName)}function preInit(){d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},Array.prototype.clear=function(){this.length=0},Array.prototype.findAll=function(field,value){var subArray=new Array;return Ext.Array.each(this,function(item){item.field==value&&subArray.push(item)}),subArray},Array.prototype.getProperty=function(field){return res=new Array,Ext.Array.each(this,function(item){res.push(item[field])}),res},Array.prototype.getDataProperty=function(field){return res=new Array,Ext.Array.each(this,function(item){res.push(item.data[field])}),res},BrowserDetect.init()}function setRiskEditorMatrix(risk,matrixConfig,matrixDIVID,matrixDisplayConfig,dragStartCallback,dragCallback,dragEndCallback){for(var radius=matrixDisplayConfig.radius,tolString=matrixConfig.tolString,maxImpact=matrixConfig.maxImpact,maxProb=matrixConfig.maxProb,margin={top:radius,right:radius,bottom:2*radius,left:2*radius},width=matrixDisplayConfig.width-2*radius,height=width,data=new Array,prob=maxProb;prob>0;prob--)for(var impact=1;maxImpact>=impact;impact++){var index=(prob-1)*maxImpact+impact-1,tol=tolString.substring(index,index+1);data.push({impact:impact,prob:prob,tol:tol})}var gridSizeX=Math.floor(width/maxImpact),gridSizeY=Math.floor(height/maxProb);d3.selectAll("#"+matrixDIVID+" svg").remove();var topSVG=d3.select("#"+matrixDIVID).append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom);topSVG.append("defs").append("style").attr("type","text/css").text("rect.tolNoHover5 {fill: #ed5565;stroke: #E6E6E6;stroke-width: 2px; }rect.tolNoHover4 {fill: #f8ac59;stroke: #E6E6E6;stroke-width: 2px; }rect.tolNoHover3 {fill: #ffff55;stroke: #E6E6E6;stroke-width: 2px; }rect.tolNoHover2 {fill: #1ab394;stroke: #E6E6E6;stroke-width: 2px; }rect.tolNoHover1 {fill: #1c84c6; stroke: #E6E6E6; stroke-width: 2px; }g.riskEditorRiskUntreated text.untreated { fill:red; font: 12px sans-serif; font-weight : bold; pointer-events : none; }g.riskEditorRiskTreated text.treated { fill:blue; font: 12px sans-serif; font-weight : bold; pointer-events : none; }");var svg=topSVG.append("g").attr("class","riskEditorMatrixHolder").attr("transform","translate("+margin.left+","+margin.top+") "),heatMap=svg.selectAll().data(data).enter().append("g").attr("class","tolCellNoHover");heatMap.append("rect").attr("x",function(d){return(d.impact-1)*gridSizeX}).attr("y",function(d){return(maxProb-d.prob)*gridSizeY}).attr("rx",2).attr("ry",2).attr("class",function(d){return"tolNoHover"+d.tol}).attr("width",gridSizeX).attr("height",gridSizeY);var drag=d3.behavior.drag().on("dragstart",function(){dragStartCallback()}).on("drag",function(){d3.select(this).attr("transform",function(d,i){var node=d3.select(this),treated="true"==node.attr("treated");return treated?(d.x1+=d3.event.dx,d.y1+=d3.event.dy,d.x1<0&&(d.x1=0),d.y1<0&&(d.y1=0),d.x1>width&&(d.x1=width),d.y1>height&&(d.y1=height),d.treatedImpact=1+d.x1/gridSizeX,d.treatedProb=maxProb+1-d.y1/gridSizeX,dragCallback({impact:d.treatedImpact,prob:d.treatedProb,treated:!0}),"translate("+[d.x1,d.y1]+")"):(d.x+=d3.event.dx,d.y+=d3.event.dy,d.x<0&&(d.x=0),d.y<0&&(d.y=0),d.x>width&&(d.x=width),d.y>height&&(d.y=height),d.inherentImpact=1+d.x/gridSizeX,d.inherentProb=maxProb+1-d.y/gridSizeX,dragCallback({impact:d.inherentImpact,prob:d.inherentProb,treated:!1}),"translate("+[d.x,d.y]+")")})}).on("dragend",function(d){d.dirty=!0;var node=d3.select(this),treated="true"==node.attr("treated");treated?(d.treatedImpact=1+d.x1/gridSizeX,d.treatedProb=maxProb+1-d.y1/gridSizeX,dragEndCallback({impact:d.treatedImpact.toFixed(2),prob:d.treatedProb.toFixed(2),treated:!0})):(d.inherentImpact=1+d.x/gridSizeX,d.inherentProb=maxProb+1-d.y/gridSizeX,dragEndCallback({impact:d.inherentImpact.toFixed(2),prob:d.inherentProb.toFixed(2),treated:!1}))}),Xn=(risk.inherentImpact-1)/maxImpact,Yn=(risk.inherentProb-1)/maxProb;risk.x=Xn*width,risk.y=(1-Yn)*height;var Xn1=(risk.treatedImpact-1)/maxImpact,Yn1=(risk.treatedProb-1)/maxProb;risk.x1=Xn1*width,risk.y1=(1-Yn1)*height;var untreatedRisk=svg.selectAll().data([risk]).enter().append("g").style("cursor","move").attr("transform","translate("+[risk.x,risk.y]+")").attr("treated",!1).attr("class","riskEditorRiskUntreated").call(drag);untreatedRisk.append("circle").style("fill","white").attr({r:radius}),untreatedRisk.append("circle").style("fill","red").attr({r:radius-2}),untreatedRisk.append("circle").style("fill","white").attr({r:radius-4}),untreatedRisk.append("text").attr({"text-anchor":"middle",y:4}).attr("class","untreated").style("font-size","8px").text(function(d){return d.riskProjectCode});var treatedRisk=svg.selectAll().data([risk]).enter().append("g").style("cursor","move").attr("transform","translate("+[risk.x1,risk.y1]+")").attr("treated",!0).attr("class","riskEditorRiskTreated").call(drag);treatedRisk.append("circle").style("fill","white").attr({r:radius}),treatedRisk.append("circle").style("fill","blue").attr({r:radius-2}),treatedRisk.append("circle").style("fill","white").attr({r:radius-4}),treatedRisk.append("text").attr({"text-anchor":"middle",y:4}).attr("class","treated").style("font-size","8px").text(function(d){return d.riskProjectCode}),svg.append("text").attr("text-anchor","middle").style("font-size","14px").style("font-weight","normal").attr("transform","translate("+[-10,height/2]+") rotate(-90)").text("Probability"),svg.append("text").attr("text-anchor","middle").style("font-size","14px").style("font-weight","normal").attr("transform","translate("+[width/2,height+20]+")").text("Impact")}function getProjectStakeholders(p){var s=[];try{p.riskOwners.forEach(function(e){s.push(e)}),p.riskManagers.forEach(function(e){s.push(e)})}catch(e){console.log(e.message)}for(var arr={},i=0;i<s.length;i++)arr[s[i].email]=s[i];var temp=new Array;for(var key in arr)temp.push(arr[key]);return temp}function minimiseSideBar(state){jQuery("body").hasClass("mini-navbar")||jQuery("body").addClass("mini-navbar"),!jQuery("body").hasClass("mini-navbar")||jQuery("body").hasClass("body-small")?(jQuery("#side-menu").hide(),setTimeout(function(){jQuery("#side-menu").fadeIn(500)},100)):jQuery("body").hasClass("fixed-sidebar")?(jQuery("#side-menu").hide(),setTimeout(function(){jQuery("#side-menu").fadeIn(500)},300)):jQuery("#side-menu").removeAttr("style"),setTimeout(function(){jQuery(window).trigger("resize")},250)}function SorterLayout(rankCtl,$scope){this.height=500,this.width=500,this.itemWidth=500,this.items=null,this.transMatrix=[1,0,0,1,20,30],this.svgDiv=null,this.itemHeight=25,this.minItemHeight=20,this.minItemWidth=120,this.topSVG=null,this.svgDiv=null,this.numItemsPerColumn=0,this.numColumns=0,this.lastColumn=0,this.lastRow=0,this.minScaleFactor=.75;var layout=this;this.drag=d3.behavior.drag().on("dragstart",function(d){var e=d3.event.sourceEvent;if(!e.ctrlKey){var x=d.tx+5,y=d.ty+5;d3.select("#rankGroupHolder").append("use").attr("xlink:href","#ghostDef").attr("tx",x).attr("ty",y).attr("totTy",d.totTy).attr("transform","translate("+x+", "+y+")").attr("id","sorterGhost"),d3.select("#rankGroupHolder").append("use").attr("xlink:href","#insertionMarkerDef").attr("ty",y).attr("tx",x).attr("transform","translate("+x+", "+y+")").attr("id","insertionMarker").style("display","none"),this.parentNode.appendChild(this)}}).on("drag",function(){layout.notifyDirtyListeners(),this.parentNode.appendChild(this);var yOffset=Math.floor(d3.event.y/layout.itemHeight)*layout.itemHeight,posnX=Math.max(d3.event.x,0);posnX=Math.min(posnX,layout.lastColumn*layout.itemWidth);var posnY=Math.max(d3.event.y,-layout.itemHeight);posnY=Math.min(posnY,layout.itemHeight*layout.numItemsPerColumn),d3.select(this).attr("transform",function(d,i){return"translate("+[posnX,posnY]+")"});var y=yOffset+(layout.itemHeight-7);y=Math.min(y,layout.itemHeight*layout.numItemsPerColumn-7);var col=Math.floor(posnX/layout.itemWidth),x=col*layout.itemWidth;col==layout.lastColumn&&(y=Math.min(y,layout.itemHeight*layout.lastRow-7)),y=Math.max(y,-7);var totTy=col*layout.numItemsPerColumn*layout.itemHeight+y;d3.select("#insertionMarker").attr("transform",function(d,i){return"translate("+[x,y]+")"}).attr("totTy",totTy).attr("ty",y).attr("tx",x).style("display","inline")}).on("dragend",function(d){var ghost=d3.select("#sorterGhost"),marker=d3.select("#insertionMarker"),ghostTotY=Number(ghost.attr("totTy")),markerTotY=Number(marker.attr("totTy"));if(ghostTotY==markerTotY||ghostTotY==markerTotY+layout.itemHeight){var node=d3.select(this);return node.attr("transform",function(){return"translate("+[Number(node.attr("tx")),Number(node.attr("ty"))]+")"}),ghost.remove(),void marker.remove()}var moveUp=ghostTotY>markerTotY,nodes=d3.select("#rankGroupHolder").selectAll("g.risk");moveUp?nodes.filter(function(d2,i){return d2.totTy<ghostTotY&&d2.totTy>markerTotY}).each(function(d2,i){layout.calcNewPosition(d2,moveUp),layout.repositionNode(this,d2,moveUp)}):nodes.filter(function(d2,i){return d2.totTy>ghostTotY&&d2.totTy<=markerTotY}).each(function(d2,i){layout.calcNewPosition(d2,moveUp),layout.repositionNode(this,d2,moveUp)}),layout.positionDropNode(this,d,marker,moveUp),ghost.remove(),marker.remove()}).origin(function(d){var bbox=this.getBBox(),ctm=this.getCTM();return{x:bbox.x+ctm.e/ctm.a-layout.transMatrix[4]/layout.transMatrix[0],y:bbox.y+ctm.f/ctm.d-layout.transMatrix[5]/layout.transMatrix[3]}}),this.setHeight=function(h){this.height=h},this.setWidth=function(w){this.width=w},this.setItems=function(i){this.items=i},this.sortItems=function(){this.items.sort(function(a,b){return a.rank&&b.rank?Number(a.rank)-Number(b.rank):Number(b.currentTolerance)-a.currentTolerance})},this.scale=function(x,y){this.transMatrix[0]=x,this.transMatrix[3]=y},this.translate=function(x,y){this.transMatrix[4]=x,this.transMatrix[5]=y},this.normaliseRanks=function(){this.items.sort(function(a,b){return null!=a.totTy&&null!=b.totTy?a.totTy-b.totTy:a.rank-b.rank});var rank=0;this.items.forEach(function(item){item.rank=Number(rank++)})},this.notifyDirtyListeners=function(){null!=this.dirtyListener&&this.dirtyListener()},this.setDirtyListener=function(fn){this.dirtyListener=fn},this.setSVGDiv=function(div){this.svgDiv="#"+div},this.setItemHeight=function(h){this.itemHeight=Math.max(h,this.minItemHeight)},this.setItemWidth=function(w){this.itemWidth=Math.max(w,this.minItemWidth)},this.positionDropNode=function(element,data,marker,moveUp){var dropNode=d3.select(element),markerTotY=Number(marker.attr("totTy"));data.totTy=markerTotY,data.tx=Number(marker.attr("tx")),data.ty=Number(marker.attr("ty"))+7,moveUp?(data.totTy=data.totTy+this.itemHeight,data.ty>(layout.numItemsPerColumn-1)*layout.itemHeight&&(data.ty=0,data.tx=data.tx+layout.itemWidth)):(data.ty=data.ty-this.itemHeight,data.ty<0&&(data.ty=(layout.numItemsPerColumn-1)*layout.itemHeight,data.tx=data.tx-layout.itemWidth)),dropNode.transition().attr("transform","translate("+[data.tx,data.ty]+")")},this.calcNewPosition=function(item,moveUp){moveUp?(item.totTy=item.totTy+layout.itemHeight,item.ty=item.ty+layout.itemHeight,item.ty>(layout.numItemsPerColumn-1)*layout.itemHeight&&(item.ty=0,item.tx=item.tx+layout.itemWidth)):(item.totTy=item.totTy-layout.itemHeight,item.ty=item.ty-layout.itemHeight,item.ty<0&&(item.ty=(layout.numItemsPerColumn-1)*layout.itemHeight,item.tx=item.tx-layout.itemWidth))},this.repositionNode=function(element,data,moveUp){d3.select(element).transition().attr("transform",function(){return"translate("+[data.tx,data.ty]+")"})},this.preLayout=function(){var numItems=this.items.length,totalItemHeight=(numItems+1.5)*this.itemHeight,colNum=1,scaleFactor=0;this.sortItems();do{var columnHeight=totalItemHeight/colNum;scaleFactor=this.height/columnHeight,colNum++}while(scaleFactor<this.minScaleFactor);this.scale(1,Math.min(1,scaleFactor)),this.layoutHeight=this.height/this.transMatrix[3]-1.5*this.itemHeight/this.transMatrix[3],this.numItemsPerColumn=Math.floor(this.layoutHeight/this.itemHeight),colNum=Math.ceil(numItems/this.numItemsPerColumn),this.setItemWidth((this.width-10-this.transMatrix[4])/colNum)},this.layoutTable=function(){this.preLayout(),d3.select(this.svgDiv+" svg").remove(),this.topSVG=d3.select(this.svgDiv).append("svg").attr("width",this.width).attr("height",this.height),this.createDefinitions(),this.topSVG.append("text").attr("text-anchor","middle").style("font-size","20px").style("fill","rgb(103,106,108)").style("font-weight","normal").attr("transform","translate("+[this.width/2,20]+")").text(rankCtl.project.title),this.svg=this.topSVG.append("g").attr("id","rankGroupHolder").attr("h",this.height).attr("transform","matrix("+this.transMatrix.join(" ")+")");var me=this,rowNum=0,colNum=0;this.items.forEach(function(item){item.ty=rowNum*me.itemHeight,item.tx=colNum*me.itemWidth,item.totTy=item.ty+colNum*me.itemHeight*me.numItemsPerColumn,rowNum++,rowNum==me.numItemsPerColumn&&(colNum++,rowNum=0)}),this.lastColumn=colNum,this.lastRow=rowNum;var nodes=this.svg.selectAll("g.state").data(this.items),risk=nodes.enter().append("g").attr("class","risk").attr("id",function(d){return d.riskCode}).attr("tx",function(d){return d.tx}).attr("colY",function(d){return d.colY}).attr("transform",function(d,i){return"translate("+d.tx+", "+d.ty+")"}).attr("ty",function(d,i){return d.ty}).on("mouseover",function(d){rankCtl.showDesc=!0,rankCtl.showInstructions=!1,rankCtl.displayRisk=d,$scope.$apply()}).on("mouseout",function(d){rankCtl.showDesc=!1,$scope.$apply()}).on("click",function(d){var e=d3.event;e.ctrlKey&&(d3.event.defaultPrevented||(rankCtl.dirty?msg("Open Risk","Please save or cancel existing changes before opening the risk"):rankCtl.editRisk(d.id)))}).call(this.drag);risk.append("rect").attr("width",this.itemWidth-10).attr("height",this.itemHeight-5).attr("fill","lightgray").style("stroke","gray").attr("class","tolText").on("mouseover",function(d){rankCtl.showDesc=!0,rankCtl.showInstructions=!1,rankCtl.displayRisk=d,$scope.$apply()}).on("mouseout",function(d){rankCtl.showDesc=!1,$scope.$apply()}).attr("transform","translate(5,5)"),risk.append("rect").attr("width","70").attr("height",this.itemHeight-8).attr("class",function(d){var tol=null;return tol=d.treated?d.treatedTolerance:d.inherentTolerance,"tol"+tol}).style("stroke","gray").on("mouseover",function(d){rankCtl.showInstructions=!1,rankCtl.showDesc=!0,rankCtl.displayRisk=d,$scope.$apply()}).on("mouseout",function(d){rankCtl.showDesc=!1,$scope.$apply()}).attr("transform","translate(7,7)"),risk.append("text").style("pointer-events","none").attr("transform","translate(10,25)").text(function(d){return d.riskProjectCode});var textGroup=risk.append("g").attr("transform","translate(80,25)");textGroup.append("clipPath").attr("id",function(d){return"clipPath"+d.riskProjectCode}).append("rect").attr("transform","translate(0,-20)").attr("width",this.itemWidth-90).attr("height",this.itemHeight),textGroup.append("text").style("pointer-events","none").attr("clip-path",function(d){return"url(#clipPath"+d.riskProjectCode+")"}).text(function(d){return d.title})},this.createDefinitions=function(){var def=this.topSVG.append("defs");def.append("style").attr("type","text/css").text(".compass{fill: #fff; stroke: #000;stroke-width:   1.5; }.button{ fill: #225EA8; stroke: #0C2C84; stroke-miterlimit: 6; stroke-linecap:  round; }.button:hover{ stroke-width: 2; }.plus-minus{ fill: #fff; pointer-events: none; }g.risk {cursor:move }.marker {stroke-width: 4px; stroke-dasharray: 4px; stroke:red}.markervert {stroke-width: 4px; stroke:red}rect.subRankText {fill: lighrgray ;stroke: gray;}rect.subRankText:hover {fill: #157fcc ;stroke: gray;}rect.tol5 {fill: #ed5565;stroke: #E6E6E6;stroke-width: 2px; }rect.tol4 {fill: #f8ac59;stroke: #E6E6E6;stroke-width: 2px; }rect.tol3 {fill: #ffff55;stroke: #E6E6E6;stroke-width: 2px; }rect.tol2 {fill: #1ab394;stroke: #E6E6E6;stroke-width: 2px; }rect.tol1 {fill: #1c84c6; stroke: #E6E6E6; stroke-width: 2px; }g.risk text { font: 12px sans-serif; font-weight : normal; pointer-events : none; }g.state text.treated { fill:blue; font: 12px sans-serif; font-weight : bold; pointer-events : none; }");var marker=def.append("g").attr("id","insertionMarkerDef");marker.append("line").attr("x1","1").attr("y1","0").attr("x2","1").attr("y2","19").attr("class","markervert"),marker.append("line").attr("x1",this.itemWidth-4).attr("y1","0").attr("x2",this.itemWidth-4).attr("y2","19").attr("class","markervert"),marker.append("line").attr("x1","1").attr("y1","9").attr("x2",this.itemWidth-4).attr("y2","9").attr("class","marker"),def.append("g").attr("id","ghostDef").append("rect").attr("width",this.itemWidth-10).attr("height",this.itemHeight-5).style("stroke","gray").style("fill","transparent").style("stroke-dasharray","4px"),def.append("clipPath").attr("id","rankTextClipPath").append("rect").attr("width",this.itemWidth-10).attr("height",this.itemHeight-5).attr("transform","translate(5,5)")}}function parentSort(projArr){projArr.forEach(function(e){e.$$treeLevel=-100});var sortedArray=jQuery.grep(projArr,function(value){return value.parent_id<=0});for(sortedArray.forEach(function(e){e.$$treeLevel=0}),projArr=jQuery.grep(projArr,function(value){return value.$$treeLevel<0});projArr.length>0;){for(j=0;j<projArr.length;j++){for(var child=projArr[j],found=!1,i=0;i<sortedArray.length;i++){var parent=sortedArray[i];if(child.parent_id==parent.id){child.$$treeLevel=parent.$$treeLevel+1,sortedArray.splice(i+1,0,child),found=!0;break}}if(found)break}projArr=jQuery.grep(projArr,function(value){return value.$$treeLevel<0})}return sortedArray}function objectiveSort(objArr){objArr.forEach(function(e){e.$$treeLevel=-100});var sortedArray=jQuery.grep(objArr,function(value){var tmp=jQuery.grep(objArr,function(p){return p.id==value.parentID});return 0==tmp.length});for(sortedArray.forEach(function(e){e.$$treeLevel=0}),objArr=jQuery.grep(objArr,function(value){return value.$$treeLevel<0});objArr.length>0;){for(j=0;j<objArr.length;j++){for(var child=objArr[j],found=!1,i=0;i<sortedArray.length;i++){var parent=sortedArray[i];if(child.parentID==parent.id){child.$$treeLevel=parent.$$treeLevel+1,sortedArray.splice(i+1,0,child),found=!0;break}}if(found)break}objArr=jQuery.grep(objArr,function(value){return value.$$treeLevel<0})}return sortedArray}function getProjectParents(projMap,projectID){var proj=projMap.get(projectID);if(null==proj)return new Array;var parentID=proj.parent_id;if(retn=new Array,projMap.findIt(parentID)>-1){var tmp=projMap.get(parentID);return retn.push(tmp),retn.concat(getProjectParents(projMap,parentID))}return retn}function getLinearObjectives(projMap,projectID){var obj=new Array,proj=projMap.get(projectID);return null==proj?obj:(obj=obj.concat(proj.objectives),getProjectParents(projMap,projectID).forEach(function(p){p.id!=projectID&&(obj=obj.concat(p.objectives))}),obj)}function getFamilyCats(projMap,projectID){var cat=new Array,proj=projMap.get(projectID);return null==proj?cat:(cat=cat.concat(proj.categories),getProjectParents(projMap,projectID).forEach(function(p){p.id!=projectID&&(cat=cat.concat(p.categories))}),cat)}function closeMenu(){jQuery("#header_container").removeClass("sideMenuOpen"),jQuery("#footer_container").removeClass("sideMenuOpen"),jQuery("#cbp-spmenu-s1").removeClass("cbp-spmenu-open"),jQuery("body").removeClass("cbp-spmenu-push-toright"),QRM.mainController.sideOpen=!1}function openMenu(){jQuery("#header_container").addClass("sideMenuOpen"),jQuery("#footer_container").addClass("sideMenuOpen"),jQuery("#cbp-spmenu-s1").addClass("cbp-spmenu-open"),jQuery("body").addClass("cbp-spmenu-push-toright"),jQuery("#qrm-title").addClass("hidden-qrm"),jQuery("#welcome-name").addClass("hidden-qrm"),jQuery("#qrm-titleSM").removeClass("hidden-qrm")}function toggleMenu(){jQuery("#header_container").toggleClass("sideMenuOpen"),jQuery("#footer_container").toggleClass("sideMenuOpen"),jQuery("#cbp-spmenu-s1").toggleClass("cbp-spmenu-open"),jQuery("body").toggleClass("cbp-spmenu-push-toright"),jQuery("#cbp-spmenu-s1").hasClass("cbp-spmenu-open")?(jQuery("#qrm-title").removeClass("hidden-qrm"),jQuery("#qrm-subtitle").removeClass("hidden-qrm"),jQuery("#welcome-name").removeClass("hidden-qrm"),jQuery("#qrm-titleSM").addClass("hidden-qrm")):(jQuery("#qrm-subtitle").addClass("hidden-qrm"),jQuery("#qrm-title").addClass("hidden-qrm"),jQuery("#welcome-name").addClass("hidden-qrm"),jQuery("#qrm-titleSM").removeClass("hidden-qrm"))}function initData(QRMDataService,remoteService,$q){var intro={};return a=remoteService.getSiteUsers().then(function(response){"0"==response.data||"-1"==response.data?intro.sessionOK=!1:(intro.sessionOK=!0,QRMDataService.siteUsers=response.data)}),b=remoteService.getCurrentUser().then(function(response){"0"==response.data||"-1"==response.data?intro.sessionOK=!1:(intro.sessionOK=!0,QRMDataService.currentUser=response.data,QRM.mainController.userName=QRMDataService.currentUser.data.display_name)}),c=remoteService.getAllRisks().then(function(response){"0"==response.data||"-1"==response.data?intro.sessionOK=!1:(intro.sessionOK=!0,QRM.mainController.risks=response.data,QRM.mainController.risks=jQuery.grep(QRM.mainController.risks,function(value){return null==value.riskProjectCode?!1:null!=value}),QRM.mainController.risks.sort(SortByProjectCode),QRMDataService.risks=QRM.mainController.risks)}),d=remoteService.getProjects().then(function(response){"0"==response.data||"-1"==response.data?intro.sessionOK=!1:(intro.sessionOK=!0,QRMDataService.handleGetProjects(response))}),$q.all([a,b,c,d])}function DataService(){var ds=this;this.matrixDisplayConfig={width:200,height:200,
radius:15},this.selectProject=function(projectID){this.projectObjectives=objectiveSort(getLinearObjectives(this.projMap,projectID)),this.catData=getFamilyCats(this.projMap,projectID),this.project=this.projMap.get(projectID)},this.handleGetProjects=function(response){this.projectsLinear=[],this.sortedParents=[],this.projMap=new Map,0!=response.data.length&&(this.projectsLinear=response.data,this.sortedParents=parentSort(response.data),this.projMap=new Map,this.projectsLinear.forEach(function(e){ds.projMap.put(e.id,e)}))},this.project={id:-1,matrix:{maxProb:5,maxImpact:5,tolString:"1123312234223443345534455"}},this.getTemplateRisk=function(){return{title:"Title of Risk",riskProjectCode:" New Risk ",description:"Description",cause:"Cause",consequence:"Consequence",owner:-1,manager:-1,inherentProb:5.5,inherentImpact:5.5,treatedProb:1.5,treatedImpact:1.5,impRep:!0,impSafety:!0,impEnviron:!0,impCost:!0,impTime:!0,impSpec:!0,treatAvoid:!0,treatRetention:!0,treatTransfer:!0,treatMinimise:!0,treated:!1,summaryRisk:!1,useCalContingency:!1,useCalProb:!1,likeType:4,likeAlpha:1,likeT:365,likePostType:4,likePostAlpha:1,likePostT:365,estContingency:0,start:moment(),end:moment().add(1,"month"),primcat:0,seccat:0,mitigation:{mitPlanSummary:"Summary of the Mitigation Plan",mitPlanSummaryUpdate:"Update to the Summary of the Mitigation Plan",mitPlan:[]},response:{respPlanSummary:"Summary of the Response Plan",respPlanSummaryUpdate:"Update to the Summary of the Mitigation Plan",respPlan:[]},controls:[],objectives:{}}},this.analyseRisks=function(){var map=this.getAnalysisMap(),userMap=new Map;this.siteUsers.forEach(function(u){userMap.put(u.data.ID,{id:u.data.ID,ownCount:0,manCount:0})}),userMap.put("",{id:"",ownCount:0,manCount:0});var now=moment();this.projectRisks.forEach(function(r){var tol=r.currentTolerance,own=jQuery.grep(map.get("RiskOwner").get(tol).values,function(o){return Number(o.id)==Number(r.owner)});own[0].value=own[0].value+1,userMap.get(r.owner).ownCount++;var man=jQuery.grep(map.get("RiskManager").get(tol).values,function(o){return Number(o.id)==Number(r.manager)});man[0].value=man[0].value+1,userMap.get(r.manager).manCount++;var cat=jQuery.grep(map.get("Categories").get(tol).values,function(o){var c="undefined"==typeof r.primcat.title?"Unassigned":r.primcat.title;return o.label==c});0==cat.length?map.get("Categories").get(tol).values.push({label:r.primcat.title,value:1}):cat[0].value=cat[0].value+1;var endDiff=now.diff(moment(r.end)),startDiff=now.diff(moment(r.start)),status=0;endDiff>0&&(status=-1),0>startDiff&&(status=1),startDiff>0&&0>endDiff&&(status=0);var status=jQuery.grep(map.get("Status").get(tol).values,function(o){return Number(o.state)==Number(status)});status[0].value=status[0].value+1}),this.categories=map.get("Categories").valArray;var countArray=userMap.valArray;countArray.sort(function(a,b){return Number(b.ownCount)-Number(a.ownCount)});for(var i=5;i>0;i--){var sortOwn=new Array,arr=map.get("RiskOwner").get(i).values;countArray.forEach(function(a){var item=jQuery.grep(arr,function(b){return Number(b.id)==Number(a.id)});item.length>0&&(sortOwn.push(item[0]),map.get("RiskOwner").get(i).values=sortOwn)})}this.owners=map.get("RiskOwner").valArray,countArray.sort(function(a,b){return Number(b.manCount)-Number(a.manCount)});for(var i=5;i>0;i--){var manOwn=new Array,arr=map.get("RiskManager").get(i).values;countArray.forEach(function(a){var item=jQuery.grep(arr,function(b){return Number(b.id)==Number(a.id)});item.length>0&&(manOwn.push(item[0]),map.get("RiskManager").get(i).values=manOwn)})}this.managers=map.get("RiskManager").valArray,this.status=map.get("Status").valArray},this.getAnalysisMap=function(){var map=new Map;map.put("RiskOwner",new Map);var ownMap=map.get("RiskOwner");ownMap.put(5,{key:"Extreme",color:"#ed5565",values:new Array}),ownMap.put(4,{key:"High",color:"#f8ac59",values:new Array}),ownMap.put(3,{key:"Significant",color:"#ffff55",values:new Array}),ownMap.put(2,{key:"Moderate",color:"#1ab394",values:new Array}),ownMap.put(1,{key:"Low",color:"#1c84c6",values:new Array}),map.put("RiskManager",new Map);var manMap=map.get("RiskManager");manMap.put(5,{key:"Extreme",color:"#ed5565",values:new Array}),manMap.put(4,{key:"High",color:"#f8ac59",values:new Array}),manMap.put(3,{key:"Significant",color:"#ffff55",values:new Array}),manMap.put(2,{key:"Moderate",color:"#1ab394",values:new Array}),manMap.put(1,{key:"Low",color:"#1c84c6",values:new Array}),this.siteUsers.forEach(function(u){for(var i=5;i>0;i--)(jQuery.inArray(u.ID,ds.project.ownersID)>-1||u.ID==ds.project.projectRiskManager)&&ownMap.get(i).values.push({label:u.data.display_name,value:0,id:u.data.ID}),(jQuery.inArray(u.ID,ds.project.managersID)>-1||u.ID==ds.project.projectRiskManager)&&manMap.get(i).values.push({label:u.data.display_name,value:0,id:u.data.ID})}),map.put("Categories",new Map);var catMap=map.get("Categories");catMap.put(5,{key:"Extreme",color:"#ed5565",values:new Array}),catMap.put(4,{key:"High",color:"#f8ac59",values:new Array}),catMap.put(3,{key:"Significant",color:"#ffff55",values:new Array}),catMap.put(2,{key:"Moderate",color:"#1ab394",values:new Array}),catMap.put(1,{key:"Low",color:"#1c84c6",values:new Array}),this.catData.forEach(function(c){if(c.primCat)for(var i=5;i>0;i--)catMap.get(i).values.push({label:c.title,value:0})}),map.put("Status",new Map);var sMap=map.get("Status");sMap.put(5,{key:"Extreme",color:"#ed5565",values:new Array}),sMap.put(4,{key:"High",color:"#f8ac59",values:new Array}),sMap.put(3,{key:"Significant",color:"#ffff55",values:new Array}),sMap.put(2,{key:"Moderate",color:"#1ab394",values:new Array}),sMap.put(1,{key:"Low",color:"#1c84c6",values:new Array});for(var i=5;i>0;i--)sMap.get(i).values.push({label:"Inactive",value:0,state:-1}),sMap.get(i).values.push({label:"Active",value:0,state:0}),sMap.get(i).values.push({label:"Pending",value:0,state:1});for(var i=5;i>0;i--)ownMap.get(i).values.push({label:"Unassigned",value:0,id:""}),manMap.get(i).values.push({label:"Unassigned",value:0,id:""}),catMap.get(i).values.push({label:"Unassigned",value:0});return map},this.getDefaultProject=function(){return{id:-1,title:"Project Title",description:"Description of the Project",useAdvancedConsequences:!1,projectCode:"",ownersID:[],managersID:[],usersID:[],matrix:{maxImpact:5,maxProb:5,tolString:"1123312234223443345534455555555555555555555555555555555555555555",probVal1:20,probVal2:40,probVal3:60,probVal4:80,probVal5:100,probVal6:100,probVal7:100,probVal8:100},inheritParentCategories:!0,inheritParentObjectives:!0,categories:[],objectives:[],parent_id:0}}}function RemoteService($http){this.getRisk=function(riskID){return $http({method:"POST",url:ajaxurl,params:{action:"getRisk"},cache:!1,data:riskID})},this.getServerMeta=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getServerMeta"},cache:!1})},this.saveRisk=function(risk){return $http({method:"POST",url:ajaxurl,params:{action:"saveRisk"},cache:!1,data:risk})},this.getAllRisks=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getAllRisks"},cache:!1})},this.registerAudit=function(auditType,auditComment,riskID){return $http({method:"POST",url:ajaxurl,params:{action:"registerAudit"},cache:!1,data:{auditType:auditType,auditComment:auditComment,riskID:riskID}})},this.getAllProjectRisks=function(projectID,childProjects){return $http({method:"POST",url:ajaxurl,params:{action:"getAllProjectRisks"},cache:!1,data:{projectID:projectID,childProjects:childProjects}}).error(function(data,status,headers,config){alert(data.msg)})},this.getSiteUsersCap=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getSiteUsersCap"},cache:!1})},this.getSiteUsers=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getSiteUsers"},cache:!1})},this.getProjects=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getProjects"},cache:!1})},this.saveProject=function(data){return $http({method:"POST",url:ajaxurl,params:{action:"saveProject"},data:data,cache:!1})},this.updateRisksRelMatrix=function(data){return $http({method:"POST",url:ajaxurl,params:{action:"updateRisksRelMatrix"},cache:!1,data:JSON.stringify(data)}).error(function(data,status,headers,config){alert(data.msg)})},this.saveRankOrder=function(data){return $http({method:"POST",url:ajaxurl,params:{action:"saveRankOrder"},cache:!1,data:JSON.stringify(data)}).error(function(data,status,headers,config){alert(data.msg)})},this.getAttachments=function(postID){return $http({method:"POST",url:ajaxurl,params:{action:"getAttachments"},cache:!1,data:postID})},this.getCurrentUser=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getCurrentUser"},cache:!1})},this.getAllIncidents=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getAllIncidents"},cache:!1})},this.getIncident=function(incidentID){return $http({method:"POST",url:ajaxurl,params:{action:"getIncident"},cache:!1,data:JSON.stringify(incidentID)})},this.getReview=function(reviewID){return $http({method:"POST",url:ajaxurl,params:{action:"getReview"},cache:!1,data:JSON.stringify(reviewID)})},this.saveIncident=function(incident){return $http({method:"POST",url:ajaxurl,params:{action:"saveIncident"},cache:!1,data:JSON.stringify(incident)})},this.getAllReviews=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getAllReviews"},cache:!1})},this.getIncident=function(incidentID){return $http({method:"POST",url:ajaxurl,params:{action:"getIncident"},cache:!1,data:JSON.stringify(incidentID)})},this.saveReview=function(review){return $http({method:"POST",url:ajaxurl,params:{action:"saveReview"},cache:!1,data:JSON.stringify(review)})},this.addGeneralComment=function(comment,postID){return data={comment:comment,ID:postID},$http({method:"POST",url:ajaxurl,params:{action:"addGeneralComment"},cache:!1,data:JSON.stringify(data)})},this.login=function(user,pass){return data={user:user,pass:pass},$http({method:"POST",url:ajaxurl,params:{action:"login"},cache:!1,data:JSON.stringify(data)})},this.logout=function(){return $http({method:"POST",url:ajaxurl,params:{action:"logout"},cache:!1})},this.checkSession=function(){return $http({method:"POST",url:ajaxurl,params:{action:"checkSession"},cache:!1})},this.getJSON=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getJSON"},cache:!1})},this.getReportRiskJSON=function(risks,projectID,childProjects,basicsOnly,reportID){var data={risks:risks,projectID:projectID,childProjects:childProjects,basicsOnly:basicsOnly,reportID:reportID};return $http({method:"POST",url:ajaxurl,params:{action:"getReportRiskJSON"},data:JSON.stringify(data),cache:!1})},this.getReportIncidentJSON=function(incidents,reportID){var data={incidents:incidents,reportID:reportID};return $http({method:"POST",url:ajaxurl,params:{action:"getReportIncidentJSON"},data:JSON.stringify(data),cache:!1})},this.getReportReviewJSON=function(reviews,reportID){var data={reviews:reviews,reportID:reportID};return $http({method:"POST",url:ajaxurl,params:{action:"getReportReviewJSON"},data:JSON.stringify(data),cache:!1})},this.newPushDownRisk=function(pushdown){return $http({method:"POST",url:ajaxurl,params:{action:"newPushDown"},cache:!1,data:JSON.stringify(pushdown)})},this.createDummyRiskEntry=function(projectID){return $http({method:"POST",url:ajaxurl,params:{action:"createDummyRiskEntry"},cache:!1,data:JSON.stringify(projectID)})},this.createDummyRiskEntries=function(projectID){return $http({method:"POST",url:ajaxurl,params:{action:"createDummyRiskEntryMultiple"},cache:!1,data:JSON.stringify(projectID)})}}function config($stateProvider,IdleProvider){IdleProvider.idle(5),IdleProvider.timeout(120),$stateProvider.state("qrm",{"abstract":!0,controller:"QRMCtrl as qrmctrl",templateUrl:function(params){return pluginurl+"views/common/content.html"}}).state("intro",{controller:"IntroCtrl",templateUrl:function(params){return pluginurl+"views/qrm/intro.html"}}).state("nonQRM",{controller:"LoginCtrl as login",templateUrl:function(params){return pluginurl+"views/qrm/nonqrm.html"}}).state("login",{templateUrl:function(params){return pluginurl+"views/qrm/login.html"},controller:"LoginCtrl as login",data:{pageTitle:"Login"},onEnter:function(){closeMenu()},onExit:function(){}}).state("qrm.explorer",{templateUrl:function(params){return jQuery(window).width()<768?pluginurl+"views/qrm/m.explorer.html":pluginurl+"views/qrm/explorer.html"},controller:"ExplorerCtrl as exp",data:{pageTitle:"Risk Explorer"},onEnter:function(){closeMenu();var winWidth=jQuery(document).width()-10;jQuery("#container").css("width",winWidth+"px")}}).state("qrm.risk",{templateUrl:function(params){return jQuery(window).width()<768?pluginurl+"views/qrm/m.risk.html":pluginurl+"views/qrm/risk.html"},controller:"RiskCtrl as ctl",resolve:{loadPlugin:["$ocLazyLoad",function($ocLazyLoad){return $ocLazyLoad.load({files:[pluginurl+"js/daterangepicker.js",pluginurl+"css/daterangepicker-bs3.css"],cache:!0})}]},onEnter:function(){closeMenu()},onExit:function(){QRM.mainController.lookingForRisks()}}).state("qrm.calender",{controller:"CalenderController",controllerAs:"cal",templateUrl:function(params){return jQuery(window).width()<768?pluginurl+"views/qrm/m.calender.html":pluginurl+"views/qrm/calender.html"},onEnter:function(){closeMenu()}}).state("qrm.rank",{controller:"RankController",controllerAs:"rank",templateUrl:function(params){return jQuery(window).width()<768?pluginurl+"views/qrm/m.rank.html":pluginurl+"views/qrm/rank.html"},onEnter:function(){closeMenu()}}).state("qrm.reportarchive",{controller:"ReportArchiveController",controllerAs:"rep",templateUrl:function(params){return jQuery(window).width()<768?pluginurl+"views/qrm/m.report.html":pluginurl+"views/qrm/report.html"},onEnter:function(){closeMenu()}}).state("qrm.matrix",{controller:"RelMatrixController",controllerAs:"relMatrix",templateUrl:function(params){return jQuery(window).width()<768?pluginurl+"views/qrm/m.relmatrix.html":pluginurl+"views/qrm/relmatrix.html"},onEnter:function(){closeMenu()}}).state("qrm.incidentExpl",{controller:"IncidentExplCtrl",controllerAs:"incidentExpl",templateUrl:function(params){return jQuery(window).width()<768?pluginurl+"views/qrm/m.incidentExplorer.html":pluginurl+"views/qrm/incidentExplorer.html"},onEnter:function(){closeMenu()}}).state("qrm.incident",{controller:"IncidentCtrl",controllerAs:"incident",templateUrl:function(params){return jQuery(window).width()<768?pluginurl+"views/qrm/m.incident.html":pluginurl+"views/qrm/incident.html"},resolve:{loadPlugin:["$ocLazyLoad",function($ocLazyLoad){return $ocLazyLoad.load({files:[pluginurl+"js/daterangepicker.js",pluginurl+"css/daterangepicker-bs3.css"],cache:!0})}]},onEnter:function(){QRM.mainController.titleBar="Risk Incidents",closeMenu()}}).state("qrm.reviewExpl",{controller:"ReviewExplCtrl",controllerAs:"reviewExpl",templateUrl:function(params){return jQuery(window).width()<768?pluginurl+"views/qrm/m.reviewExplorer.html":pluginurl+"views/qrm/reviewExplorer.html"},onEnter:function(){closeMenu()}}).state("qrm.review",{controller:"ReviewCtrl",controllerAs:"rev",templateUrl:function(params){return jQuery(window).width()<768?pluginurl+"views/qrm/m.review.html":pluginurl+"views/qrm/review.html"},onEnter:function(){QRM.mainController.titleBar="Risk Reviews",closeMenu()}}).state("qrm.analysis",{controller:"AnalysisController",controllerAs:"analysis",templateUrl:function(params){return jQuery(window).width()<768?pluginurl+"views/qrm/m.analysis.html":pluginurl+"views/qrm/analysis.html"},onEnter:function(){QRM.mainController.titleBar="Analysis",closeMenu()}})}function pageTitle($rootScope,$timeout){return{link:function(scope,element){var listener=function(event,toState,toParams,fromState,fromParams){var title="QRM | Quay Risk Manager";toState.data&&toState.data.pageTitle&&(title="QRM | "+toState.data.pageTitle),$timeout(function(){element.text(title)})};$rootScope.$on("$stateChangeStart",listener)}}}function icheck($timeout){return{restrict:"A",require:"ngModel",link:function($scope,element,$attrs,ngModel){return $timeout(function(){var value;return value=$attrs.value,$scope.$watch($attrs.ngModel,function(newValue){jQuery(element).iCheck("update")}),jQuery(element).iCheck({checkboxClass:"icheckbox_square-green",radioClass:"iradio_square-green"}).on("ifChanged",function(event){return"checkbox"===jQuery(element).attr("type")&&$attrs.ngModel&&$scope.$apply(function(){return ngModel.$setViewValue(event.target.checked)}),"radio"===jQuery(element).attr("type")&&$attrs.ngModel?$scope.$apply(function(){return ngModel.$setViewValue(value)}):void 0})})}}}function riskmat(QRMDataService){return{restrict:"E",compile:function(element,attrs){for(var maxProb=8,maxImpact=8,mat="<table border='1' cellspacing='5' cellpadding='0' style='width:180px;height:180px;cursor:pointer;cursor:hand'>",prob=maxProb;prob>0;prob--){mat=mat+"<tr ng-class='{cellHidden: exp.rowClass("+prob+")}'>";for(var impact=1;maxImpact>=impact;impact++)mat=mat+"<td ng-style='exp.cellStyle()' ng-click='exp.matrixFilter("+impact+","+prob+","+attrs.treated+")' ng-class='{cellHidden: exp.cellClass("+prob+","+impact+",0),cellLow: exp.cellClass("+prob+","+impact+",1), cellModerate:exp.cellClass("+prob+","+impact+",2), cellSignificant:exp.cellClass("+prob+","+impact+",3), cellHigh:exp.cellClass("+prob+","+impact+",4), cellExtreme:exp.cellClass("+prob+","+impact+",5), matCellHighLight:exp.cellHighlight("+prob+","+impact+","+attrs.treated+")}'>{{exp.getCellValue("+prob+","+impact+","+attrs.treated+")}}</td>";mat+="</tr>"}mat+="</table>",element.replaceWith(mat)}}}function dropzone(){function link(scope,element,attrs){var config,dropzone;config=scope[attrs.dropzone],dropzone=new Dropzone(element[0],config.options),angular.forEach(config.eventHandlers,function(handler,event){dropzone.on(event,handler)})}return{link:link}}function textAngularFocus($parse,$timeout,textAngularManager){return{link:function(scope,element,attributes){var shouldFocus=$parse(attributes.focus)(scope);shouldFocus&&$timeout(function(){var editorScope=textAngularManager.retrieveEditor(attributes.name).scope;editorScope.displayElements.text.trigger("focus")},0,!1)}}}function SortByProjectCode(a,b){if(null===a||null===b)return 0;var aName,bName;return"object"==typeof a?(aName=a.riskProjectCode.toLowerCase(),bName=b.riskProjectCode.toLowerCase()):(aName=jQuery.grep(QRM.mainController.risks,function(e){return e.id==a})[0].riskProjectCode,bName=jQuery.grep(QRM.mainController.risks,function(e){return e.id==b})[0].riskProjectCode),bName>aName?-1:aName>bName?1:0}function startChatChannel(pollURL,userEmail,siteKey,QRMDataService,reset){try{if(null!=ajaxChatRequest&&1==ajaxChatRequest.readyState)return void console.log("Chat already open - do nothing")}catch(e){console.log(e.message)}30>failedConnectCount?(console.log("Initiate Chat"),ajaxChatRequest=jQuery.ajax({url:pollURL+"?nocache="+Math.random()+"&userEmail="+userEmail+"&siteKey="+siteKey+"&reset="+reset+"&sessionToken="+QRMDataService.sessionToken,type:"GET",timeout:47e3,dataType:"jsonp",success:function(m){return failedConnectCount=0,ajaxChatRequest=null,m.msg?void QRM.mainController.notify(m.message,m.duration):m.timeout?void console.log("Chat Timeout"):void(m.reportReady&&(QRM.mainController.notify2("Report Ready. Downloading Now"),jQuery('input[name="userEmail"]').val(QRMDataService.userEmail),jQuery('input[name="userLogin"]').val(QRMDataService.userLogin),jQuery('input[name="siteKey"]').val(QRMDataService.siteKey),jQuery('input[name="id"]').val(m.reportID),jQuery("#getReportForm").attr("action",QRMDataService.reportServerURL+"/getReport",!1),jQuery("#getReportForm").submit()))},error:function(jqXHR,textStatus,errorThrown){failedConnectCount++,console.log("Chat Fail")},complete:function(jqXHR,textStatus){startChatChannel(pollURL,userEmail,siteKey,QRMDataService,!1)}})):(QRM.mainController.notifyNoReportServer(),failedConnectCount=0)}function QRMCtrl(QRMDataService){this.reports=QRMDataService.reports}function IntroCtrl($scope,QRMDataService,remoteService,$state,$q,$http){var intro=this;QRM.introController=this,$scope.introloading=!0,intro.sessionOK=!1,intro.qrmUser=!1;var z=remoteService.checkSession().then(function(response){"0"===response.data||"-1"===response.data?intro.sessionOK=!1:(intro.sessionOK=!0,intro.qrmUser=response.data.loggedin)}),a=remoteService.getSiteUsers().then(function(response){"0"===response.data||"-1"===response.data?intro.sessionOK=!1:(intro.sessionOK=!0,"-3"!=response.data&&(QRMDataService.siteUsers=response.data))}),b=remoteService.getCurrentUser().then(function(response){"0"==response.data||"-1"==response.data?intro.sessionOK=!1:(intro.sessionOK=!0,"-3"!=response.data&&(QRMDataService.currentUser=response.data,QRM.mainController.userName=QRMDataService.currentUser.data.display_name))}),c=remoteService.getAllRisks().then(function(response){"0"===response.data||"-1"===response.data?intro.sessionOK=!1:(intro.sessionOK=!0,"-3"!=response.data&&(QRM.mainController.risks=response.data,QRM.mainController.risks=jQuery.grep(QRM.mainController.risks,function(value){return null==value.riskProjectCode?!1:null!=value}),QRM.mainController.risks.sort(SortByProjectCode),QRMDataService.risks=QRM.mainController.risks))}),e=remoteService.getServerMeta().then(function(response){QRMDataService.reportServerURL=response.data.reportServerURL,QRMDataService.siteKey=response.data.siteKey,QRMDataService.siteName=response.data.siteName,QRMDataService.siteID=response.data.siteID,QRMDataService.userEmail=response.data.userEmail,QRMDataService.userLogin=response.data.userLogin,QRMDataService.userDisplayName=response.data.userDisplayName,QRMDataService.sessionToken=response.data.sessionToken,"0"!=response.data&&"-1"!=response.data&&setTimeout(function(){startChatChannel(QRMDataService.reportServerURL+"/reportMsg",QRMDataService.userEmail,QRMDataService.siteKey,QRMDataService,!0)},5e3)});if("risk"==postType||"review"==postType){var d=remoteService.getProjects().then(function(response){"0"==response.data||"-1"==response.data?intro.sessionOK=!1:(intro.sessionOK=!0,"-3"!=response.data&&QRMDataService.handleGetProjects(response))});$q.all([z,a,b,c,d,e]).then(function(){intro.switcher()})}else $q.all([z,a,b,c,e]).then(function(){intro.switcher()});this.switcher=function(){return intro.sessionOK?intro.qrmUser?void $http.jsonp(QRMDataService.reportServerURL+"/availableReports?callback=JSON_CALLBACK").success(function(data){QRMDataService.reports=data}).error(function(data){QRMDataService.reports=[{id:-1,title:"Report Server Not Available",showRiskExplorer:!0,showSingleRisk:!0,showRank:!0,showCalender:!0,showReview:!0,showRelMatrix:!0,showSingleReview:!0,showIncident:!0,showSingleIncident:!0,showDashboard:!0}]})["finally"](function(){switch(postType){case"risk":QRMDataService.selectProject(projectID),QRMDataService.riskID=postID,$scope.introloading=!1,$state.go("qrm.risk");break;case"riskproject":$scope.introloading=!1,$state.go("qrm.explorer");break;case"review":remoteService.getReview(postID).then(function(response){QRMDataService.review=response.data,null!=QRMDataService.review.risks&&QRMDataService.review.risks.sort(SortByProjectCode),QRMDataService.reviewID=QRMDataService.review.id,QRMDataService.review.actualdate=new Date(QRMDataService.review.actualdate),QRMDataService.review.scheddate=new Date(QRMDataService.review.scheddate),$scope.introloading=!1,$state.go("qrm.review")});break;case"incident":remoteService.getIncident(postID).then(function(response){QRMDataService.incident=response.data,null!=QRMDataService.incident.risks&&QRMDataService.incident.risks.sort(SortByProjectCode),QRMDataService.incidentID=QRMDataService.incident.id,QRMDataService.incident.date=new Date(QRMDataService.incident.date),$scope.introloading=!1,$state.go("qrm.incident")});break;default:$scope.introloading=!1,$state.go("qrm.explorer")}}):void $state.go("nonQRM"):void $state.go("login")}}function MainCtrl(QRMDataService,remoteService,$state,ngNotify,$http,$q){QRM.mainController=this,this.notify=function(message,duration){ngNotify.dismiss(),ngNotify.set(message,{type:"info",sticky:!0,theme:"pure"})},this.notify2=function(message){ngNotify.dismiss(),ngNotify.set(message,{type:"success",duration:1e3,theme:"pure"})},this.notify3=function(message,duration){ngNotify.dismiss(),ngNotify.set(message,{type:"info",duration:duration,theme:"pure"})},this.notifyNoReportServer=function(message){ngNotify.dismiss(),ngNotify.set("Unable To Connect To The Report Server",{type:"warn",sticky:!0,theme:"pure"})},this.showStatusBoard=!1,this.showSpinner=!1,this.showSelectProject=!0,this.showLookingForRisks=!1,this.showNoRisks=!1,this.loading=!1,this.sideOpen=!1,this.showLookingForReviews=!1,this.showNoReviews=!1,this.showLookingForIncidents=!1,this.showNoIncidents=!1,this.pluginurl=pluginurl,this.loaderSrc=this.pluginurl+"views/ajax-loader.gif",this.go=function(state){$state.go(state)},this.lookingForRisks=function(){this.showSelectProject=!1,this.showLookingForRisks=!0,this.showNoRisks=!1,this.loading=!1},this.noRisksFound=function(){this.showSelectProject=!1,this.showLookingForRisks=!1,this.showNoRisks=!0,this.loading=!1},this.risksFound=function(){this.showSelectProject=!1,this.showLookingForRisks=!1,this.showNoRisks=!1,this.loading=!1},this.loadingProject=function(){this.showSelectProject=!1,this.showLookingForRisks=!1,this.showNoRisks=!1,this.loading=!0},this.lookingForIncidents=function(){this.showLookingForIncidents=!0,this.showNoIncidents=!1},this.incidentsFound=function(){this.showLookingForIncidents=!1,this.showNoIncidents=!1},this.noIncidentsFound=function(){this.showLookingForIncidents=!1,this.showNoIncidents=!0},this.lookingForReviews=function(){this.showLookingForReviews=!0,this.showNoReviews=!1},this.reviewsFound=function(){this.showLookingForReviews=!1,this.showNoReviews=!1},this.noReviewsFound=function(){this.showLookingForReviews=!1,this.showNoReviews=!0},this.getBtnClass=function(btnClass){return"primary"==btnClass&&"primary"==this["class"]?!0:"danger"==btnClass&&"danger"==this["class"]?!0:"info"==btnClass&&"info"==this["class"]?!0:"warning"==btnClass&&"warning"==this["class"]?!0:void 0},this.checkUserCap=function(action,risk){if("undefined"==typeof QRMDataService.currentUser)return!1;var userID=QRMDataService.currentUser.ID,p=QRMDataService.project;switch(action){case"edit_risk_grid":return risk.owner==userID?!0:risk.manager==userID?!0:QRMDataService.project.projectRiskManager==userID?!0:!1;case"view_risk_grid":return risk.owner==userID?!0:risk.manager==userID?!0:QRMDataService.project.projectRiskManager==userID?!0:p.ownersID.indexOf(userID)>-1?!0:p.managersID.indexOf(userID)>-1?!0:p.usersID.indexOf(userID)>-1?!0:!1;case"delete_risk_grid":return risk.owner==userID?!0:QRMDataService.project.projectRiskManager==userID?!0:!1;case"new_risk":return"undefined"==typeof p?!1:p.projectRiskManager==userID?!0:"undefined"==typeof p.ownersID?!1:p.ownersID.indexOf(userID)>-1?!0:"undefined"==typeof p.managersID?!1:p.managersID.indexOf(userID)>-1?!0:!1;case"save_risk":return QRMDataService.riskID<0?!0:"undefined"==typeof QRMDataService.risk?!1:QRMDataService.risk.owner==userID?!0:QRMDataService.risk.manager==userID?!0:QRMDataService.project.projectRiskManager==userID?!0:!1;case"new_incident":return!0;case"new_review":return!0;default:return!1}},this.logout=function(){remoteService.logout()["finally"](function(){QRMDataService.siteUsers=null,QRM.mainController.risks=null,QRMDataService.currentUser=null,$state.go("login")})},this.main=function(){window.open(siteURL,"_self")},this.toggleMenu=function(){var open=jQuery("#header_container").hasClass("sideMenuOpen");open?(jQuery("#header_container").removeClass("sideMenuOpen"),jQuery("#footer_container").removeClass("sideMenuOpen"),jQuery("#cbp-spmenu-s1").removeClass("cbp-spmenu-open"),jQuery("body").toggleClass("cbp-spmenu-push-toright")):(jQuery("#header_container").addClass("sideMenuOpen"),jQuery("#footer_container").addClass("sideMenuOpen"),jQuery("#cbp-spmenu-s1").addClass("cbp-spmenu-open"),jQuery("body").toggleClass("cbp-spmenu-push-toright")),QRM.mainController.sideOpen=!open},this.titleBar="Please Select Project",this.init=function(login){var a=remoteService.getSiteUsers().then(function(response){QRMDataService.siteUsers=response.data}),b=remoteService.getCurrentUser().then(function(response){QRMDataService.currentUser=response.data,QRM.mainController.userName=QRMDataService.currentUser.data.display_name}),c=remoteService.getAllRisks().then(function(response){QRM.mainController.risks=response.data,QRM.mainController.risks=jQuery.grep(QRM.mainController.risks,function(value){return null==value.riskProjectCode?!1:null!=value}),QRM.mainController.risks.sort(SortByProjectCode),QRMDataService.risks=QRM.mainController.risks}),e=remoteService.getServerMeta().then(function(response){QRMDataService.reportServerURL=response.data.reportServerURL,QRMDataService.siteKey=response.data.siteKey,QRMDataService.siteName=response.data.siteName,QRMDataService.siteID=response.data.siteID,QRMDataService.userEmail=response.data.userEmail,QRMDataService.userLogin=response.data.userLogin,QRMDataService.userDisplayName=response.data.userDisplayName,QRMDataService.sessionToken=response.data.sessionToken,setTimeout(function(){startChatChannel(QRMDataService.reportServerURL+"/reportMsg",QRMDataService.userEmail,QRMDataService.siteKey,QRMDataService,!0)},5e3),$http.jsonp(QRMDataService.reportServerURL+"/availableReports&callback=JSON_CALLBACK").success(function(data){QRMDataService.reports=data}).error(function(data){})["finally"](function(){})});$q.all([a,b,c,e]).then(function(){login&&(postType="firstproject",$state.go("qrm.explorer"))})}}function ExplorerCtrl($scope,QRMDataService,$state,remoteService,ngDialog,$timeout,$http,uiGridConstants){QRMDataService.project.title?QRM.mainController.titleBar="Risk Explorer - "+QRMDataService.project.title:QRM.mainController.titleBar="Risk Explorer",QRM.mainController.titleBarSM="QRM Risk Explorer",QRM.expController=this,$scope.siteName=QRMDataService.siteName,$scope.getMyCtrlScope=function(){return $scope},this.getTableHeight=function(){return{height:"calc(100vh - 320px)"}},this.getTableHeightSm=function(){return{height:"calc(100vh - 145px)"}},QRMDataService.riskID=0;var exp=this;this.childProjects=!1,QRMDataService.project.id>0&&(this.project=QRMDataService.project),$scope.checkUserCap=function(x,y){return QRM.mainController.checkUserCap(x,y)},$scope.savingrisk=!1,this.valPre=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.valPost=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.filterMatrixFlag=!1,this.filterMatrixHighlightFlag=!1,this.gridOptions={enableSorting:!0,rowTemplate:'<div ng-click="grid.appScope.editRisk(row.entity.id)" style="cursor:pointer" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',columnDefs:[{field:"riskProjectCode",enableColumnMoving:!1,width:80,headerCellClass:"header-hidden",cellClass:function(grid,row,col,rowRenderIndex,colRenderIndex){switch(Number(row.entity.currentTolerance)){case 1:return"blue compact";case 2:return"green compact";case 3:return"yellow compact";case 4:return"orange compact";case 5:return"red compact"}}},{headerCellClass:"header-hidden",width:50,field:"currentTolerance",cellTemplate:'<i class="fa fa-circle {{grid.appScope.formatCodeCol(grid, row)}}"></i>',cellClass:"cellCentered",sort:{direction:uiGridConstants.DESC}},{name:"title",width:"*",cellClass:"compact",field:"title"},{name:"treated",width:70,field:"treated",cellTemplate:'<i style="color:green" ng-show="grid.appScope.formatTreatedCol(row, true)" class="fa fa-check"></i><i  style="color:red" ng-show="grid.appScope.formatTreatedCol(row, false)" class="fa fa-close"></i>',cellClass:"cellCentered",sort:{direction:uiGridConstants.ASC}},{name:"owner",width:140,field:"owner",cellFilter:"usernameFilter"},{name:"manager",width:140,field:"manager",
cellFilter:"usernameFilter"}]},this.gridOptionsSm={enableSorting:!0,rowTemplate:'<div ng-click="grid.appScope.editRisk(row.entity.id)" style="cursor:pointer" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',columnDefs:[{field:"riskProjectCode",enableColumnMoving:!1,width:80,name:"Risk ID",cellClass:function(grid,row,col,rowRenderIndex,colRenderIndex){switch(Number(row.entity.currentTolerance)){case 1:return"blue compact";case 2:return"green compact";case 3:return"yellow compact";case 4:return"orange compact";case 5:return"red compact"}}},{name:"title",width:"*",cellClass:"compact",field:"title"},{name:"owner",width:100,field:"owner",cellFilter:"usernameFilter"}]},$scope.formatTreatedCol=function(row,check){return row.entity.treated&&check?!0:row.entity.treated||check?!1:!0},this.resetFilter=function(){return this.filterMatrix=!1,{owner:"",manager:"",category:"",expActive:!0,expPending:!0,expInactive:!0,treated:!0,untreated:!0,tolEx:!0,tolHigh:!0,tolSig:!0,tolModerate:!0,tolLow:!0,inactive:!0,active:!0,pending:!0,filterMatrix:!1,riskCode:"",inactive:!0,active:!0,pending:!0,childProjects:!1}},this.filterOptions=this.resetFilter(),$scope.formatCodeCol=function(grid,row){switch(Number(row.entity.currentTolerance)){case 1:return"bluefill";case 2:return"greenfill";case 3:return"yellowfill";case 4:return"orangefill";case 5:return"redfill"}},$scope.$watch("exp.filterOptions",function(){exp.filterRisks()},!0),this.newRisk=function(){postType=null,QRMDataService.riskID=-1,$state.go("qrm.risk")},this.checkForReports=function(){var url=QRMDataService.reportServerURL+"/getCompletedReports?callback=JSON_CALLBACK&&sessionToken="+QRMDataService.sessionToken;$http.jsonp(url).success(function(data){if(0==data.length)QRM.mainController.notify3("All Completed Reports Have Been Downloaded",2e3);else{QRM.mainController.notify2("Downloading Completed Report");for(var i=0;i<data.length;i++){var id=data[i];jQuery('input[name="userEmail"]').val(QRMDataService.userEmail),jQuery('input[name="userLogin"]').val(QRMDataService.userLogin),jQuery('input[name="siteKey"]').val(QRMDataService.siteKey),jQuery('input[name="id"]').val(id),jQuery("#getReportForm").attr("action",QRMDataService.reportServerURL+"/getReport",!1),jQuery("#getReportForm").submit()}}}).error(function(data){ngNotify.dismiss(),ngNotify.set("Error Retrieving Available Reports",{type:"grimace",duration:1e3,theme:"pure"})})},this.newPushDownRisk=function(){this.pushDown=QRMDataService.getTemplateRisk(),this.pushDown.title="Title of the new Push Down Risk",this.pushDown.description="Description of the Push Down Risk",this.pushDown.type=1,this.pushDown.projectID=QRMDataService.project.id,this.pushDown.inherentProb=QRMDataService.project.matrix.maxProb+.5,this.pushDown.inherentImpact=QRMDataService.project.matrix.maxImpact+.5;var index=Math.floor(this.pushDown.treatedProb-1)*QRMDataService.project.matrix.maxImpact+Math.floor(this.pushDown.treatedImpact-1);index=Math.min(index,QRMDataService.project.matrix.tolString.length-1),this.pushDown.treatedTolerance=QRMDataService.project.matrix.tolString.substring(index,index+1),index=Math.floor(this.pushDown.inherentProb-1)*QRMDataService.project.matrix.maxImpact+Math.floor(this.pushDown.inherentImpact-1),index=Math.min(index,QRMDataService.project.matrix.tolString.length-1),this.pushDown.inherentTolerance=QRMDataService.project.matrix.tolString.substring(index,index+1),this.pushDown.currentProb=this.pushDown.inherentProb,this.pushDown.currentImpact=this.pushDown.inherentImpact,this.pushDown.currentTolerance=this.pushDown.inherentTolerance,ngDialog.openConfirm({template:"editPushDownDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){$scope.savingrisk=!0,remoteService.newPushDownRisk(exp.pushDown).then(function(response){})["finally"](function(){remoteService.getAllRisks().then(function(response){QRM.mainController.risks=response.data,QRM.mainController.risks=jQuery.grep(QRM.mainController.risks,function(value){return null==value.riskProjectCode?!1:null!=value}),QRM.mainController.risks.sort(SortByProjectCode),QRMDataService.risks=QRM.mainController.risks})["finally"](function(){$scope.savingrisk=!1}),exp.getAllProjectRisks()})})},$scope.editRisk=function(riskID){exp.editRisk(riskID)},this.editRisk=function(riskID){postType=null,QRMDataService.riskID=riskID,$scope.loading=!0,remoteService.getRisk(QRMDataService.riskID).then(function(response){return response.data.msg?($scope.loading=!1,void alert(response.data.msg)):(QRMDataService.pRisk=response.data,QRMDataService.passRisk=!0,void $state.go("qrm.risk"))})["finally"](function(){$scope.loading=!1})},this.deleteRisk=function(riskID){QRMDataService.riskID=riskID,alert("Delete Risk: "+riskID)},this.getAllProjectRisks=function(){QRM.mainController.lookingForRisks(),remoteService.getAllProjectRisks(exp.project.id,exp.childProjects).then(function(response){if("0"==response.data||"-1"==response.data)return void $state.go("login");0==response.data.length?QRM.mainController.noRisksFound():QRM.mainController.risksFound(),exp.rawRisks=response.data,QRMDataService.projectRisks=response.data,exp.gridOptions.data=response.data,exp.gridOptionsSm.data=response.data;for(var maxImpact=Number(QRMDataService.project.matrix.maxImpact),maxProb=Number(QRMDataService.project.matrix.maxProb),i=0;maxImpact*maxProb>i;i++)exp.valPre[i]=0,exp.valPost[i]=0;response.data.forEach(function(el){var iP=Math.floor(Number(el.inherentProb)),iI=Math.floor(Number(el.inherentImpact)),tP=Math.floor(Number(el.treatedProb)),tI=Math.floor(Number(el.treatedImpact));exp.valPre[(iP-1)*maxImpact+iI-1]++,exp.valPost[(tP-1)*maxImpact+tI-1]++}),exp.filterRisks();var winWidth=jQuery(document).width()-10;jQuery("#container").css("width",winWidth+"px")})},this.filterRisks=function(){null!=this.rawRisks&&(this.gridOptions.data=[],this.rawRisks.forEach(function(r){var pass=!1;if(exp.filterMatrixFlag){var i,p;exp.filterOptions.matrixTreated?(i=Math.floor(Number(r.treatedImpact)),p=Math.floor(Number(r.treatedProb))):(i=Math.floor(Number(r.inherentImpact)),p=Math.floor(Number(r.inherentProb))),i==exp.filterOptions.matrixImpact&&p==exp.filterOptions.matrixProb&&(pass=!0)}else{if(exp.filterMatrixHighlightFlag=!1,exp.filterOptions.treated&&r.treated&&(pass=!0),exp.filterOptions.untreated&&!r.treated&&(pass=!0),!pass)return;if(pass=!1,exp.filterOptions.tolEx&&5==Number(r.currentTolerance)&&(pass=!0),exp.filterOptions.tolHigh&&4==Number(r.currentTolerance)&&(pass=!0),exp.filterOptions.tolSig&&3==Number(r.currentTolerance)&&(pass=!0),exp.filterOptions.tolModerate&&2==Number(r.currentTolerance)&&(pass=!0),exp.filterOptions.tolLow&&1==Number(r.currentTolerance)&&(pass=!0),!pass)return;pass=!1;var own=exp.filterOptions.owner,man=exp.filterOptions.manager;if(own!=r.owner&&void 0!=own&&null!=own&&""!=own||man!=r.manager&&void 0!=man&&null!=man&&""!=man)return;var now=moment(),endDiff=now.diff(moment(r.end)),startDiff=now.diff(moment(r.start));exp.filterOptions.expInactive&&endDiff>0&&(pass=!0),exp.filterOptions.expPending&&0>startDiff&&(pass=!0),exp.filterOptions.expActive&&startDiff>0&&0>endDiff&&(pass=!0)}pass&&pass&&exp.gridOptions.data.push(r)}),this.filterMatrixFlag=!1)},this.matrixFilter=function(impact,prob,treated){this.filterMatrixFlag=!0,this.filterMatrixHighlightFlag=!0,this.filterOptions=this.resetFilter(),this.filterOptions.matrixProb=prob,this.filterOptions.matrixImpact=impact,this.filterOptions.matrixTreated=treated},this.clearFilters=function(){this.filterOptions=this.resetFilter()},this.rowStyle=function(e){return{"margin-left":20*e.$$treeLevel+"px"}},this.projectSelect=function(item,projectID){QRM.mainController.loadingProject(),QRMDataService.selectProject(projectID),this.project=QRMDataService.project,QRM.mainController.titleBar="Risk Explorer - "+QRMDataService.project.title,QRM.mainController.titleBarSM="QRM Risk Explorer",this.getAllProjectRisks(this.project.id,exp.childProjects),this.clearFilters(),jQuery("a.disable-noproject").removeClass("disable-link"),$timeout(function(){$scope.$apply()})},this.getCellValue=function(prob,impact,treated){if(treated){var val=this.valPost[(prob-1)*QRMDataService.project.matrix.maxImpact+impact-1];return 0==val?"":val}var val=this.valPre[(prob-1)*QRMDataService.project.matrix.maxImpact+impact-1];return 0==val?"":val},this.cellHighlight=function(prob,impact,treated){var r=this.filterMatrixHighlightFlag&&this.filterOptions.matrixProb==prob&&this.filterOptions.matrixImpact==impact&&this.filterOptions.matrixTreated==treated;return r},this.cellClass=function(prob,impact,tol){if(impact>QRMDataService.project.matrix.maxImpact||prob>QRMDataService.project.matrix.maxProb)return!0;var index=(prob-1)*QRMDataService.project.matrix.maxImpact+impact-1;return Number(QRMDataService.project.matrix.tolString.substring(index,index+1))==tol},$scope.reportStressTest=function(){QRM.expController.stress()},this.stress=function(){remoteService.getReportRiskJSON([],QRMDataService.project.id,!0,!0,2).then(function(response){"OK"==response.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(response.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(QRMDataService.userEmail),jQuery('input[name="reportID"]').val(2),jQuery("#reportForm").attr("action",response.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}),setTimeout(QRM.expController.stress,4e3)},$scope.riskReport=function(reportID){$scope.reportReqID<0||(QRM.mainController.notify("Assembling Data for Report",5e3),remoteService.getReportRiskJSON([],QRMDataService.project.id,exp.childProjects,!1,$scope.reportReqID).then(function(response){"OK"==response.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(response.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(QRMDataService.userEmail),jQuery('input[name="reportID"]').val($scope.reportReqID),jQuery("#reportForm").attr("action",response.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}))},this.cellStyle=function(prob,impact,tol){var vh=100/QRMDataService.project.matrix.maxProb,vw=100/QRMDataService.project.matrix.maxImpact;return{width:vw+"%",height:vh+"%","text-align":"center"}},this.rowClass=function(prob){return prob>QRMDataService.project.matrix.maxProb?!0:!1},this.init=function(){remoteService.getProjects().then(function(response){return"0"==response.data||"-1"==response.data?void $state.go("login"):(jQuery("#explorer-wrapper").removeClass("hidden-qrm"),QRMDataService.handleGetProjects(response),exp.projectsLinear=QRMDataService.projectsLinear,exp.sortedParents=QRMDataService.sortedParents,exp.projMap=QRMDataService.projMap,void("riskproject"==postType?(exp.projectSelect(null,postID),postType=null):"firstproject"==postType?(exp.projectSelect(null,QRMDataService.sortedParents[0].id),postType=null):QRMDataService.project.id>0&&exp.getAllProjectRisks(QRMDataService.project.id)))})},winWidth=jQuery(window).innerWidth()-10,jQuery("#container").css("width",winWidth+"px"),this.init()}function RiskCtrl($scope,QRMDataService,$state,$timeout,remoteService,ngNotify,ngDialog,$q){$scope.getMyCtrlScope=function(){return $scope};var vm=this;this.riskID=QRMDataService.riskID,this.reviewType=-1,this.stakeholders=[],this.additionalHolders=[],this.project=QRMDataService.project,this.categories=QRMDataService.catData,this.objectives=QRMDataService.projectObjectives,$scope.data={comment:""},$scope.siteUsers=[],$scope.dropzoneConfig={options:{url:ajaxurl+"?action=uploadFile",previewTemplate:document.querySelector("#preview-template").innerHTML,parallelUploads:1,thumbnailHeight:120,thumbnailWidth:120,maxFilesize:10,filesizeBase:1e3,autoProcessQueue:!1,thumbnail:function(file,dataUrl){if(file.previewElement){file.previewElement.classList.remove("dz-file-preview");for(var images=file.previewElement.querySelectorAll("[data-dz-thumbnail]"),i=0;i<images.length;i++){var thumbnailElement=images[i];thumbnailElement.alt=file.name,thumbnailElement.src=dataUrl}setTimeout(function(){file.previewElement.classList.add("dz-image-preview")},1)}},init:function(){this.on("addedfile",function(file){vm.riskAttachmentReady(this,file)}),this.on("complete",function(file){file.previewElement.classList.add("dz-complete"),vm.cancelAttachment(),ngNotify.set("Attachment Added To Risk",{type:"success",duration:1e3,theme:"pure"}),remoteService.getAttachments(vm.riskID).then(function(response){vm.risk.attachments=response.data})}),this.on("error",function(file,message,xhr){file.previewElement.classList.add("dz-complete"),vm.cancelAttachment(),ngNotify.set(message,{type:"error",duration:1e3,theme:"pure"})})},sending:function(file,xhr,formData){formData.append("postID",QRMDataService.riskID),formData.append("description",vm.uploadAttachmentDescription)}}},this.riskAttachmentReady=function(dropzone,file){vm.dropzone=dropzone,vm.dzfile=file,vm.disableAttachmentButon=!1,$scope.$apply()},this.uploadAttachmentDescription="",this.disableAttachmentButon=!0,this.dropzone="",this.uploadAttachment=function(){ngNotify.set("File Is Being Uploaded and Imported. Please Standby",{type:"info",sticky:!0,theme:"pure"}),vm.dropzone.processFile(vm.dzfile)},this.cancelAttachment=function(){vm.dropzone.removeAllFiles(!0),vm.uploadAttachmentDescription=null,vm.disableAttachmentButon=!0,vm.dropzone=null,vm.dzfile=null,$scope.$apply()},this.openAuditEditor=function(){ngDialog.openConfirm({template:"registerAudit",className:"ngdialog-theme-default",scope:$scope}).then(function(value){return-1==vm.reviewType?(ngNotify.dismiss(),void ngNotify.set("Please Enter Audit Type",{type:"grimace",duration:1e3,theme:"pure"})):void remoteService.registerAudit(vm.reviewType,vm.reviewComment,vm.risk.id).then(function(response){vm.risk.audit=response.data,ngNotify.dismiss(),ngNotify.set("Audit Registered",{type:"success",duration:1e3,theme:"pure"})})["finally"](function(){vm.reviewType=-1,vm.reviewComment=""})},function(reason){vm.reviewType=-1,vm.reviewComment=""})},this.openDescriptionEditor=function(){var oTitle=vm.risk.title,oDescription=vm.risk.description;ngDialog.openConfirm({template:"editTitleModalDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){},function(reason){vm.risk.title=oTitle,vm.risk.description=oDescription})},this.openConsequenceEditor=function(){var oConsq=vm.risk.consequence;ngDialog.openConfirm({template:"editConsqModalDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){},function(reason){vm.risk.consequence=oConsq})},this.openCauseEditor=function(){var oCause=vm.risk.cause;ngDialog.openConfirm({template:"editCauseModalDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){},function(reason){vm.risk.cause=oCause})},this.openMitEditor=function(summary){var oPlan=vm.risk.mitigation.mitPlanSummary,oUpdate=vm.risk.mitigation.mitPlanSummaryUpdate;ngDialog.openConfirm({template:summary?"editMitigationModalDialogId":"editMitigationModalDialogId2",className:"ngdialog-theme-default",scope:$scope}).then(function(value){},function(reason){vm.risk.mitigation.mitPlanSummary=oPlan,vm.risk.mitigation.mitPlanSummaryUpdate=oUpdate})},this.openRespEditor=function(summary){var oPlan=vm.risk.response.respPlanSummary,oUpdate=vm.risk.response.respPlanSummaryUpdate;ngDialog.openConfirm({template:summary?"editResponseModalDialogId":"editResponseModalDialogId2",className:"ngdialog-theme-default",scope:$scope}).then(function(value){},function(reason){vm.risk.response.respPlanSummary=oPlan,vm.risk.response.respPlanSummaryUpdate=oUpdate})},this.impactChange=function(){vm.updateRisk()},this.probChange=function(){switch(vm.risk.useCalProb||(vm.risk.likeType=4,vm.risk.likePostType=4),Number(vm.risk.likeType)){case 1:vm.risk.likeT=365;break;case 2:vm.risk.likeT=30;break;case 3:break;default:vm.risk.likeT=0}switch(Number(vm.risk.likePostType)){case 1:vm.risk.likePostT=365;break;case 2:vm.risk.likePostT=30;break;case 3:break;default:vm.risk.likePostT=0}vm.risk.inherentProb=probToMatrix(calcProb(vm.risk,!0),vm.project.matrix),vm.risk.treatedProb=probToMatrix(calcProb(vm.risk,!1),vm.project.matrix),vm.updateRisk()},this.cancelRisk=function(){$state.go("qrm.explorer")},this.getRisk=function(){isNaN(vm.riskID)||0==vm.riskID||remoteService.getRisk(vm.riskID).then(function(response){vm.risk=response.data,$scope.risk=vm.risk,QRMDataService.risk=vm.risk,vm.updateRisk(),vm.setRiskMatrixID("riskEditorMatrixID"),vm.setRiskMatrix(),$timeout(function(){$scope.$apply()})})},this.newDummyRisk=function(){vm.updateRisk(),vm.risk.comments=[],vm.risk.projectID=QRMDataService.project.id,vm.risk.attachments=[],remoteService.createDummyRiskEntry(vm.risk).then(function(response){ngNotify.set("Risk Saved","success")})["finally"](function(){})},this.newDummyRisks=function(){vm.updateRisk(),vm.risk.comments=[],vm.risk.projectID=QRMDataService.project.id,vm.risk.attachments=[],remoteService.createDummyRiskEntries(vm.risk).then(function(response){ngNotify.dismiss(),ngNotify.set("Risk Saved",{type:"success",duration:1e3,theme:"pure"})})["finally"](function(){})},this.saveRisk=function(){$scope.savingrisk=!0,vm.updateRisk(),vm.risk.comments=[],vm.risk.projectID=QRMDataService.project.id,vm.risk.attachments=[],remoteService.saveRisk(vm.risk).then(function(response){return response.data.error?($scope.savingrisk=!1,void alert(response.data.msg)):(vm.risk=response.data,QRMDataService.riskID=vm.risk.riskID,QRMDataService.risk=vm.risk,vm.updateRisk(),ngNotify.dismiss(),void ngNotify.set("Risk Saved",{type:"success",duration:1e3,theme:"pure"}))})["finally"](function(){$scope.savingrisk=!1})},this.updateRisk=function(){QRM.mainController.titleBar="Risk - "+vm.risk.riskProjectCode,QRM.mainController.titleBarSM="Risk - "+vm.risk.riskProjectCode;try{vm.secCatArray=jQuery.grep(vm.project.categories,function(e){return e.name==vm.risk.primcat.name})[0].sec}catch(e){console.log(e.message)}try{vm.setRiskMatrix(vm.matrixDIVID)}catch(e){console.log(e.message)}try{vm.stakeholders=[],vm.stakeholders.push({name:vm.risk.owner,role:"Risk Owner"}),vm.stakeholders.push({name:vm.risk.manager,role:"Risk Manager"}),vm.risk.mitigation.mitPlan.forEach(function(e){vm.stakeholders.push({name:e.person,role:"Mitigation Owner"})}),vm.risk.response.respPlan.forEach(function(e){vm.stakeholders.push({name:e.person,role:"Response Owner"})}),vm.stakeholders=vm.stakeholders.concat(vm.additionalHolders)}catch(e){console.log(e.message)}for(var arr={},i=0;i<vm.stakeholders.length;i++)arr[vm.stakeholders[i].name+vm.stakeholders[i].role]=vm.stakeholders[i];var temp=new Array;for(var key in arr)temp.push(arr[key]);vm.stakeholders=temp;try{vm.risk.useCalProb||(vm.risk.likeType=4,vm.risk.likePostType=4);var index=Math.floor(vm.risk.treatedProb-1)*vm.project.matrix.maxImpact+Math.floor(vm.risk.treatedImpact-1);index=Math.min(index,vm.project.matrix.tolString.length-1),vm.risk.treatedTolerance=vm.project.matrix.tolString.substring(index,index+1),index=Math.floor(vm.risk.inherentProb-1)*vm.project.matrix.maxImpact+Math.floor(vm.risk.inherentImpact-1),index=Math.min(index,vm.project.matrix.tolString.length-1),vm.risk.inherentTolerance=vm.project.matrix.tolString.substring(index,index+1),vm.risk.treated?(vm.risk.currentProb=vm.risk.treatedProb,vm.risk.currentImpact=vm.risk.treatedImpact,vm.risk.currentTolerance=vm.risk.treatedTolerance):(vm.risk.currentProb=vm.risk.inherentProb,vm.risk.currentImpact=vm.risk.inherentImpact,vm.risk.currentTolerance=vm.risk.inherentTolerance),vm.risk.useCalProb?(vm.inherentAbsProb=calcProb(vm.risk,!0),vm.treatedAbsProb=calcProb(vm.risk,!1)):(vm.treatedAbsProb=probFromMatrix(vm.risk.treatedProb,vm.project.matrix),vm.inherentAbsProb=probFromMatrix(vm.risk.inherentProb,vm.project.matrix)),vm.risk.inherentAbsProb=vm.inherentAbsProb,vm.risk.treatedAbsProb=vm.treatedAbsProb}catch(e){alert("Error"+e.message)}var panelClass;switch(Number(vm.risk.currentTolerance)){case 5:panelClass="panel-danger";break;case 4:panelClass="panel-warning";break;case 3:panelClass="panel-sig";break;case 2:panelClass="panel-info";break;case 1:panelClass="panel-success"}jQuery("div.panel").removeClass("panel-info").removeClass("panel-warning").removeClass("panel-success").removeClass("panel-danger").removeClass("panel-sig").addClass(panelClass),jQuery("#exposure").daterangepicker({format:"MMMM D, YYYY",separator:" - ",showDropdowns:!0,drops:"down",opens:"left"},function(start,end,label){try{angular.element("#exposure").controller().updateDates(start,end)}catch(e){console.log(e.message)}});var s=moment(vm.risk.start),e=moment(vm.risk.end);try{jQuery("#exposure").data("daterangepicker").setStartDate(s),jQuery("#exposure").data("daterangepicker").setEndDate(e)}catch(e){}},this.updateDates=function(start,end){vm.risk.start=start,vm.risk.end=end,vm.updateRisk()},this.setRiskMatrixID=function(matrixDIVID){QRMDataService.matrixDIVID=matrixDIVID},this.setRiskMatrix=function(){setRiskEditorMatrix(vm.risk,vm.project.matrix,QRMDataService.matrixDIVID,QRMDataService.matrixDisplayConfig,vm.dragStart,vm.drag,vm.dragEnd)},this.dragEnd=function(d){vm.risk.useCalProb=!1,vm.risk.liketype=4,vm.risk.likepostType=4,d.treated?(vm.risk.treatedProb=Number(d.prob),vm.risk.treatedImpact=Number(d.impact)):(vm.risk.inherentProb=Number(d.prob),vm.risk.inherentImpact=Number(d.impact)),vm.updateRisk(),$scope.$apply()},this.dragStart=function(d){vm.risk.useCalProb=!1,vm.risk.useCalProb=!1,vm.risk.liketype=4,vm.risk.likepostType=4},this.drag=function(){},this.addMit=function(){vm.risk.mitigation.mitPlan.push({description:"No Description of the Action Entered ",person:-1,cost:0,complete:0,due:new Date})},this.addResp=function(){vm.risk.response.respPlan.push({description:"No Description of the Action Entered ",person:-1,cost:0})},this.addControl=function(){var control={description:"No Description of the Control Entered ",effectiveness:"No Assigned Effectiveness",contribution:"No Contribution Entered"};vm.risk.controls?vm.risk.controls.push(control):vm.risk.controls=[control]},this.addComment=function(s){$scope.data.comment="",ngDialog.openConfirm({template:"addCommentModalDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){remoteService.addGeneralComment($scope.data.comment,QRMDataService.riskID).then(function(response){return response.data.error?void alert(response.data.msg):(ngNotify.dismiss(),ngNotify.set("Comment Added To Risk",{type:"success",duration:1e3,theme:"pure"}),void(vm.risk.comments=response.data))})},function(reason){})},this.addCommentSm=function(){remoteService.addGeneralComment($scope.data.comment,QRMDataService.riskID).then(function(response){return response.data.error?void alert(response.data.msg):(ngNotify.dismiss(),ngNotify.set("Coment Added To Risk",{type:"success",duration:1e3,theme:"pure"}),void(vm.risk.comments=response.data))}),$scope.data.comment=""},this.editMitStep=function(s){var key=s.$$hashKey;s.due=new Date(s.due);var oldStepObject=jQuery.extend(!0,{},s);$scope.step=s,ngDialog.openConfirm({template:"editMitStepModalDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){},function(reason){var stepObj=jQuery.grep(vm.risk.mitigation.mitPlan,function(e){return e.$$hashKey==key})[0];stepObj.complete=oldStepObject.complete,stepObj.cost=oldStepObject.cost,stepObj.description=oldStepObject.description,stepObj.due=oldStepObject.due,stepObj.person=oldStepObject.person})},this.editControl=function(s){var key=s.$$hashKey,oldStepObject=jQuery.extend(!0,{},s);$scope.control=s,$scope.effectArray=["Ad Hoc","Repeatable","Defined","Managed","Optimising"],$scope.contribArray=["Minimal","Minor","Significant","Major"],ngDialog.openConfirm({template:"editControlModalDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){},function(reason){var stepObj=jQuery.grep(vm.risk.controls,function(e){return e.$$hashKey==key})[0];stepObj.effectiveness=oldStepObject.effectiveness,stepObj.description=oldStepObject.description,stepObj.contribution=oldStepObject.contribution})},this.editRespStep=function(s){var key=s.$$hashKey;s.due=new Date(s.due);var oldStepObject=jQuery.extend(!0,{},s);$scope.step=s,ngDialog.openConfirm({template:"editRespStepModalDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){},function(reason){var stepObj=jQuery.grep(vm.risk.response.respPlan,function(e){return e.$$hashKey==key})[0];stepObj.cost=oldStepObject.cost,stepObj.description=oldStepObject.description,stepObj.person=oldStepObject.person})},this.deleteMitStep=function(s){ngDialog.openConfirm({template:"deleteMitStepModalDialogId",className:"ngdialog-theme-default"}).then(function(value){for(var i=0;i<vm.risk.mitigation.mitPlan.length;i++)if(vm.risk.mitigation.mitPlan[i].$$hashKey==s.$$hashKey){vm.risk.mitigation.mitPlan.splice(i,1);break}})},this.deleteRespStep=function(s){ngDialog.openConfirm({template:"deleteRespStepModalDialogId",className:"ngdialog-theme-default"}).then(function(value){for(var i=0;i<vm.risk.response.respPlan.length;i++)if(vm.risk.response.respPlan[i].$$hashKey==s.$$hashKey){vm.risk.response.respPlan.splice(i,1);break}})},this.deleteControl=function(s){ngDialog.openConfirm({template:"deleteControlModalDialogId",className:"ngdialog-theme-default"}).then(function(value){for(var i=0;i<vm.risk.controls.length;i++)if(vm.risk.controls[i].$$hashKey==s.$$hashKey){vm.risk.controls.splice(i,1);break}})},this.rowStyle=function(e){return{"margin-left":15*e.$$treeLevel+"px"}},this.getPanelColor=function(x){return"undefined"==typeof vm.risk?!1:"danger"==x&&5==vm.risk.currentTolerance?!0:"warning"==x&&4==vm.risk.currentTolerance?!0:"sig"==x&&3==vm.risk.currentTolerance?!0:"info"==x&&2==vm.risk.currentTolerance?!0:"success"==x&&1==vm.risk.currentTolerance?!0:!1},$scope.riskReport=function(reportID){$scope.reportReqID<0||remoteService.getReportRiskJSON([vm.riskID],vm.risk.projectID,!1,!1,$scope.reportReqID).then(function(response){"OK"==response.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(response.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(QRMDataService.userEmail),jQuery('input[name="reportID"]').val($scope.reportReqID),jQuery("#reportForm").attr("action",response.data.reportServerURL+"/report"),jQuery("#reportForm").submit())})},this.showDummy=function(){return!1},this.init=function(){return QRMDataService.passRisk?(vm.risk=QRMDataService.pRisk,$scope.risk=vm.risk,QRMDataService.risk=vm.risk,vm.updateRisk(),vm.setRiskMatrixID("riskEditorMatrixID"),vm.setRiskMatrix(),$timeout(function(){$scope.$apply()}),QRMDataService.passRisk=!1,winWidth=jQuery(window).innerWidth()-10,void jQuery("#container").css("width",winWidth+"px")):("risk"==postType?(vm.categories=QRMDataService.catData,vm.objectives=QRMDataService.projectObjectives,$scope.siteUsers=QRMDataService.siteUsers,vm.riskID=postID,vm.getRisk(),postType=null):-1==QRMDataService.riskID?(vm.risk=QRMDataService.getTemplateRisk(),vm.risk.inherentProb=vm.project.matrix.maxProb+.5,vm.risk.inherentImpact=vm.project.matrix.maxImpact+.5,$scope.risk=vm.risk,vm.updateRisk(),vm.setRiskMatrixID("riskEditorMatrixID"),vm.setRiskMatrix()):this.getRisk(),winWidth=jQuery(window).innerWidth()-10,void jQuery("#container").css("width",winWidth+"px"))},null!=QRMDataService.siteUsers?(QRMDataService.siteUsers.forEach(function(e){$scope.siteUsers.push(e.ID)}),vm.init()):vm.init()}function CalenderController($scope,QRMDataService,$state,remoteService){QRM.mainController.titleBar="QRM Exposure Calender - "+QRMDataService.project.title,QRM.mainController.titleBarSM="QRM Exposure Calender",qrm.calenderController=this;var cal=this;this.project=QRMDataService.project,this.childProjects=!1,$scope.$watch("cal.childProjects",function(){cal.getRisks()},!0),this.showDesc=!1,this.riskProjectCode="",this.title="",this.description="",this.status={val:0},this.showFilters=function(){jQuery("#calenderFilter").slideDown("slow")},this.closeFilters=function(){jQuery("#calenderFilter").slideUp("slow")},this.owner="",this.manager="";var tasks=new Array,taskNames=new Array;this.ownerSelect=function(){cal.manager="",cal.stateSelectorChanged()},this.managerSelect=function(){cal.owner="",cal.stateSelectorChanged()},this.clearFilters=function(){cal.manager="",cal.owner="",cal.status.val=0,cal.stateSelectorChanged()},this.stateSelectorChanged=function(){var datePass=new Array,now=new Date;cal.risks.forEach(function(risk){switch(Number(cal.status.val)){case 0:datePass.push(risk);break;case 1:moment(risk.end)<now&&datePass.push(risk);break;case 2:moment(risk.start)>now&&datePass.push(risk);break;case 3:moment(risk.start)<now&&moment(risk.end)>now&&datePass.push(risk)}});var managerPass=new Array;datePass.forEach(function(risk){(risk.manager==cal.manager||""==cal.manager)&&managerPass.push(risk)});var ownerPass=new Array;managerPass.forEach(function(risk){(risk.owner==cal.owner||""==cal.owner)&&ownerPass.push(risk)}),cal.layoutCalender(ownerPass),jQuery("#calenderFilter").slideUp("slow")},this.editRisk=function(id){QRMDataService.riskID=id,$state.go("qrm.risk")},this.getRisks=function(){remoteService.getAllProjectRisks(QRMDataService.project.id,cal.childProjects).then(function(response){cal.risks=response.data,cal.layoutCalender(cal.risks)})},this.layoutCalender=function(risks){tasks=new Array,taskNames=new Array,risks.forEach(function(risk){tasks.push({startDate:moment(risk.start),endDate:moment(risk.end),taskName:risk.riskProjectCode,status:"RUNNING",riskID:risk.id,title:risk.title})});var now=new Date;tasks.sort(function(a,b){return a.startDate-b.startDate}),tasks.forEach(function(task){task.startDate>now?task.className="future":task.endDate<now?task.className="past":task.className="now",taskNames.push(task.taskName)}),d3.select("#svgcalID").selectAll("svg").remove();var gantt=d3.gantt(cal).taskTypes(taskNames).tickFormat("%b %Y");gantt(tasks,"#svgcalID",jQuery("#svgcalID").width(),jQuery("#svgcalID").height())},this.getRisks(),this.resize=function(){d3.select("#svgcalID").selectAll("svg").remove();var gantt=d3.gantt(cal).taskTypes(taskNames).tickFormat("%b %Y");gantt(tasks,"#svgcalID",jQuery("#svgcalID").width(),jQuery("#svgcalID").height())},this.toolTip=function(d){d?(cal.showDesc=!0,cal.startDate=moment(d.startDate).format("MMM DD, gggg"),cal.endDate=moment(d.endDate).format("MMM DD, gggg"),cal.title=d.title,cal.taskName=d.taskName):(cal.showDesc=!1,cal.startDate=null,cal.endDate=null,cal.taskName=null,cal.title=null),$scope.$apply()}}function ReportArchiveController($scope,QRMDataService,remoteService,ngNotify,$http,$state,uiGridConstants){QRM.mainController.titleBar="QRM Report Archive",QRM.mainController.titleBarSM="QRM Report Archive";var repController=this;$scope.userEmail=QRMDataService.userEmail,$scope.reportServerURL=QRMDataService.reportServerURL,$scope.userLogin=QRMDataService.userLogin,$scope.siteKey=QRMDataService.siteKey,this.getTableHeight=function(){return{height:"calc(100vh - 100px)"}},this.getTableHeightSM=function(){return{height:"calc(100vh - 105px)"}},this.gridOptions={enableSorting:!0,columnDefs:[{name:"Title",width:"*",cellClass:"compact",field:"reportTitle"},{name:"Submitted Date",width:180,field:"submittedDate",sort:{direction:uiGridConstants.DESC}},{name:"Completed Date",width:180,field:"completedDate"},{name:"Complete",width:100,field:"completed",cellTemplate:'<i style="color:green" ng-show="grid.appScope.formatCompletedCol(row, true)" class="fa fa-check"></i><i  style="color:red" ng-show="grid.appScope.formatCompletedCol(row, false)" class="fa fa-close"></i>',
cellClass:"cellCentered"},{name:"Download",width:130,field:"id",cellTemplate:'<div><a href="{{grid.appScope.reportServerURL}}/getReport?userEmail={{grid.appScope.userEmail}}&userLogin={{grid.appScope.userLogin}}&siteKey={{grid.appScope.siteKey}}&id={{row.entity.id}}" >Download</a></div>',cellClass:"cellCentered",headerCellClass:"cellCentered",enableSorting:!1,enableHiding:!1},{name:"Remove",width:130,field:"id",cellTemplate:'<div><a ng-click="grid.appScope.reportReqID = row.entity.id;grid.appScope.removeReport()" href="#">Remove</a></div>',cellClass:"cellCentered",headerCellClass:"cellCentered",enableSorting:!1,enableHiding:!1}]},this.gridOptionsSM={enableSorting:!0,rowTemplate:'<div ng-click="grid.appScope.editIncident(row.entity.id)" style="cursor:pointer" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',columnDefs:[{name:"Title",width:"*",cellClass:"compact",field:"reportTitle"},{name:"Submitted Date",width:180,field:"submittedDate",sort:{direction:uiGridConstants.DESC}},{name:"Download",width:130,field:"id",cellTemplate:'<div><a href="{{grid.appScope.reportServerURL}}/getReport?userEmail={{grid.appScope.userEmail}}&userLogin={{grid.appScope.userLogin}}&siteKey={{grid.appScope.siteKey}}&id={{row.entity.id}}">Download</a></div>',cellClass:"cellCentered",headerCellClass:"cellCentered",enableSorting:!1,enableHiding:!1}]},$scope.formatCompletedCol=function(row,check){return row.entity.completed&&check?!0:row.entity.completed||check?!1:!0},this.refresh=function(){var url=QRMDataService.reportServerURL+"/userReports?callback=JSON_CALLBACK&userEmail="+QRMDataService.userEmail+"&userLogin="+QRMDataService.userLogin+"&siteKey="+QRMDataService.siteKey+"&siteID="+QRMDataService.siteID;$http.jsonp(url).success(function(data){data.error?(ngNotify.dismiss(),ngNotify.set(data.error,{type:"grimace",sticky:!0,position:"top",theme:"pure"}),$state.go("qrm.explorer")):(repController.gridOptions.data=data,repController.gridOptionsSM.data=data)}).error(function(data){ngNotify.dismiss(),ngNotify.set("Failed To Connect To The Report Server",{type:"grimace",duration:1e3,theme:"pure"})})},$scope.removeReport=function(){var url=QRMDataService.reportServerURL+"/removeReport?callback=JSON_CALLBACK&id="+$scope.reportReqID+"&userEmail="+QRMDataService.userEmail+"&userLogin="+QRMDataService.userLogin+"&siteKey="+QRMDataService.siteKey+"&siteID="+QRMDataService.siteID;$http.jsonp(url).success(function(data){data.error?(ngNotify.dismiss(),ngNotify.set(data.error,{type:"grimace",duration:1e3,theme:"pure"})):(repController.gridOptions.data=data,repController.gridOptionsSM.data=data)}).error(function(data){ngNotify.dismiss(),ngNotify.set("Error Retrieving Archived Reports",{type:"grimace",duration:1e3,theme:"pure"})})},this.refresh()}function RankController($scope,QRMDataService,$state,remoteService,ngNotify){QRM.mainController.titleBar="QRM Risk Ranking - "+QRMDataService.project.title,QRM.mainController.titleBarSM="QRM Risk Ranking",qrm.rankController=this;var myLayout,rank=this;this.project=QRMDataService.project,this.editRisk=function(id){QRMDataService.riskID=id,$state.go("qrm.risk")},this.showInstructions=!0,this.saveChanges=function(){myLayout.normaliseRanks(),remoteService.saveRankOrder(myLayout.items).then(function(response){return response.data.error?void alert(response.data.msg):(ngNotify.dismiss(),void ngNotify.set("Rank Order Saved",{type:"success",duration:1e3,theme:"pure"}))})},this.cancelChanges=function(){this.loadGrid()},$scope.getMyCtrlScope=function(){return $scope},$scope.riskReport=function(reportID){$scope.reportReqID<0||(QRM.mainController.notify("Assembling Data for Report",5e3),remoteService.getReportRiskJSON([],QRMDataService.project.id,!1,!0,$scope.reportReqID).then(function(response){QRM.mainController.notify("Sending Data for Processing",5e3),"OK"==response.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(response.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(QRMDataService.userEmail),jQuery('input[name="reportID"]').val($scope.reportReqID),jQuery("#reportForm").attr("action",response.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}))},this.loadGrid=function(){QRM.mainController.titleBar="Risk Ranking - "+QRMDataService.project.title,remoteService.getAllProjectRisks(QRMDataService.project.id,rank.childProjects).then(function(response){var risks=response.data;rank.dirty=!1,rank.risks=risks,rank.layout=new SorterLayout(rank,$scope),myLayout=rank.layout,myLayout.setHeight(jQuery("#subRankSVGDiv").height()),myLayout.setWidth(jQuery("#subRankSVGDiv").width()),myLayout.setItemHeight(35),myLayout.setItemWidth(jQuery("#subRankSVGDiv").width()/2),myLayout.scale(1,1),myLayout.setItems(rank.risks),myLayout.setSVGDiv("subRankSVGDiv"),myLayout.setDirtyListener(function(){rank.dirty=!0}),myLayout.layoutTable()})};var winWidth=jQuery(window).innerWidth()-10;jQuery("#container").css("width",winWidth+"px"),this.loadGrid(),this.resize=function(){myLayout.setHeight(jQuery("#subRankSVGDiv").height()),myLayout.setWidth(jQuery("#subRankSVGDiv").width()),myLayout.setItemHeight(35),myLayout.setItemWidth(jQuery("#subRankSVGDiv").width()/2),myLayout.scale(1,1),myLayout.setSVGDiv("subRankSVGDiv"),myLayout.layoutTable()}}function AnalysisController($scope,QRMDataService,remoteService){QRM.mainController.titleBar="QRM Analysis Tools"+QRMDataService.project.title,QRM.mainController.titleBarSM="QRM Analysis Tools",$scope.projectTitle=QRMDataService.project.title;var ac=this;if($scope.getTableHeight=function(){return{height:"calc(100vh - 100px)"}},$scope.typeSelect=function(type){switch($scope.chartName=type.name,d3.select("#chart svg").remove(),d3.select("#chart").append("svg"),ac.chart=nv.models.multiBarHorizontalChart().x(function(d){return d.label}).y(function(d){return d.value}).margin({top:30,right:20,bottom:50,left:100}).stacked(!0),window.innerWidth>768?(ac.chart.showControls(!0),ac.chart.showLegend(!0)):(ac.chart.showControls(!1),ac.chart.showLegend(!1)),type.id){case"ownerT":nv.addGraph(function(){return ac.chart.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),ac.chart.xAxis.axisLabel("Risk Owner").axisLabelDistance(30),d3.select("#chart svg").datum(QRMDataService.owners).call(ac.chart),nv.utils.windowResize(ac.chart.update),ac.chart});break;case"managerT":nv.addGraph(function(){return ac.chart.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),ac.chart.xAxis.axisLabel("Risk Manager").axisLabelDistance(30),d3.select("#chart svg").datum(QRMDataService.managers).call(ac.chart),nv.utils.windowResize(ac.chart.update),ac.chart});break;case"cat":nv.addGraph(function(){return ac.chart.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),ac.chart.xAxis.axisLabel("Risk Category").axisLabelDistance(30),d3.select("#chart svg").datum(QRMDataService.categories).call(ac.chart),nv.utils.windowResize(ac.chart.update),ac.chart});break;case"status":nv.addGraph(function(){return ac.chart.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),ac.chart.xAxis.axisLabel("Risk Status").axisLabelDistance(30),d3.select("#chart svg").datum(QRMDataService.status).call(ac.chart),nv.utils.windowResize(ac.chart.update),ac.chart})}},$scope.chartName="Risk Owner/Tolerance Allocation",$scope.data=[{name:"Risk Owner/Tolerance Allocation",id:"ownerT"},{name:"Risk Manager/Tolerance Allocation",id:"managerT"},{name:"Category Allocation",id:"cat"},{name:"Status Allocation",id:"status"}],$scope.gridOptions={enableSorting:!1,rowTemplate:'<div ng-click="grid.appScope.typeSelect(row.entity)" style="cursor:ponter" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',columnDefs:[{name:"Type",field:"name",enableFilering:!1,enableSorting:!1,enableHiding:!1,cellClass:"cellPointer"}],data:$scope.data},QRMDataService.analyseRisks(),jQuery(window).width()<768){var numUsers=QRMDataService.siteUsers.length+1;d3.select("#analysisCharts").append("div").attr("id","chart1").attr("class","col-lg-12").append("svg").style("height",20*numUsers+80+"px"),ac.chart1=nv.models.multiBarHorizontalChart().x(function(d){return d.label}).y(function(d){return d.value}).margin({top:30,right:20,bottom:50,left:100}).stacked(!0).showControls(!1).showLegend(!1),nv.addGraph(function(){return ac.chart1.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),ac.chart1.xAxis.axisLabel("Risk Owner").axisLabelDistance(30),d3.select("#chart1 svg").datum(QRMDataService.owners).call(ac.chart1),nv.utils.windowResize(ac.chart1.update),ac.chart1}),d3.select("#analysisCharts").append("div").attr("id","chart2").attr("class","col-lg-12").append("svg").style("height",20*numUsers+80+"px"),ac.chart2=nv.models.multiBarHorizontalChart().x(function(d){return d.label}).y(function(d){return d.value}).margin({top:30,right:20,bottom:50,left:100}).stacked(!0).showControls(!1).showLegend(!1),nv.addGraph(function(){return ac.chart2.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),ac.chart2.xAxis.axisLabel("Risk Manager").axisLabelDistance(30),d3.select("#chart2 svg").datum(QRMDataService.managers).call(ac.chart2),nv.utils.windowResize(ac.chart2.update),ac.chart2}),d3.select("#analysisCharts").append("div").attr("id","chart3").attr("class","col-lg-12").append("svg").style("height",20*QRMDataService.catData.length+80+"px"),ac.chart3=nv.models.multiBarHorizontalChart().x(function(d){return d.label}).y(function(d){return d.value}).margin({top:30,right:20,bottom:50,left:100}).stacked(!0).showControls(!1).showLegend(!1),nv.addGraph(function(){return ac.chart3.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),ac.chart3.xAxis.axisLabel("Risk Category").axisLabelDistance(30),d3.select("#chart3 svg").datum(QRMDataService.categories).call(ac.chart3),nv.utils.windowResize(ac.chart3.update),ac.chart3}),d3.select("#analysisCharts").append("div").attr("id","chart4").attr("class","col-lg-12").append("svg").style("height","140px"),ac.chart4=nv.models.multiBarHorizontalChart().x(function(d){return d.label}).y(function(d){return d.value}).margin({top:30,right:20,bottom:50,left:100}).stacked(!0).showControls(!1).showLegend(!1),nv.addGraph(function(){return ac.chart4.yAxis.axisLabel("Number of Risks").tickFormat(d3.format(",.2f")),ac.chart4.xAxis.axisLabel("Risk Status").axisLabelDistance(30),d3.select("#chart4 svg").datum(QRMDataService.status).call(ac.chart4),nv.utils.windowResize(ac.chart3.update),ac.chart4})}else $scope.typeSelect($scope.gridOptions.data[0])}function RelMatrixController($scope,QRMDataService,remoteService,ngNotify){QRM.mainController.titleBar="QRM Tolerance Matrix - "+QRMDataService.project.title,QRM.mainController.titleBarSM="QRM Tolerance Matrix";var relMatrixCtrl=this;qrm.matrixController=this,this.project=QRMDataService.project,this.status={val:0},this.showDesc=!1,this.riskProjectCode="",this.title="",this.description="",this.owner="",this.manager="",this.selectedRisk="",this.currentItems=new Array,this.matrixDirty=!1,this.editorChanges=!1,this.transMatrix=[1,0,0,1,45,45],this.stateSelectorChanged=function(){jQuery("#matrixFilter").slideUp("slow"),relMatrixCtrl.risks.forEach(function(risk){risk.x=0,risk.y=0});var maxProb=QRMDataService.project.matrix.maxProb;d3.selectAll("g.state").transition().duration(2e3).attr("transform",function(d,i){var prob=null,impact=null;switch(Number(relMatrixCtrl.status.val)){case 0:d.treated?(prob=d.treatedClean?d.treatedProb:d.newTreatedProb,impact=d.treatedClean?d.treatedImpact:d.newTreatedImpact):(prob=d.untreatedClean?d.inherentProb:d.newInherentProb,impact=d.untreatedClean?d.inherentImpact:d.newInherentImpact);break;case 1:d.untreatedClean?(prob=d.inherentProb,impact=d.inherentImpact):(prob=d.newInherentProb,impact=d.newInherentImpact);break;case 2:d.treatedClean?(prob=d.treatedProb,impact=d.treatedImpact):(prob=d.newTreatedProb,impact=d.newTreatedImpact)}var x=(impact-1)*QRMDataService.relMatrixGridSizeX,y=(maxProb+1-prob)*QRMDataService.relMatrixGridSizeY;return d.x=x,d.y=y,relMatrixCtrl.risks.forEach(function(risk){Math.abs(risk.x-d.x)<10&&Math.abs(risk.y-d.y)<10&&risk.id!=d.id&&(d.x+=5,d.y+=5)}),"translate("+[d.x,d.y]+")"});var state="Current State";switch(Number(relMatrixCtrl.status.val)){case 0:state="Current State";break;case 1:state="Un Treated State";break;case 2:state="Treated State"}d3.select("#relMatrixSubHeading").text(state)},this.showFilters=function(){jQuery("#matrixFilter").slideDown("slow")},this.closeFilters=function(){jQuery("#matrixFilter").slideUp("slow")},this.cancelChanges=function(){this.matrixDirty=!1,this.risks.forEach(function(risk){risk.untreatedClean=!0,risk.treatedClean=!0,risk.dirty=!1}),this.stateSelectorChanged()},this.saveChangesWrapper=function(){this.saveChanges(!1)},this.saveChanges=function(switchTab,tabPanel,newCard,newProjectID){var relMatChanges=new Array;return this.risks.forEach(function(item){if(item.dirty){var newTreatedImpact=item.treatedClean?item.treatedImpact:item.newTreatedImpact,newTreatedProb=item.treatedClean?item.treatedProb:item.newTreatedProb,newInherentImpact=item.untreatedClean?item.inherentImpact:item.newInherentImpact,newInherentProb=item.untreatedClean?item.inherentProb:item.newInherentProb,index=Math.floor(newTreatedProb-1)*QRMDataService.project.matrix.maxImpact+Math.floor(newTreatedImpact-1);index=Math.min(index,QRMDataService.project.matrix.tolString.length-1);var treatedTolerance=QRMDataService.project.matrix.tolString.substring(index,index+1);index=Math.floor(newInherentProb-1)*QRMDataService.project.matrix.maxImpact+Math.floor(newInherentImpact-1),index=Math.min(index,QRMDataService.project.matrix.tolString.length-1);var inherentTolerance=QRMDataService.project.matrix.tolString.substring(index,index+1);relMatChanges.push({riskID:item.id,newTreatedImpact:newTreatedImpact,newTreatedProb:newTreatedProb,newInherentImpact:newInherentImpact,newInherentProb:newInherentProb,treatedTolerance:treatedTolerance,inherentTolerance:inherentTolerance})}}),relMatChanges.length<1?(ngNotify.dismiss(),void ngNotify.set("There Were No Changes To Save",{type:"grimace",duration:1e3,theme:"pure"})):void remoteService.updateRisksRelMatrix(relMatChanges).then(function(response){return response.data.error?void alert(response.data.msg):(relMatrixCtrl.risks.forEach(function(item){item.treatedImpact=item.treatedClean?item.treatedImpact:item.newTreatedImpact,item.treatedProb=item.treatedClean?item.treatedProb:item.newTreatedProb,item.inherentImpact=item.untreatedClean?item.inherentImpact:item.newInherentImpact,item.inherentProb=item.untreatedClean?item.inherentProb:item.newInherentProb,item.treatedClean=!0,item.untreatedClean=!0,item.dirty=!1}),ngNotify.dismiss(),void ngNotify.set("Changes to Probability/Impact Have Been Saved",{type:"success",duration:1e3,theme:"pure"}))})},this.getState=function(){return Number(this.status.val)},this.ownerSelect=function(){relMatrixCtrl.manager="",relMatrixCtrl.selectedRisk="";var filteredRisks=new Array;this.risks.forEach(function(risk){risk.owner==relMatrixCtrl.owner&&(risk.x=0,risk.y=0,filteredRisks.push(risk))}),jQuery("#matrixFilter").slideUp("slow"),this.svgMatrix(filteredRisks)},this.managerSelect=function(){relMatrixCtrl.owner="",relMatrixCtrl.selectedRisk="";var filteredRisks=new Array;this.risks.forEach(function(risk){risk.manager==relMatrixCtrl.manager&&(risk.x=0,risk.y=0,filteredRisks.push(risk))}),jQuery("#matrixFilter").slideUp("slow"),this.svgMatrix(filteredRisks)},this.riskSelect=function(){jQuery("#matrixFilter").slideUp("slow"),relMatrixCtrl.owner="",relMatrixCtrl.manager="",relMatrixCtrl.risks.forEach(function(risk){risk.x=0,risk.y=0}),this.svgMatrix(relMatrixCtrl.risks);var riskID="#riskID"+relMatrixCtrl.selectedRisk.id,g=d3.select(riskID);g.node().parentNode.appendChild(g.node()),g.select("circle.inner").transition().duration(500).styleTween("fill",function(){return d3.interpolate("white","black")}).attr("r","40").transition().duration(500).styleTween("fill",function(){return d3.interpolate("black","white")}).attr("r","25").transition().duration(500).styleTween("fill",function(){return d3.interpolate("white","black")}).attr("r","40").transition().duration(500).styleTween("fill",function(){return d3.interpolate("black","white")}).attr("r","25").transition().duration(500).styleTween("fill",function(){return d3.interpolate("white","black")}).attr("r","40").transition().duration(500).styleTween("fill",function(){return d3.interpolate("black","white")}).attr("r","25"),relMatrixCtrl.showDesc=!1,relMatrixCtrl.selectedRisk=""},this.resizePanel=function(){this.svgMatrix(this.risks)},this.clearFilters=function(){relMatrixCtrl.manager="",relMatrixCtrl.owner="",relMatrixCtrl.selectedRisk="",relMatrixCtrl.risks.forEach(function(risk){risk.x=0,risk.y=0}),this.resetPZ(),this.svgMatrix(this.risks),this.closeFilters()},this.pan=function(dx,dy){this.transMatrix[4]+=dx,this.transMatrix[5]+=dy;var newMatrix="matrix("+this.transMatrix.join(" ")+")";d3.select("g.relMatrixGroupHolder").attr("transform",newMatrix)},this.zoom=function(scale){for(var i=0;i<this.transMatrix.length;i++)this.transMatrix[i]*=scale;var newMatrix="matrix("+this.transMatrix.join(" ")+")";d3.select("g.relMatrixGroupHolder").attr("transform",newMatrix)},this.resetPZ=function(){this.transMatrix[0]=1,this.transMatrix[1]=0,this.transMatrix[2]=0,this.transMatrix[3]=1,this.transMatrix[4]=45,this.transMatrix[5]=45;var newMatrix="matrix("+this.transMatrix.join(" ")+")";d3.select("g.relMatrixGroupHolder").attr("transform",newMatrix)},this.svgMatrix=function(risks){for(var tolString=QRMDataService.project.matrix.tolString,maxImpact=QRMDataService.project.matrix.maxImpact,maxProb=QRMDataService.project.matrix.maxProb,divWidth=jQuery("#relMatrixSVGDiv").width(),divHeight=jQuery("#relMatrixSVGDiv").height(),margin={top:45,right:27,bottom:45,left:27},width=divWidth-margin.left-margin.right,height=divHeight-margin.top-margin.bottom,data=new Array,prob=maxProb;prob>0;prob--)for(var impact=1;maxImpact>=impact;impact++){var index=(prob-1)*maxImpact+impact-1,tol=tolString.substring(index,index+1);data.push({impact:impact,prob:prob,tol:tol})}var gridSizeX=Math.floor(width/maxImpact),gridSizeY=Math.floor(height/maxProb);QRMDataService.relMatrixGridSizeX=gridSizeX,QRMDataService.relMatrixGridSizeY=gridSizeY,d3.select("#relMatrixSVGDiv svg").remove();var topSVG=d3.select("#relMatrixSVGDiv").append("svg").attr("class","relMatrixGroupHolderTop").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom);topSVG.append("defs").append("style").attr("type","text/css").text("rect.tolNoHover5 {fill: #ed5565;stroke: #E6E6E6;stroke-width: 2px; }rect.tolNoHover4 {fill: #f8ac59;stroke: #E6E6E6;stroke-width: 2px; }rect.tolNoHover3 {fill: #ffff55;stroke: #E6E6E6;stroke-width: 2px; }rect.tolNoHover2 {fill: #1ab394;stroke: #E6E6E6;stroke-width: 2px; }rect.tolNoHover1 {fill: #1c84c6; stroke: #E6E6E6; stroke-width: 2px; }g.state circle {stroke  : gray; cursor  : pointer;}g.state circle.inner { fill : white;}g.state circle.outer { display : none; stroke-dasharray: 4px;  stroke-opacity  : 0.5;}text.chartTitle { fill:rgb(103,106,108) }g.state text.untreated { fill:red; font: 12px sans-serif; font-weight : bold; pointer-events : none; }g.state text.treated { fill:blue; font: 12px sans-serif; font-weight : bold; pointer-events : none; }");var svg=topSVG.append("g").attr("class","relMatrixGroupHolder").attr("transform","translate("+margin.left+","+margin.top+") "),heatMap=svg.selectAll().data(data).enter().append("g").attr("class","tolCellNoHover");switch(heatMap.append("rect").attr("x",function(d){return(d.impact-1)*gridSizeX}).attr("y",function(d){return(maxProb-d.prob)*gridSizeY}).attr("rx",2).attr("ry",2).attr("class",function(d){return"tolNoHover"+d.tol}).attr("width",gridSizeX).attr("height",gridSizeY),svg.append("text").attr("text-anchor","middle").style("font-size","20px").style("font-weight","normal").attr("class","chartTitle").attr("transform","translate("+[width/2,height+20]+")").text("Impact"),Number(relMatrixCtrl.status.val)){case 0:state="Current State";break;case 1:state="Un Treated State";break;case 2:state="Treated State"}topSVG.append("text").attr("text-anchor","middle").style("font-size","20px").style("font-weight","normal").attr("class","chartTitle").attr("transform","translate("+[width/2+margin.left,20]+")").text(QRMDataService.project.title),topSVG.append("text").attr("text-anchor","middle").attr("id","relMatrixSubHeading").style("font-size","15px").style("font-weight","normal").attr("class","chartTitle").attr("transform","translate("+[width/2+margin.left,38]+")").text(state),svg.append("text").attr("text-anchor","middle").style("font-size","20px").style("font-weight","normal").attr("transform","translate("+[-10,height/2]+") rotate(-90)").attr("class","chartTitle").text("Probability"),topSVG.append("g").html('<circle cx="50" cy="50" r="42" fill="white" opacity="0.75" /><path class="compass-button" onclick="qrm.matrixController.pan( 0, 50)" d="M50 10 l12   20 a40, 70 0 0,0 -24,  0z" /><path class="compass-button" onclick="qrm.matrixController.pan( 50, 0)" d="M10 50 l20  -12 a70, 40 0 0,0   0, 24z" /><path class="compass-button" onclick="qrm.matrixController.pan( 0,-50)" d="M50 90 l12  -20 a40, 70 0 0,1 -24,  0z" /><path class="compass-button" onclick="qrm.matrixController.pan(-50, 0)" d="M90 50 l-20 -12 a70, 40 0 0,1   0, 24z" /><circle class="compass" cx="50" cy="50" r="20" onclick="qrm.matrixController.resetPZ()" /><circle class="compass-button" cx="50" cy="41" r="8" onclick="qrm.matrixController.zoom(0.8)" /><circle class="compass-button" cx="50" cy="59" r="8" onclick="qrm.matrixController.zoom(1.25)" /><rect class="plus-minus" x="46" y="39.5" width="8" height="3" /><rect class="plus-minus" x="46" y="57.5" width="8" height="3" /><rect class="plus-minus" x="48.5" y="55" width="3" height="8" />').attr("transform","translate(0 0)").attr("class","hidden-xs");var drag=d3.behavior.drag().on("dragstart",function(){var e=d3.event.sourceEvent;e.ctrlKey||d3.event.sourceEvent.stopPropagation()}).on("drag",function(){var e=d3.event.sourceEvent;e.ctrlKey||d3.select(this).attr("transform",function(d,i){return d3.event.ctrlKey?void 0:(g=this.parentNode,isSelected=d3.select(g).classed("selected"),d.x+=d3.event.dx,d.y+=d3.event.dy,d.x<0&&(d.x=0),d.y<0&&(d.y=0),d.x>width&&(d.x=width),d.y>height&&(d.y=height),"translate("+[d.x,d.y]+")")})}).on("dragend",function(d){var e=d3.event.sourceEvent;if(!e.ctrlKey){d3.event.sourceEvent.stopPropagation(),relMatrixCtrl.matrixDirty=!0,d.dirty=!0;var impact=1+d.x/QRMDataService.relMatrixGridSizeX,prob=QRMDataService.project.matrix.maxProb+1-d.y/QRMDataService.relMatrixGridSizeY;switch(Number(relMatrixCtrl.status.val)){case 0:d.treated?(d.treatedClean=!1,d.newTreatedImpact=impact,d.newTreatedProb=prob):(d.untreatedClean=!1,d.newInherentImpact=impact,d.newInherentProb=prob);break;case 1:d.untreatedClean=!1,d.newInherentImpact=impact,d.newInherentProb=prob;break;case 2:d.treatedClean=!1,d.newTreatedImpact=impact,d.newTreatedProb=prob}d3.event.sourceEvent.stopPropagation()}}),radius=25,holder=svg.append("g").attr("class","risk"),gRisks=holder.selectAll().data(risks),gRisk=gRisks.enter().append("g").attr("id",function(d){return"riskID"+d.id}).attr({transform:function(d){var prob=null,impact=null;switch(Number(relMatrixCtrl.status.val)){case 0:d.treated?(prob=d.treatedClean?d.treatedProb:d.newTreatedProb,impact=d.treatedClean?d.treatedImpact:d.newTreatedImpact):(prob=d.untreatedClean?d.inherentProb:d.newInherentProb,impact=d.untreatedClean?d.inherentImpact:d.newInherentImpact);break;case 1:d.untreatedClean?(prob=d.inherentProb,impact=d.inherentImpact):(prob=d.newInherentProb,impact=d.newInherentImpact);break;case 2:d.treatedClean?(prob=d.treatedProb,impact=d.treatedImpact):(prob=d.newTreatedProb,impact=d.newTreatedImpact)}var x=(impact-1)*QRMDataService.relMatrixGridSizeX,y=(maxProb+1-prob)*QRMDataService.relMatrixGridSizeY;return d.x=x,d.y=y,relMatrixCtrl.risks.forEach(function(risk){Math.abs(risk.x-d.x)<10&&Math.abs(risk.y-d.y)<10&&risk.id!=d.id&&(d.x+=5,d.y+=5)}),"translate("+[d.x,d.y]+")"},"class":"state"});gRisk.call(drag),gRisk.append("circle").attr({r:radius+4,"class":"outer"}),gRisk.append("circle").attr({r:radius,"class":"inner"}).on("click",function(d,i){var e=d3.event,g=this.parentNode,isSelected=d3.select(g).classed("selected");e.ctrlKey||d3.selectAll("g.selected").classed("selected",!1),d3.select(g).classed("selected",!isSelected),g.parentNode.appendChild(g)}).on("mouseover",function(d){var g=this.parentNode,isSelected=d3.select(g).classed("selected");d3.selectAll("g.selected").classed("selected",!1),d3.select(g).classed("selected",!isSelected),g.parentNode.appendChild(g),relMatrixCtrl.showDesc=!0,relMatrixCtrl.riskProjectCode=d.riskProjectCode,relMatrixCtrl.title=d.title,relMatrixCtrl.description=d.description.substring(0,300),d3.select(this).style("fill","aliceblue"),$scope.$apply()}).on("mouseout",function(d){d3.select(this).style("fill","white"),d3.selectAll("g.selected").classed("selected",!1),relMatrixCtrl.showDesc=!1,$scope.$apply()}).on("click",function(d){var e=d3.event;e.ctrlKey&&(d3.event.defaultPrevented||(relMatrixCtrl.matrixDirty?msg("Open Risk","Please save or cancel existing changes before opening the risk"):relMatrixCtrl.listenForEditorChanges=!0))}),gRisk.append("text").attr({"text-anchor":"middle",y:4}).attr("class",function(d){return d.treated?"treated":"untreated"}).text(function(d){return d.riskProjectCode}),gRisk.append("title").text(function(d){return d.riskProjectCode})},this.resize=function(){relMatrixCtrl.svgMatrix(relMatrixCtrl.risks)},this.getRisksAndPlace=function(){QRM.mainController.titleBar="Tolerance Matrix - "+QRMDataService.project.title,remoteService.getAllProjectRisks(QRMDataService.project.id,relMatrixCtrl.childProjects).then(function(response){var risks=response.data;risks.forEach(function(risk){risk.untreatedClean=!0,risk.treatedClean=!0,risk.dirty=!1}),relMatrixCtrl.risks=risks,relMatrixCtrl.svgMatrix(risks)})},$scope.getMyCtrlScope=function(){return $scope},$scope.riskReport=function(reportID){$scope.reportReqID<0||(QRM.mainController.notify("Assembling Data for Report",5e3),remoteService.getReportRiskJSON([],QRMDataService.project.id,!1,!0,$scope.reportReqID).then(function(response){"OK"==response.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(response.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(QRMDataService.userEmail),jQuery('input[name="reportID"]').val($scope.reportReqID),jQuery("#reportForm").attr("action",response.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}))};var winWidth=jQuery(window).innerWidth()-10;jQuery("#container").css("width",winWidth+"px"),this.getRisksAndPlace()}function IncidentExplCtrl($scope,QRMDataService,$state,remoteService){QRM.mainController.titleBarSM="QRM Incident Explorer",QRM.mainController.titleBarSM="QRM Incident Explorer";var incident=this;this.loading=!1,$scope.formatTreatedCol=function(row,check){return row.entity.resolved&&check?!0:row.entity.resolved||check?!1:!0},this.getTableHeight=function(){return{height:"calc(100vh - 100px)"}},this.getTableHeightSM=function(){return{height:"calc(100vh - 105px)"}},this.gridOptions={enableSorting:!0,rowTemplate:'<div ng-click="grid.appScope.editIncident(row.entity.id)" style="cursor:pointer" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',columnDefs:[{width:"150",cellClass:"compact",field:"incidentCode",headerCellClass:"header-hidden"},{name:"title",width:"*",cellClass:"compact",field:"title"},{name:"Incident Date",width:140,field:"date",cellFilter:"date"},{name:"Resolved",width:70,field:"resolved",cellTemplate:'<i style="color:green" ng-show="grid.appScope.formatTreatedCol(row, true)" class="fa fa-check"></i><i  style="color:red" ng-show="grid.appScope.formatTreatedCol(row, false)" class="fa fa-close"></i>',cellClass:"cellCentered"},{name:"Reported",width:140,field:"reportedby",cellFilter:"usernameFilter"}]},this.gridOptionsSM={enableSorting:!0,rowTemplate:'<div ng-click="grid.appScope.editIncident(row.entity.id)" style="cursor:pointer" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',columnDefs:[{width:"100",cellClass:"compact",field:"incidentCode",headerCellClass:"header-hidden"},{name:"title",width:"*",cellClass:"compact",field:"title"},{name:"Resolved",width:70,field:"resolved",cellTemplate:'<i style="color:green" ng-show="grid.appScope.formatTreatedCol(row, true)" class="fa fa-check"></i><i  style="color:red" ng-show="grid.appScope.formatTreatedCol(row, false)" class="fa fa-close"></i>',cellClass:"cellCentered"}]},this.init=function(){var winWidth=jQuery(window).innerWidth()-10;jQuery("#container").css("width",winWidth+"px"),QRM.mainController.titleBar="Incidents",QRM.mainController.lookingForIncidents(),remoteService.getAllIncidents().then(function(response){incident.gridOptions.data=response.data,incident.gridOptionsSM.data=response.data,incident.gridOptions.data.length>0?QRM.mainController.incidentsFound():QRM.mainController.noIncidentsFound()})["finally"](function(){})},$scope.editIncident=function(id){incident.editIncident(id)},this.editIncident=function(id){incident.loading=!0,remoteService.getIncident(id).then(function(response){QRMDataService.incident=response.data,null!=QRMDataService.incident.risks&&QRMDataService.incident.risks.sort(SortByProjectCode),QRMDataService.incidentID=QRMDataService.incident.id,QRMDataService.incident.date=new Date(QRMDataService.incident.date),incident.loading=!1,$state.go("qrm.incident")})},this.newIncident=function(){QRMDataService.incidentID=-1,$state.go("qrm.incident")},$scope.getMyCtrlScope=function(){return $scope},$scope.incidentReport=function(reportID){$scope.reportReqID<0||(QRM.mainController.notify("Assembling Data for Report",5e3),remoteService.getReportIncidentJSON([],$scope.reportReqID).then(function(response){"OK"==response.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(response.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(QRMDataService.userEmail),jQuery('input[name="reportID"]').val(2),jQuery("#reportForm").attr("action",response.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}))},this.init()}function IncidentCtrl($scope,QRMDataService,$state,remoteService,ngNotify,ngDialog){var inc=this;this.siteUsers=[],$scope.data={},$scope.savingincident=!1,QRMDataService.siteUsers.forEach(function(e){inc.siteUsers.push(e.ID)}),$scope.dropzoneConfig={options:{url:ajaxurl+"?action=uploadFile",previewTemplate:document.querySelector("#preview-template").innerHTML,parallelUploads:1,thumbnailHeight:120,thumbnailWidth:120,maxFilesize:10,filesizeBase:1e3,autoProcessQueue:!1,thumbnail:function(file,dataUrl){if(file.previewElement){file.previewElement.classList.remove("dz-file-preview");for(var images=file.previewElement.querySelectorAll("[data-dz-thumbnail]"),i=0;i<images.length;i++){var thumbnailElement=images[i];thumbnailElement.alt=file.name,thumbnailElement.src=dataUrl}setTimeout(function(){
file.previewElement.classList.add("dz-image-preview")},1)}},init:function(){this.on("addedfile",function(file){inc.incidentAttachmentReady(this,file)}),this.on("complete",function(file){file.previewElement.classList.add("dz-complete"),inc.cancelAttachment(),ngNotify.set("Attachment Added To Incident",{type:"success",duration:1e3,theme:"pure"}),remoteService.getAttachments(inc.incident.id).then(function(response){inc.incident.attachments=response.data})}),this.on("error",function(file,message,xhr){file.previewElement.classList.add("dz-complete"),inc.cancelAttachment(),ngNotify.set(message,{type:"error",duration:1e3,theme:"pure"})})},sending:function(file,xhr,formData){formData.append("postID",QRMDataService.incidentID),formData.append("description",inc.uploadAttachmentDescription)}}},this.addRisk=function(){if("undefined"==typeof inc.incident.risks&&(inc.incident.risks=[]),null!=inc.risk.id){inc.incident.risks.push(inc.risk.id);var unq=[];jQuery.each(inc.incident.risks,function(i,el){-1==jQuery.inArray(el,unq)&&null!=el&&unq.push(el)}),inc.incident.risks=unq}inc.risk=null},this.removeRisk=function(riskID){inc.incident.risks=jQuery.grep(inc.incident.risks,function(value){return value!=riskID})},this.incidentAttachmentReady=function(dropzone,file){inc.dropzone=dropzone,inc.dzfile=file,inc.disableAttachmentButon=!1,$scope.$apply()},this.uploadAttachmentDescription="",this.disableAttachmentButon=!0,this.dropzone="",this.uploadAttachment=function(){ngNotify.set("File Is Being Uploaded and Imported. Please Standby",{type:"info",sticky:!0,theme:"pure"}),inc.dropzone.processFile(inc.dzfile)},this.cancelAttachment=function(){inc.dropzone.removeAllFiles(!0),inc.uploadAttachmentDescription=null,inc.disableAttachmentButon=!0,inc.dropzone=null,inc.dzfile=null,$scope.$apply()},this.cancelIncident=function(){QRMDataService.incident=null,QRMDataService.incidentID=-1,$state.go("qrm.incidentExpl")},this.updateIncident=function(){QRM.mainController.titleBar=inc.incident.incidentCode,QRM.mainController.titleBarSM=inc.incident.incidentCode,null!=inc.incident.risks&&inc.incident.risks.sort(SortByProjectCode)},this.openDescriptionEditor=function(){var oTitle=inc.incident.title,oDescription=inc.incident.description;ngDialog.openConfirm({template:"editIncidentTitleModalDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){},function(reason){inc.incident.title=oTitle,inc.incident.description=oDescription})},this.openActionsEditor=function(){var oActions=inc.incident.actions;ngDialog.openConfirm({template:"editActionsModalDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){},function(reason){inc.incident.actions=oActions})},this.openLessonsEditor=function(){var oLessons=inc.incident.lessons;ngDialog.openConfirm({template:"editLessonsModalDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){},function(reason){inc.incident.lessons=oLessons})},this.addComment=function(){$scope.data.comment="",ngDialog.openConfirm({template:"addIncidentCommentModalDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){remoteService.addGeneralComment($scope.data.comment,QRMDataService.incidentID).then(function(response){return response.data.error?void alert(response.data.msg):(ngNotify.dismiss(),ngNotify.set("Comment Added To Incident",{type:"success",duration:1e3,theme:"pure"}),void(inc.incident.comments=response.data))})},function(reason){})},this.addCommentSM=function(){remoteService.addGeneralComment($scope.data.comment,QRMDataService.incidentID).then(function(response){return response.data.error?void alert(response.data.msg):(ngNotify.dismiss(),ngNotify.set("Comment Added To Incident",{type:"success",duration:1e3,theme:"pure"}),inc.incident.comments=response.data,void($scope.data.comment=""))})},this.saveIncident=function(){$scope.savingincident=!0,null!=inc.incident.risks&&inc.incident.risks.sort(SortByProjectCode),remoteService.saveIncident(inc.incident).then(function(response){return response.data.error?($scope.savingincident=!1,void alert(response.data.msg)):($scope.savingincident=!1,ngNotify.dismiss(),ngNotify.set("Incident Saved",{type:"success",duration:1e3,theme:"pure"}),inc.incident=response.data,void inc.updateIncident())})},-1==QRMDataService.incidentID?inc.incident={title:"Incident Title",description:"Description of the incident",id:-1,incidentCode:"New Incident",resolved:!1,identified:!1,evaluated:!1,controls:!1,consequences:!1,causes:!1,reportedby:0,lessons:"Enter the lessons learnt as a result of this incident",actions:"Enter a summary of actions taken to resolve the incident",date:new Date}:inc.incident=QRMDataService.incident,$scope.getMyCtrlScope=function(){return $scope},$scope.incidentReport=function(reportID){$scope.reportReqID<0||(QRM.mainController.notify("Assembling Data for Report",5e3),remoteService.getReportIncidentJSON([inc.incident.id],$scope.reportReqID).then(function(response){"OK"==response.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(response.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(QRMDataService.userEmail),jQuery('input[name="reportID"]').val(2),jQuery("#reportForm").attr("action",response.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}))},this.updateIncident()}function ReviewExplCtrl($scope,QRMDataService,$state,remoteService){QRM.mainController.titleBarSM="QRM Review Explorer",QRM.mainController.titleBarSM="QRM Review Explorer";var review=this;this.loading=!1,$scope.formatTreatedCol=function(row,check){return row.entity.complete&&check?!0:row.entity.complete||check?!1:!0},this.getTableHeight=function(){return{height:"calc(100vh - 100px)"}},this.getTableHeightSM=function(){return{height:"calc(100vh - 105px)"}},this.gridOptions={enableSorting:!0,rowTemplate:'<div ng-click="grid.appScope.editReview(row.entity.id)" style="cursor:pointer" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',columnDefs:[{width:"150",cellClass:"compact",field:"reviewCode",headerCellClass:"header-hidden"},{name:"title",width:"*",cellClass:"compact",field:"title"},{name:"Scheduled Date",width:140,field:"scheddate",cellFilter:"date"},{name:"Actual Date",width:140,field:"actualdate",cellFilter:"date"},{name:"Complete",width:70,field:"complete",cellTemplate:'<i style="color:green" ng-show="grid.appScope.formatTreatedCol(row, true)" class="fa fa-check"></i><i  style="color:red" ng-show="grid.appScope.formatTreatedCol(row, false)" class="fa fa-close"></i>',cellClass:"cellCentered"},{name:"Responsible",width:140,field:"responsible",cellFilter:"usernameFilter"}]},this.gridOptionsSM={enableSorting:!0,rowTemplate:'<div ng-click="grid.appScope.editReview(row.entity.id)" style="cursor:pointer" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }"  ui-grid-cell></div>',columnDefs:[{width:"100",cellClass:"compact",field:"reviewCode",headerCellClass:"header-hidden"},{name:"title",width:"*",cellClass:"compact",field:"title"},{name:"Scheduled Date",width:90,field:"scheddate",cellFilter:"date"}]},$scope.editReview=function(id){review.editReview(id)},this.editReview=function(id){review.loading=!0,remoteService.getReview(id).then(function(response){QRMDataService.review=response.data,null!=QRMDataService.review.risks&&QRMDataService.review.risks.sort(SortByProjectCode),QRMDataService.reviewID=QRMDataService.review.id,QRMDataService.review.actualdate=new Date(QRMDataService.review.actualdate),QRMDataService.review.scheddate=new Date(QRMDataService.review.scheddate),review.loading=!1,$state.go("qrm.review")})},this.newReview=function(){QRMDataService.reviewID=-1,$state.go("qrm.review")},this.init=function(){var winWidth=jQuery(window).innerWidth()-10;jQuery("#container").css("width",winWidth+"px"),QRM.mainController.titleBar="Reviews",QRM.mainController.lookingForReviews(),remoteService.getAllReviews().then(function(response){review.gridOptions.data=response.data,review.gridOptionsSM.data=response.data,review.gridOptions.data.length>0?QRM.mainController.reviewsFound():QRM.mainController.noReviewsFound()})["finally"](function(){review.loading=!1})},$scope.getMyCtrlScope=function(){return $scope},$scope.reviewReport=function(reportID){$scope.reportReqID<0||(QRM.mainController.notify("Assembling Data for Report",5e3),remoteService.getReportReviewJSON([],$scope.reportReqID).then(function(response){"OK"==response.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(response.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(QRMDataService.userEmail),jQuery('input[name="reportID"]').val(2),jQuery("#reportForm").attr("action",response.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}))},this.init()}function ReviewCtrl($scope,QRMDataService,$state,remoteService,ngNotify,ngDialog){var rev=this;this.siteUsers=[],this.sortedParents=QRMDataService.sortedParents,null==this.sortedParents&&remoteService.getProjects().then(function(response){QRMDataService.handleGetProjects(response),rev.sortedParents=QRMDataService.sortedParents}),$scope.data={},$scope.savingreview=!1,QRMDataService.siteUsers.forEach(function(e){rev.siteUsers.push(e.ID)}),$scope.dropzoneConfig={options:{url:ajaxurl+"?action=uploadFile",previewTemplate:document.querySelector("#preview-template").innerHTML,parallelUploads:1,thumbnailHeight:120,thumbnailWidth:120,maxFilesize:10,filesizeBase:1e3,autoProcessQueue:!1,thumbnail:function(file,dataUrl){if(file.previewElement){file.previewElement.classList.remove("dz-file-preview");for(var images=file.previewElement.querySelectorAll("[data-dz-thumbnail]"),i=0;i<images.length;i++){var thumbnailElement=images[i];thumbnailElement.alt=file.name,thumbnailElement.src=dataUrl}setTimeout(function(){file.previewElement.classList.add("dz-image-preview")},1)}},init:function(){this.on("addedfile",function(file){rev.reviewAttachmentReady(this,file)}),this.on("complete",function(file){file.previewElement.classList.add("dz-complete"),rev.cancelAttachment(),ngNotify.set("Attachment Added To Review",{type:"success",duration:1e3,theme:"pure"}),remoteService.getAttachments(rev.review.id).then(function(response){rev.review.attachments=response.data})}),this.on("error",function(file,message,xhr){file.previewElement.classList.add("dz-complete"),rev.cancelAttachment(),ngNotify.set(message,{type:"error",duration:1e3,theme:"pure"})})},sending:function(file,xhr,formData){formData.append("postID",QRMDataService.reviewID),formData.append("description",rev.uploadAttachmentDescription)}}},this.rowStyle=function(e){return{"margin-left":20*e.$$treeLevel+"px"}},this.addRisk=function(){if("undefined"==typeof rev.review.risks&&(rev.review.risks=[]),null!=rev.risk.id){rev.review.risks.push(rev.risk.id);var unq=[];jQuery.each(rev.review.risks,function(i,el){-1==jQuery.inArray(el,unq)&&null!=el&&unq.push(el)}),rev.review.risks=unq,rev.review.risks.sort(SortByProjectCode)}rev.risk=null},this.addProjectRisk=function(){if("undefined"==typeof rev.review.risks&&(rev.review.risks=[]),null!=rev.projectID){QRMDataService.risks.forEach(function(r){r.projectID==rev.projectID&&rev.review.risks.push(r.id)});var unq=[];jQuery.each(rev.review.risks,function(i,el){-1===jQuery.inArray(el,unq)&&unq.push(el)}),rev.review.risks=unq,rev.review.risks.sort(SortByProjectCode)}rev.projectID=null},this.removeRisk=function(riskID){rev.review.risks=jQuery.grep(rev.review.risks,function(value){return value!=riskID}),rev.review.riskComments=jQuery.grep(rev.review.riskComments,function(value){return value.riskID!=riskID})},this.reviewAttachmentReady=function(dropzone,file){rev.dropzone=dropzone,rev.dzfile=file,rev.disableAttachmentButon=!1,$scope.$apply()},this.uploadAttachmentDescription="",this.disableAttachmentButon=!0,this.dropzone="",this.uploadAttachment=function(){ngNotify.set("File Is Being Uploaded and Imported. Please Standby",{type:"info",sticky:!0,theme:"pure"}),rev.dropzone.processFile(rev.dzfile)},this.cancelAttachment=function(){rev.dropzone.removeAllFiles(!0),rev.uploadAttachmentDescription=null,rev.disableAttachmentButon=!0,rev.dropzone=null,rev.dzfile=null,$scope.$apply()},this.cancelReview=function(){QRMDataService.review=null,QRMDataService.reviewID=-1,$state.go("qrm.reviewExpl")},this.updateReview=function(){QRM.mainController.titleBar=rev.review.reviewCode,QRM.mainController.titleBarSM=rev.review.reviewCode,null!=rev.review.risks&&rev.review.risks.sort(SortByProjectCode)},this.openDescriptionEditor=function(){var oTitle=rev.review.title,oDescription=rev.review.description;ngDialog.openConfirm({template:"editReviewTitleModalDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){},function(reason){rev.review.title=oTitle,rev.review.description=oDescription})},this.openNotesEditor=function(){var oNotes=rev.review.notes;ngDialog.openConfirm({template:"editReviewNotesModalDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){},function(reason){rev.review.notes=oNotes})},this.addComment=function(){$scope.data.comment="",ngDialog.openConfirm({template:"addReviewCommentModalDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){remoteService.addGeneralComment($scope.data.comment,QRMDataService.reviewID).then(function(response){ngNotify.dismiss(),ngNotify.set("Comment Added TO Review",{type:"success",duration:1e3,theme:"pure"}),rev.review.comments=response.data})},function(reason){})},this.addCommentSM=function(){remoteService.addGeneralComment($scope.data.comment,QRMDataService.incidentID).then(function(response){return response.data.error?void alert(response.data.msg):(ngNotify.dismiss(),ngNotify.set("Comment Added To Review",{type:"success",duration:1e3,theme:"pure"}),rev.review.comments=response.data,void($scope.data.comment=""))})},this.addCommonRiskComment=function(){null==rev.review.riskComments&&(rev.review.riskComments=[]),rev.review.risks.forEach(function(riskID){var riskComment=jQuery.grep(rev.review.riskComments,function(e){return e.riskID==riskID});if(riskComment.length>0)riskComment[0].comment=riskComment[0].comment+"<p>"+rev.commonComment+"</p>";else{var newRiskComment={riskID:risk.id,comment:"<p>"+rev.commonComment+"</p>"};rev.review.riskComments.push(newRiskComment)}}),rev.commomComment=null},this.getRiskComment=function(riskID){if(null!=rev.review.riskComments){var riskComment=jQuery.grep(rev.review.riskComments,function(e){return e.riskID==riskID});if(null!=riskComment)return riskComment.length>0?riskComment[0].comment:void 0}},this.riskComment=function(riskID){null==rev.review.riskComments&&(rev.review.riskComments=[]);var riskComment=jQuery.grep(rev.review.riskComments,function(e){return e.riskID==riskID});riskComment.length>0?this.rc=riskComment[0]:(this.rc={riskID:riskID,comment:""},rev.review.riskComments.push(this.rc));var oComment=this.rc.comment;rev.riskForComment=riskID,ngDialog.openConfirm({template:"editReviewRiskCommentDialogId",className:"ngdialog-theme-default",scope:$scope}).then(function(value){console.log(JSON.stringify(rev.review))},function(reason){this.rc.comment=oComment})},$scope.getMyCtrlScope=function(){return $scope},$scope.reviewReport=function(reportID){$scope.reportReqID<0||(QRM.mainController.notify("Assembling Data for Report",5e3),remoteService.getReportReviewJSON([rev.review.id],$scope.reportReqID).then(function(response){"OK"==response.data?QRM.mainController.notify("Data sent to server",5e3):(QRM.mainController.notify("Sending Data for Processing",5e3),jQuery('input[name="reportData"]').val(JSON.stringify(response.data)),jQuery('input[name="action"]').val("execute_report"),jQuery('input[name="reportEmail"]').val(QRMDataService.userEmail),jQuery('input[name="reportID"]').val(2),jQuery("#reportForm").attr("action",response.data.reportServerURL+"/report"),jQuery("#reportForm").submit())}))},this.saveReview=function(){$scope.savingreview=!0,null!=rev.review.risks&&rev.review.risks.sort(SortByProjectCode),remoteService.saveReview(rev.review).then(function(response){return response.data.error?($scope.savingreview=!1,void alert(response.data.msg)):($scope.savingreview=!1,ngNotify.dismiss(),ngNotify.set("Review Saved",{type:"success",duration:1e3,theme:"pure"}),rev.review=response.data,void rev.updateReview())})},-1==QRMDataService.reviewID?rev.review={title:"Review Title",description:"Purpose of the Review",scheddate:new Date,actualdate:new Date,id:-1,reviewCode:"REVIEW-??",responsible:0,notes:"Enter any general notes about the review"}:rev.review=QRMDataService.review,this.updateReview()}function LoginCtrl($state,remoteService){var login=this;this.showError=!1,this.username="",this.pass="",this.login=function(){login.showError=!1,remoteService.login(login.username,login.pass).then(function(response){var result=response.data;result.loggedin?result.qrmuser?(login.showError=!1,login.username="",login.pass="",QRM.mainController.init(!0)):$state.go("nonQRM"):(login.showError=!0,login.username="",login.pass="")})},this.lostPassword=function(){window.open(lostPasswordURL,"_self")}}QRM={},d3.gantt=function(calController){function gantt(tasks,svgdiv,w,h){height=h-margin.top-margin.bottom-5,width=w-margin.right-margin.left-5,initTimeDomain(tasks),initAxis();var svg=d3.select(svgdiv).append("svg").attr("class","chart").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("class","gantt-chart").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).attr("transform","translate("+margin.left+", "+margin.top+")");return svg.selectAll(".chart").data(tasks,keyFunction).enter().append("rect").attr("rx",5).attr("ry",5).attr("class",function(d){return d.className}).attr("y",0).attr("transform",rectTransform).attr("height",function(d){return y.rangeBand()}).attr("width",function(d){return x(d.endDate)-x(d.startDate)}).on("mouseover",function(d){try{calController.toolTip(d)}catch(e){alert(e.message)}}).on("mouseout",function(){try{calController.toolTip(!1)}catch(e){alert(e.message)}}).on("click",function(d){calController.editRisk(d.riskID)}),svg.append("g").attr("class","x axis").attr("transform","translate(0, "+(height-margin.top-margin.bottom)+")").transition().call(xAxis).selectAll("text").style("text-anchor","end").style("fill","rgb(103,106,108)").attr("dx","-.8em").attr("dy",".15em").attr("transform",function(d){return"rotate(-45)"}),svg.append("text").attr("text-anchor","middle").attr("class","calHeadText").style("fill","rgb(103,106,108)").attr("transform","translate("+[width/2,0]+")").text(calController.project.title),svg.append("g").attr("class","y axis").transition().call(yAxis).selectAll("text").style("fill","rgb(103,106,108)"),gantt}var FIT_TIME_DOMAIN_MODE="fit",margin={top:30,right:10,bottom:20,left:80};jQuery(window).width()<768&&(margin={top:30,right:10,bottom:20,left:50});var timeDomainStart=d3.time.day.offset(new Date,-3),timeDomainEnd=d3.time.hour.offset(new Date,3),timeDomainMode=FIT_TIME_DOMAIN_MODE,taskTypes=[],taskStatus=[],height=null,width=null,tickFormat="%b %Y",keyFunction=function(d){return d.startDate+d.taskName+d.endDate},rectTransform=function(d){return"translate("+x(d.startDate)+","+y(d.taskName)+")"},x=d3.time.scale().domain([timeDomainStart,timeDomainEnd]).range([0,width]).clamp(!0),y=d3.scale.ordinal().domain(taskTypes).rangeRoundBands([0,height-margin.top-margin.bottom],.1),xAxis=d3.svg.axis().scale(x).orient("bottom").tickFormat(d3.time.format(tickFormat)).tickSubdivide(!0).tickSize(8).tickPadding(8),yAxis=d3.svg.axis().scale(y).orient("left").tickSize(0),initTimeDomain=function(tasks){if(timeDomainMode===FIT_TIME_DOMAIN_MODE){if(void 0===tasks||tasks.length<1)return timeDomainStart=d3.time.day.offset(new Date,-3),void(timeDomainEnd=d3.time.hour.offset(new Date,3));tasks.sort(function(a,b){return a.endDate-b.endDate}),timeDomainEnd=tasks[tasks.length-1].endDate,tasks.sort(function(a,b){return a.startDate-b.startDate}),timeDomainStart=tasks[0].startDate}},initAxis=function(){x=d3.time.scale().domain([timeDomainStart,timeDomainEnd]).range([0,width]).clamp(!0),y=d3.scale.ordinal().domain(taskTypes).rangeRoundBands([0,height-margin.top-margin.bottom],.1),xAxis=d3.svg.axis().scale(x).orient("bottom").tickFormat(d3.time.format(tickFormat)).tickSubdivide(!0).tickSize(8).tickPadding(8),yAxis=d3.svg.axis().scale(y).orient("left").tickSize(0)};return gantt.redraw=function(tasks){initTimeDomain(tasks),initAxis();var svg=d3.select("svg"),ganttChartGroup=svg.select(".gantt-chart"),rect=ganttChartGroup.selectAll("rect").data(tasks,keyFunction);return rect.enter().insert("rect",":first-child").attr("rx",5).attr("ry",5).attr("class","bar").transition().attr("y",0).attr("transform",rectTransform).attr("height",function(d){return y.rangeBand()}).attr("width",function(d){return x(d.endDate)-x(d.startDate)}),rect.transition().attr("transform",rectTransform).attr("height",function(d){return y.rangeBand()}).attr("width",function(d){return x(d.endDate)-x(d.startDate)}),rect.exit().remove(),svg.select(".x").transition().call(xAxis),svg.select(".y").transition().call(yAxis),gantt},gantt.margin=function(value){return arguments.length?(margin=value,gantt):margin},gantt.timeDomain=function(value){return arguments.length?(timeDomainStart=+value[0],timeDomainEnd=+value[1],gantt):[timeDomainStart,timeDomainEnd]},gantt.timeDomainMode=function(value){return arguments.length?(timeDomainMode=value,gantt):timeDomainMode},gantt.taskTypes=function(value){return arguments.length?(taskTypes=value,gantt):taskTypes},gantt.taskStatus=function(value){return arguments.length?(taskStatus=value,gantt):taskStatus},gantt.width=function(value){return arguments.length?(width=+value,gantt):width},gantt.height=function(value){return arguments.length?(height=+value,gantt):height},gantt.tickFormat=function(value){return arguments.length?(tickFormat=value,gantt):tickFormat},gantt},tooltipProb=d3.select("body").append("div").style("position","absolute").style("background-color","rgba(255, 255, 255, 0.5)").style("z-index","10").style("padding","10").style("border-style","solid").style("border-radius","5px").style("border-width","1px").style("border-color","black").style("font-size","18px").style("font-weight","normal").style("visibility","hidden").text("a simple tooltip"),function(){angular.module("qrm",["ui.router","oc.lazyLoad","ui.bootstrap","ui.bootstrap.datepicker","ngIdle","ui.grid","ui.grid.autoResize","ui.grid.moveColumns","cgNotify","ngNotify","ui.select","ngSanitize","ngDialog","textAngular","angular-loading-bar","ngAnimate"])}(),angular.module("qrm").config(["$stateProvider","IdleProvider",config]).run(function($rootScope,$state){$rootScope.$state=$state,$state.go("intro")}),angular.module("qrm").directive("pageTitle",["$rootScope","$timeout",pageTitle]).directive("riskmat",["QRMDataService",riskmat]).directive("icheck",["$timeout",icheck]).directive("dropzone",dropzone).directive("textAngular",["$parse","$timeout","textAngularManager",textAngularFocus]);var failedConnectCount=0,app=angular.module("qrm");!function(){app.config(["$locationProvider",function($locationProvider){$locationProvider.html5Mode({requireBase:!1,enabled:!0})}]),app.config(["ngDialogProvider",function(ngDialogProvider){ngDialogProvider.setDefaults({className:"ngdialog-theme-default",plain:!1,showClose:!1,closeByDocument:!1,closeByEscape:!1,appendTo:!1})}]),app.config(["cfpLoadingBarProvider",function(cfpLoadingBarProvider){cfpLoadingBarProvider.includeSpinner=!1}]),app.config(["$provide",function($provide){$provide.decorator("taOptions",["taRegisterTool","$delegate",function(taRegisterTool,taOptions){return taOptions.toolbar=[["h1","h2","p"],["bold","italics","underline","strikeThrough","ul","ol","redo"],["justifyRight","indent","outdent"]],taOptions}])}]),app.controller("IntroCtrl",["$scope","QRMDataService","RemoteService","$state","$q","$http",IntroCtrl]),app.controller("QRMCtrl",["QRMDataService",QRMCtrl]),app.controller("NonQRMCtrl",function(){}),app.controller("MainCtrl",["QRMDataService","RemoteService","$state","ngNotify","$http","$q",MainCtrl]),app.controller("ExplorerCtrl",["$scope","QRMDataService","$state","RemoteService","ngDialog","$timeout","$http","uiGridConstants",ExplorerCtrl]),app.controller("RiskCtrl",["$scope","QRMDataService","$state","$timeout","RemoteService","ngNotify","ngDialog","$q",RiskCtrl]),app.controller("CalenderController",["$scope","QRMDataService","$state","RemoteService",CalenderController]),app.controller("RankController",["$scope","QRMDataService","$state","RemoteService","ngNotify",RankController]),app.controller("ReportArchiveController",["$scope","QRMDataService","RemoteService","ngNotify","$http","$state","uiGridConstants",ReportArchiveController]),app.controller("AnalysisController",["$scope","QRMDataService","RemoteService",AnalysisController]),app.controller("RelMatrixController",["$scope","QRMDataService","RemoteService","ngNotify",RelMatrixController]),app.controller("IncidentExplCtrl",["$scope","QRMDataService","$state","RemoteService",IncidentExplCtrl]),app.controller("IncidentCtrl",["$scope","QRMDataService","$state","RemoteService","ngNotify","ngDialog",IncidentCtrl]),app.controller("ReviewExplCtrl",["$scope","QRMDataService","$state","RemoteService",ReviewExplCtrl]),app.controller("ReviewCtrl",["$scope","QRMDataService","$state","RemoteService","ngNotify","ngDialog",ReviewCtrl]),app.controller("LoginCtrl",["$state","RemoteService",LoginCtrl]),app.service("RemoteService",["$http",RemoteService]),app.service("QRMDataService",DataService),app.filter("currencyFilter",function(){return function(value){return"$"+Number(value).toFixed(2).replace(/\d(?=(\d{3})+\.)/g,"$&,")}}),app.filter("percentFilter",function(){return function(value){return Number(value).toFixed(1).replace(/\d(?=(\d{3})+\.)/g,"$&,")+"%"}}),app.filter("nullFilter",function(){return function(value){return"undefined"==typeof value||null==value?"-":value}}),app.filter("usernameFilter",["QRMDataService","RemoteService","$q",function(QRMDataService,remoteService,$q){return function(input){if("object"==typeof input&&(input=input.ID),0>input)return"Not Assigned";if("undefined"!=typeof input){var user=jQuery.grep(QRMDataService.siteUsers,function(e){return e.ID==input});return"undefined"==typeof user?"Unknown":0==user.length?"Not Found":user.length>1?"Unknown (too many)":user[0].data.display_name}}}]),app.filter("compoundRiskFilter",["QRMDataService",function(QRMDataService){return function(input){if("object"==typeof input)return input.riskProjectCode+" - "+input.title;var risk=jQuery.grep(QRMDataService.risks,function(e){return e.id==input});return risk[0].riskProjectCode+" - "+risk[0].title}}]),app.filter("riskCodeFilter",["QRMDataService","RemoteService","$q",function(QRMDataService,remoteService,$q){return function(input){if("object"==typeof input)return input.riskProjectCode;var risk=jQuery.grep(QRMDataService.risks,function(e){return e.id==input});return risk[0].riskProjectCode}}]),app.filter("riskTitleFilter",["QRMDataService",function(QRMDataService){return function(input){if("object"==typeof input)return input.title;var risk=jQuery.grep(QRMDataService.risks,function(e){return e.id==input});return risk[0].title}}])}();