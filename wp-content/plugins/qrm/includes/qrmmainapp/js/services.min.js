function DataService(){var ds=this;this.matrixDisplayConfig={width:200,height:200,radius:15},this.selectProject=function(projectID){this.projectObjectives=objectiveSort(getLinearObjectives(this.projMap,projectID)),this.catData=getFamilyCats(this.projMap,projectID),this.project=this.projMap.get(projectID)},this.handleGetProjects=function(response){this.projectsLinear=[],this.sortedParents=[],this.projMap=new Map,0!=response.data.length&&(this.projectsLinear=response.data,this.sortedParents=parentSort(response.data),this.projMap=new Map,this.projectsLinear.forEach(function(e){ds.projMap.put(e.id,e)}))},this.project={id:-1,matrix:{maxProb:5,maxImpact:5,tolString:"1123312234223443345534455"}},this.getTemplateRisk=function(){return{title:"Title of Risk",riskProjectCode:" New Risk ",description:"Description",cause:"Cause",consequence:"Consequence",owner:-1,manager:-1,inherentProb:5.5,inherentImpact:5.5,treatedProb:1.5,treatedImpact:1.5,impRep:!0,impSafety:!0,impEnviron:!0,impCost:!0,impTime:!0,impSpec:!0,treatAvoid:!0,treatRetention:!0,treatTransfer:!0,treatMinimise:!0,treated:!1,summaryRisk:!1,useCalContingency:!1,useCalProb:!1,likeType:4,likeAlpha:1,likeT:365,likePostType:4,likePostAlpha:1,likePostT:365,estContingency:0,start:moment(),end:moment().add(1,"month"),primcat:0,seccat:0,mitigation:{mitPlanSummary:"Summary of the Mitigation Plan",mitPlanSummaryUpdate:"Update to the Summary of the Mitigation Plan",mitPlan:[]},response:{respPlanSummary:"Summary of the Response Plan",respPlanSummaryUpdate:"Update to the Summary of the Mitigation Plan",respPlan:[]},controls:[],objectives:{}}},this.analyseRisks=function(){var map=this.getAnalysisMap(),userMap=new Map;this.siteUsers.forEach(function(u){userMap.put(u.data.ID,{id:u.data.ID,ownCount:0,manCount:0})}),userMap.put("",{id:"",ownCount:0,manCount:0});var now=moment();this.projectRisks.forEach(function(r){var tol=r.currentTolerance,own=jQuery.grep(map.get("RiskOwner").get(tol).values,function(o){return Number(o.id)==Number(r.owner)});own[0].value=own[0].value+1,userMap.get(r.owner).ownCount++;var man=jQuery.grep(map.get("RiskManager").get(tol).values,function(o){return Number(o.id)==Number(r.manager)});man[0].value=man[0].value+1,userMap.get(r.manager).manCount++;var cat=jQuery.grep(map.get("Categories").get(tol).values,function(o){var c="undefined"==typeof r.primcat.title?"Unassigned":r.primcat.title;return o.label==c});0==cat.length?map.get("Categories").get(tol).values.push({label:r.primcat.title,value:1}):cat[0].value=cat[0].value+1;var endDiff=now.diff(moment(r.end)),startDiff=now.diff(moment(r.start)),status=0;endDiff>0&&(status=-1),0>startDiff&&(status=1),startDiff>0&&0>endDiff&&(status=0);var status=jQuery.grep(map.get("Status").get(tol).values,function(o){return Number(o.state)==Number(status)});status[0].value=status[0].value+1}),this.categories=map.get("Categories").valArray;var countArray=userMap.valArray;countArray.sort(function(a,b){return Number(b.ownCount)-Number(a.ownCount)});for(var i=5;i>0;i--){var sortOwn=new Array,arr=map.get("RiskOwner").get(i).values;countArray.forEach(function(a){var item=jQuery.grep(arr,function(b){return Number(b.id)==Number(a.id)});item.length>0&&(sortOwn.push(item[0]),map.get("RiskOwner").get(i).values=sortOwn)})}this.owners=map.get("RiskOwner").valArray,countArray.sort(function(a,b){return Number(b.manCount)-Number(a.manCount)});for(var i=5;i>0;i--){var manOwn=new Array,arr=map.get("RiskManager").get(i).values;countArray.forEach(function(a){var item=jQuery.grep(arr,function(b){return Number(b.id)==Number(a.id)});item.length>0&&(manOwn.push(item[0]),map.get("RiskManager").get(i).values=manOwn)})}this.managers=map.get("RiskManager").valArray,this.status=map.get("Status").valArray},this.getAnalysisMap=function(){var map=new Map;map.put("RiskOwner",new Map);var ownMap=map.get("RiskOwner");ownMap.put(5,{key:"Extreme",color:"#ed5565",values:new Array}),ownMap.put(4,{key:"High",color:"#f8ac59",values:new Array}),ownMap.put(3,{key:"Significant",color:"#ffff55",values:new Array}),ownMap.put(2,{key:"Moderate",color:"#1ab394",values:new Array}),ownMap.put(1,{key:"Low",color:"#1c84c6",values:new Array}),map.put("RiskManager",new Map);var manMap=map.get("RiskManager");manMap.put(5,{key:"Extreme",color:"#ed5565",values:new Array}),manMap.put(4,{key:"High",color:"#f8ac59",values:new Array}),manMap.put(3,{key:"Significant",color:"#ffff55",values:new Array}),manMap.put(2,{key:"Moderate",color:"#1ab394",values:new Array}),manMap.put(1,{key:"Low",color:"#1c84c6",values:new Array}),this.siteUsers.forEach(function(u){for(var i=5;i>0;i--)(jQuery.inArray(u.ID,ds.project.ownersID)>-1||u.ID==ds.project.projectRiskManager)&&ownMap.get(i).values.push({label:u.data.display_name,value:0,id:u.data.ID}),(jQuery.inArray(u.ID,ds.project.managersID)>-1||u.ID==ds.project.projectRiskManager)&&manMap.get(i).values.push({label:u.data.display_name,value:0,id:u.data.ID})}),map.put("Categories",new Map);var catMap=map.get("Categories");catMap.put(5,{key:"Extreme",color:"#ed5565",values:new Array}),catMap.put(4,{key:"High",color:"#f8ac59",values:new Array}),catMap.put(3,{key:"Significant",color:"#ffff55",values:new Array}),catMap.put(2,{key:"Moderate",color:"#1ab394",values:new Array}),catMap.put(1,{key:"Low",color:"#1c84c6",values:new Array}),this.catData.forEach(function(c){if(c.primCat)for(var i=5;i>0;i--)catMap.get(i).values.push({label:c.title,value:0})}),map.put("Status",new Map);var sMap=map.get("Status");sMap.put(5,{key:"Extreme",color:"#ed5565",values:new Array}),sMap.put(4,{key:"High",color:"#f8ac59",values:new Array}),sMap.put(3,{key:"Significant",color:"#ffff55",values:new Array}),sMap.put(2,{key:"Moderate",color:"#1ab394",values:new Array}),sMap.put(1,{key:"Low",color:"#1c84c6",values:new Array});for(var i=5;i>0;i--)sMap.get(i).values.push({label:"Inactive",value:0,state:-1}),sMap.get(i).values.push({label:"Active",value:0,state:0}),sMap.get(i).values.push({label:"Pending",value:0,state:1});for(var i=5;i>0;i--)ownMap.get(i).values.push({label:"Unassigned",value:0,id:""}),manMap.get(i).values.push({label:"Unassigned",value:0,id:""}),catMap.get(i).values.push({label:"Unassigned",value:0});return map},this.getDefaultProject=function(){return{id:-1,title:"Project Title",description:"Description of the Project",useAdvancedConsequences:!1,projectCode:"",ownersID:[],managersID:[],usersID:[],matrix:{maxImpact:5,maxProb:5,tolString:"1123312234223443345534455555555555555555555555555555555555555555",probVal1:20,probVal2:40,probVal3:60,probVal4:80,probVal5:100,probVal6:100,probVal7:100,probVal8:100},inheritParentCategories:!0,inheritParentObjectives:!0,categories:[],objectives:[],parent_id:0}}}function RemoteService($http){this.getRisk=function(riskID){return $http({method:"POST",url:ajaxurl,params:{action:"getRisk"},cache:!1,data:riskID})},this.getServerMeta=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getServerMeta"},cache:!1})},this.prepareAnalytics=function(data){return $http({method:"POST",url:ajaxurl,params:{action:"prepareAnalytics"},cache:!1,data:data})},this.saveRisk=function(risk){return $http({method:"POST",url:ajaxurl,params:{action:"saveRisk"},cache:!1,data:risk})},this.getAllRisks=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getAllRisks"},cache:!1})},this.registerAudit=function(auditType,auditComment,riskID){return $http({method:"POST",url:ajaxurl,params:{action:"registerAudit"},cache:!1,data:{auditType:auditType,auditComment:auditComment,riskID:riskID}})},this.getAllProjectRisks=function(projectID,childProjects){return $http({method:"POST",url:ajaxurl,params:{action:"getAllProjectRisks"},cache:!1,data:{projectID:projectID,childProjects:childProjects}}).error(function(data,status,headers,config){alert(data.msg)})},this.getSiteUsersCap=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getSiteUsersCap"},cache:!1})},this.getSiteUsers=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getSiteUsers"},cache:!1})},this.getProjects=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getProjects"},cache:!1})},this.saveProject=function(data){return $http({method:"POST",url:ajaxurl,params:{action:"saveProject"},data:data,cache:!1})},this.updateRisksRelMatrix=function(data){return $http({method:"POST",url:ajaxurl,params:{action:"updateRisksRelMatrix"},cache:!1,data:JSON.stringify(data)}).error(function(data,status,headers,config){alert(data.msg)})},this.saveRankOrder=function(data){return $http({method:"POST",url:ajaxurl,params:{action:"saveRankOrder"},cache:!1,data:JSON.stringify(data)}).error(function(data,status,headers,config){alert(data.msg)})},this.getAttachments=function(postID){return $http({method:"POST",url:ajaxurl,params:{action:"getAttachments"},cache:!1,data:postID})},this.getCurrentUser=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getCurrentUser"},cache:!1})},this.getAllIncidents=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getAllIncidents"},cache:!1})},this.getIncident=function(incidentID){return $http({method:"POST",url:ajaxurl,params:{action:"getIncident"},cache:!1,data:JSON.stringify(incidentID)})},this.getReview=function(reviewID){return $http({method:"POST",url:ajaxurl,params:{action:"getReview"},cache:!1,data:JSON.stringify(reviewID)})},this.saveIncident=function(incident){return $http({method:"POST",url:ajaxurl,params:{action:"saveIncident"},cache:!1,data:JSON.stringify(incident)})},this.getAllReviews=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getAllReviews"},cache:!1})},this.getIncident=function(incidentID){return $http({method:"POST",url:ajaxurl,params:{action:"getIncident"},cache:!1,data:JSON.stringify(incidentID)})},this.saveReview=function(review){return $http({method:"POST",url:ajaxurl,params:{action:"saveReview"},cache:!1,data:JSON.stringify(review)})},this.addGeneralComment=function(comment,postID){return data={comment:comment,ID:postID},$http({method:"POST",url:ajaxurl,params:{action:"addGeneralComment"},cache:!1,data:JSON.stringify(data)})},this.login=function(user,pass){return data={user:user,pass:pass},$http({method:"POST",url:ajaxurl,params:{action:"login"},cache:!1,data:JSON.stringify(data)})},this.logout=function(){return $http({method:"POST",url:ajaxurl,params:{action:"logout"},cache:!1})},this.checkSession=function(){return $http({method:"POST",url:ajaxurl,params:{action:"checkSession"},cache:!1})},this.getJSON=function(){return $http({method:"POST",url:ajaxurl,params:{action:"getJSON"},cache:!1})},this.getReportRiskJSON=function(risks,projectID,childProjects,basicsOnly,reportID){var data={risks:risks,projectID:projectID,childProjects:childProjects,basicsOnly:basicsOnly,reportID:reportID};return $http({method:"POST",url:ajaxurl,params:{action:"getReportRiskJSON"},data:JSON.stringify(data),cache:!1})},this.getReportIncidentJSON=function(incidents,reportID){var data={incidents:incidents,reportID:reportID};return $http({method:"POST",url:ajaxurl,params:{action:"getReportIncidentJSON"},data:JSON.stringify(data),cache:!1})},this.getReportReviewJSON=function(reviews,reportID){var data={reviews:reviews,reportID:reportID};return $http({method:"POST",url:ajaxurl,params:{action:"getReportReviewJSON"},data:JSON.stringify(data),cache:!1})},this.newPushDownRisk=function(pushdown){return $http({method:"POST",url:ajaxurl,params:{action:"newPushDown"},cache:!1,data:JSON.stringify(pushdown)})},this.createDummyRiskEntry=function(projectID){return $http({method:"POST",url:ajaxurl,params:{action:"createDummyRiskEntry"},cache:!1,data:JSON.stringify(projectID)})},this.createDummyRiskEntries=function(projectID){return $http({method:"POST",url:ajaxurl,params:{action:"createDummyRiskEntryMultiple"},cache:!1,data:JSON.stringify(projectID)})}}